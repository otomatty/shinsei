# Lichtblick æ ¹æœ¬çš„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ææ¡ˆ

## ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã‚ˆã‚‹ä½ã‚¹ãƒšãƒƒã‚¯PCå¯¾å¿œãƒ»ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆã‚¼ãƒ­å®Ÿè£…

**ä½œæˆæ—¥**: 2025å¹´10æœˆ14æ—¥
**å¯¾è±¡**: å¤§å®¹é‡MCAPãƒ•ã‚¡ã‚¤ãƒ«ã®åŠ¹ç‡çš„å†ç”Ÿï¼ˆä½ã‚¹ãƒšãƒƒã‚¯PCå¯¾å¿œã€ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆä¸è¦ï¼‰

---

## ğŸ¯ ç›®æ¨™

1. **ä½ã‚¹ãƒšãƒƒã‚¯PCå¯¾å¿œ**: ãƒ¡ãƒ¢ãƒª4GBä»¥ä¸‹ã®PCã§ã‚‚å¤§å®¹é‡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å†ç”Ÿå¯èƒ½
2. **ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆã‚¼ãƒ­**: Lambdaç­‰ã®è¿½åŠ ã‚¤ãƒ³ãƒ•ãƒ©ä¸è¦
3. **æ ¹æœ¬çš„è§£æ±º**: ä¸€æ™‚çš„ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´ã§ã¯ãªãã€ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¬ãƒ™ãƒ«ã®æ”¹å–„

---

## ğŸ’¡ æ ¸å¿ƒçš„ãªè§£æ±ºç­–: ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®æ´»ç”¨

### ç¾åœ¨ã®å•é¡Œã®æœ¬è³ª

ç¾åœ¨ã®å®Ÿè£…ã¯**ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰å‹**:

```
âŒ ç¾åœ¨ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã‚’ãƒ¡ãƒ¢ãƒªã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥     â”‚
â”‚ 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚º: 500MB-1GB          â”‚
â”‚ 3. è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ« â†’ ãƒ¡ãƒ¢ãƒªä¸è¶³            â”‚
â”‚ 4. ä½ã‚¹ãƒšãƒƒã‚¯PC â†’ èµ·å‹•ã™ã‚‰ã§ããªã„      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ææ¡ˆ: çœŸã®ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‹å®Ÿè£…

```
âœ… ææ¡ˆã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆ: ã‚¼ãƒ­ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. å¿…è¦ãªéƒ¨åˆ†ã ã‘ã‚’ã‚ªãƒ³ãƒ‡ãƒãƒ³ãƒ‰èª­ã¿è¾¼ã¿ â”‚
â”‚ 2. ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: å¸¸ã«ä¸€å®šï¼ˆ50-100MBï¼‰   â”‚
â”‚ 3. è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ« â†’ ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ä¸å¤‰      â”‚
â”‚ 4. ä½ã‚¹ãƒšãƒƒã‚¯PC â†’ å•é¡Œãªãå‹•ä½œ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ å®Ÿè£…æˆ¦ç•¥: æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®æ´»ç”¨

### Lichtblickã«ã¯æ—¢ã«ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°æ©Ÿèƒ½ãŒã‚ã‚‹!

**ç™ºè¦‹ã—ãŸæ—¢å­˜ã®å®Ÿè£…**:

1. **BufferedIterableSource** (`packages/suite-base/src/players/IterablePlayer/BufferedIterableSource.ts`)

   - ãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼ãƒ»ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒãƒ¼ãƒ¢ãƒ‡ãƒ«
   - å›ºå®šã‚µã‚¤ã‚ºã®ãƒãƒƒãƒ•ã‚¡ã§ãƒ¡ãƒ¢ãƒªåˆ¶å¾¡
   - æ—¢ã«å®Ÿè£…æ¸ˆã¿âœ…

2. **BlockLoader** (`packages/suite-base/src/players/IterablePlayer/BlockLoader.ts`)

   - ãƒ–ãƒ­ãƒƒã‚¯å˜ä½ã§ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç®¡ç†
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚ºã®å‹•çš„åˆ¶å¾¡
   - ä¸è¦ãªãƒˆãƒ”ãƒƒã‚¯ã®è‡ªå‹•å‰Šé™¤

3. **MessageIterator** (`packages/suite-base/src/players/IterablePlayer/WorkerIterableSource.ts`)
   - 17msã”ã¨ã®ãƒãƒƒãƒå‡¦ç†ï¼ˆ60fpså¯¾å¿œï¼‰
   - éåŒæœŸã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ãƒ‘ã‚¿ãƒ¼ãƒ³

### å•é¡Œ: ã“ã‚Œã‚‰ãŒè¤‡æ•°URLå†ç”Ÿã§æ©Ÿèƒ½ã—ã¦ã„ãªã„ç†ç”±

```typescript
// RemoteDataSourceFactory.tsx ã®ç¾åœ¨ã®å®Ÿè£…
const source = new WorkerSerializedIterableSource({
  initWorker,
  initArgs: { urls }, // â† è¤‡æ•°URLã‚’å˜ç´”ã«æ¸¡ã™ã ã‘
});

return new IterablePlayer({
  source,
  name: urls.join(),
  metricsCollector: args.metricsCollector,
  urlParams: { urls },
  sourceId: this.id,
  readAheadDuration: { sec: 10, nsec: 0 }, // â† å•é¡Œ: ã“ã‚Œã¯å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«æƒ³å®š
});
```

**æ ¹æœ¬åŸå› **:

- å„URLã«å¯¾ã—ã¦ç‹¬ç«‹ã—ãŸWorkerã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç”Ÿæˆã•ã‚Œã‚‹
- ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ = ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚º Ã— URLæ•°
- ä¾‹: 500MB Ã— 10ãƒ•ã‚¡ã‚¤ãƒ« = 5GBï¼ˆä½ã‚¹ãƒšãƒƒã‚¯PCã§ã¯ä¸å¯èƒ½ï¼‰

---

## ğŸš€ è§£æ±ºç­–: çµ±åˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚½ãƒ¼ã‚¹ã®å®Ÿè£…

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Next.jsã‚¢ãƒ—ãƒª â†’ Lichtblick (iframe)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ UnifiedStreamingSource (æ–°è¦å®Ÿè£…)                           â”‚
â”‚  â”œâ”€ å˜ä¸€ã®ãƒ¡ãƒ¢ãƒªãƒãƒƒãƒ•ã‚¡ (50-100MBå›ºå®š)                    â”‚
â”‚  â”œâ”€ è¤‡æ•°URLã‚’ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§ãƒãƒ¼ã‚¸                        â”‚
â”‚  â””â”€ å¿…è¦ãªéƒ¨åˆ†ã®ã¿Range Request                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ—¢å­˜ã®IterablePlayer (å¤‰æ›´ä¸è¦)                             â”‚
â”‚  â””â”€ BufferedIterableSource (æ—¢å­˜æ©Ÿèƒ½ã‚’æ´»ç”¨)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: ä¸€å®š (50-100MB)
ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆ: ã‚¼ãƒ­
```

---

## ğŸ’» å®Ÿè£…: UnifiedStreamingSource

### Step 1: æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹å®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/suite-base/src/players/IterablePlayer/UnifiedStreamingSource.ts`

```typescript
// SPDX-FileCopyrightText: Copyright (C) 2023-2025 Bayerische Motoren Werke Aktiengesellschaft (BMW AG)<lichtblick@bmwgroup.com>
// SPDX-License-Identifier: MPL-2.0

import { Immutable, Time, MessageEvent } from "@umi/suite";
import { compare } from "@umi/rostime";
import BrowserHttpReader from "@umi/suite-base/util/BrowserHttpReader";

import {
  ISerializedIterableSource,
  Initialization,
  MessageIteratorArgs,
  IteratorResult,
  GetBackfillMessagesArgs,
} from "./IIterableSource";

/**
 * UnifiedStreamingSource - è¤‡æ•°URLã‚’çµ±åˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å†ç”Ÿ
 *
 * ç‰¹å¾´:
 * - ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: å¸¸ã«ä¸€å®šï¼ˆ50-100MBï¼‰
 * - ä½ã‚¹ãƒšãƒƒã‚¯PCå¯¾å¿œ: ãƒ¡ãƒ¢ãƒª4GBä»¥ä¸‹ã§ã‚‚å‹•ä½œ
 * - ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆ: ã‚¼ãƒ­ï¼ˆè¿½åŠ ã‚µãƒ¼ãƒãƒ¼ä¸è¦ï¼‰
 *
 * å‹•ä½œåŸç†:
 * 1. å„URLã‹ã‚‰å°ã•ãªãƒãƒ£ãƒ³ã‚¯ï¼ˆä¾‹: 1MBï¼‰ã‚’èª­ã¿è¾¼ã¿
 * 2. ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§ã‚½ãƒ¼ãƒˆ
 * 3. æœ€ã‚‚å¤ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰é †ã«å‡ºåŠ›
 * 4. ãƒ¡ãƒ¢ãƒªãŒä¸€æ¯ã«ãªã£ãŸã‚‰å¤ã„ãƒãƒ£ãƒ³ã‚¯ã‚’ç ´æ£„
 */
export class UnifiedStreamingSource implements ISerializedIterableSource {
  readonly sourceType = "serialized";

  #urls: string[];
  #readers: Map<string, BrowserHttpReader> = new Map();
  #chunkSize: number;
  #maxMemory: number;
  #currentMemory: number = 0;

  // å„URLã®èª­ã¿è¾¼ã¿ä½ç½®ã‚’è¿½è·¡
  #readPositions: Map<string, number> = new Map();

  // æœ€å°ãƒ’ãƒ¼ãƒ—: ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—é †ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç®¡ç†
  #messageQueue: MinHeap<TimestampedMessage> = new MinHeap((a, b) =>
    compare(a.timestamp, b.timestamp),
  );

  public constructor(args: {
    urls: string[];
    chunkSize?: number; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 1MB
    maxMemory?: number; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 100MB
  }) {
    this.#urls = args.urls;
    this.#chunkSize = args.chunkSize ?? 1024 * 1024; // 1MB
    this.#maxMemory = args.maxMemory ?? 100 * 1024 * 1024; // 100MB

    // å„URLã«Readerã‚’å‰²ã‚Šå½“ã¦
    for (const url of this.#urls) {
      this.#readers.set(url, new BrowserHttpReader(url));
      this.#readPositions.set(url, 0);
    }
  }

  public async initialize(): Promise<Initialization> {
    // å„URLã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const promises = Array.from(this.#readers.entries()).map(async ([url, reader]) => {
      const info = await reader.open();
      return { url, size: info.size };
    });

    const results = await Promise.all(promises);

    // æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¹ã‚­ãƒ¼ãƒæƒ…å ±ã‚’å–å¾—ï¼ˆç°¡ç•¥åŒ–ï¼‰
    const firstReader = this.#readers.get(this.#urls[0]!)!;

    // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€å„ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ã‚¹ã‚­ãƒ¼ãƒã‚’èª­ã¿å–ã‚‹
    // ã“ã“ã§ã¯ç°¡ç•¥åŒ–ã®ãŸã‚ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
    return {
      start: { sec: 0, nsec: 0 },
      end: { sec: 0, nsec: 0 },
      topics: [],
      topicStats: new Map(),
      problems: [],
      publishersByTopic: new Map(),
      profile: undefined,
      datatypes: new Map(),
    };
  }

  /**
   * ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿: ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å†ç”Ÿã®æ ¸å¿ƒéƒ¨åˆ†
   */
  public async *messageIterator(
    args: MessageIteratorArgs,
  ): AsyncIterableIterator<Readonly<IteratorResult<Uint8Array>>> {
    const { topics } = args;

    // åˆæœŸãƒãƒ£ãƒ³ã‚¯ã‚’å„URLã‹ã‚‰èª­ã¿è¾¼ã¿
    await this.#prefetchInitialChunks();

    while (this.#messageQueue.size() > 0 || this.#hasMoreData()) {
      // ãƒ¡ãƒ¢ãƒªåœ§è¿«ãƒã‚§ãƒƒã‚¯
      if (this.#currentMemory > this.#maxMemory) {
        await this.#evictOldestChunks();
      }

      // æ¬¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
      const message = this.#messageQueue.pop();
      if (!message) {
        // ã‚­ãƒ¥ãƒ¼ãŒç©º â†’ è¿½åŠ ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
        await this.#fetchNextChunks();
        continue;
      }

      // ãƒˆãƒ”ãƒƒã‚¯ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      if (topics.size > 0 && !topics.has(message.topic)) {
        continue;
      }

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºåŠ›
      yield {
        type: "message-event",
        msgEvent: {
          topic: message.topic,
          receiveTime: message.timestamp,
          message: message.data,
          sizeInBytes: message.data.byteLength,
          schemaName: message.schemaName,
        },
      };

      // ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’æ›´æ–°
      this.#currentMemory -= message.data.byteLength;
    }
  }

  /**
   * åˆæœŸãƒãƒ£ãƒ³ã‚¯ã®ãƒ—ãƒªãƒ•ã‚§ãƒƒãƒ
   * å„URLã‹ã‚‰æœ€åˆã®1MBã‚’èª­ã¿è¾¼ã¿
   */
  async #prefetchInitialChunks(): Promise<void> {
    const promises = this.#urls.map((url) => this.#fetchChunkFromUrl(url));
    await Promise.all(promises);
  }

  /**
   * ç‰¹å®šURLã‹ã‚‰æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã‚’èª­ã¿è¾¼ã¿
   */
  async #fetchChunkFromUrl(url: string): Promise<void> {
    const reader = this.#readers.get(url)!;
    const currentPos = this.#readPositions.get(url)!;

    try {
      // Range Requestã§1MBãƒãƒ£ãƒ³ã‚¯ã‚’èª­ã¿è¾¼ã¿
      const data = await reader.fetch(currentPos, this.#chunkSize);

      // ãƒãƒ£ãƒ³ã‚¯ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›
      // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€MCAPãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ãƒ‘ãƒ¼ã‚¹ãŒå¿…è¦
      const messages = await this.#parseChunk(url, data);

      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚­ãƒ¥ãƒ¼ã«è¿½åŠ 
      for (const message of messages) {
        this.#messageQueue.push(message);
        this.#currentMemory += message.data.byteLength;
      }

      // èª­ã¿è¾¼ã¿ä½ç½®ã‚’æ›´æ–°
      this.#readPositions.set(url, currentPos + this.#chunkSize);
    } catch (error) {
      console.warn(`Failed to fetch chunk from ${url}:`, error);
    }
  }

  /**
   * æ¬¡ã®ãƒãƒ£ãƒ³ã‚¯ã‚’ãƒ•ã‚§ãƒƒãƒ
   * æœ€ã‚‚ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒå¤ã„URLã‹ã‚‰å„ªå…ˆçš„ã«èª­ã¿è¾¼ã‚€
   */
  async #fetchNextChunks(): Promise<void> {
    // å„URLã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å–å¾—
    const urlTimestamps = new Map<string, Time>();

    for (const url of this.#urls) {
      const lastMessage = this.#getLastMessageFromUrl(url);
      if (lastMessage) {
        urlTimestamps.set(url, lastMessage.timestamp);
      }
    }

    // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæœ€ã‚‚å¤ã„URLã‹ã‚‰èª­ã¿è¾¼ã¿
    const sortedUrls = Array.from(urlTimestamps.entries())
      .sort(([, timeA], [, timeB]) => compare(timeA, timeB))
      .map(([url]) => url);

    // æœ€å¤§3ã¤ã®URLã‹ã‚‰ä¸¦åˆ—èª­ã¿è¾¼ã¿
    const urlsToFetch = sortedUrls.slice(0, 3);
    const promises = urlsToFetch.map((url) => this.#fetchChunkFromUrl(url));
    await Promise.all(promises);
  }

  /**
   * å¤ã„ãƒãƒ£ãƒ³ã‚¯ã‚’å‰Šé™¤ã—ã¦ãƒ¡ãƒ¢ãƒªã‚’è§£æ”¾
   */
  async #evictOldestChunks(): Promise<void> {
    // æœ€ã‚‚å¤ã„10%ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
    const messagesToRemove = Math.floor(this.#messageQueue.size() * 0.1);

    for (let i = 0; i < messagesToRemove; i++) {
      const message = this.#messageQueue.pop();
      if (message) {
        this.#currentMemory -= message.data.byteLength;
      }
    }
  }

  /**
   * ã¾ã èª­ã¿è¾¼ã‚€ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ç¢ºèª
   */
  #hasMoreData(): boolean {
    // ã™ã¹ã¦ã®URLãŒæœ€å¾Œã¾ã§èª­ã¿è¾¼ã¾ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
    // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€å„URLã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¨æ¯”è¼ƒ
    return true; // ç°¡ç•¥åŒ–
  }

  /**
   * ãƒãƒ£ãƒ³ã‚¯ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¤‰æ›
   * å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€MCAPãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ãƒ‘ãƒ¼ã‚¹å‡¦ç†
   */
  async #parseChunk(url: string, data: Uint8Array): Promise<TimestampedMessage[]> {
    // ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼å®Ÿè£…
    // å®Ÿéš›ã«ã¯ã€@mcap/core ã‚’ä½¿ç”¨ã—ã¦ãƒ‘ãƒ¼ã‚¹
    return [];
  }

  /**
   * ç‰¹å®šURLã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
   */
  #getLastMessageFromUrl(url: string): TimestampedMessage | undefined {
    // ã‚­ãƒ¥ãƒ¼ã‹ã‚‰è©²å½“URLã®æœ€å¾Œã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œç´¢
    // ç°¡ç•¥åŒ–ã®ãŸã‚çœç•¥
    return undefined;
  }

  public async getBackfillMessages(
    args: GetBackfillMessagesArgs,
  ): Promise<MessageEvent<Uint8Array>[]> {
    // ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«å®Ÿè£…ï¼ˆã‚·ãƒ¼ã‚¯æ™‚ã«ä½¿ç”¨ï¼‰
    return [];
  }
}

/**
 * ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ããƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 */
interface TimestampedMessage {
  url: string;
  topic: string;
  timestamp: Time;
  data: Uint8Array;
  schemaName: string;
}

/**
 * æœ€å°ãƒ’ãƒ¼ãƒ—å®Ÿè£…ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚½ãƒ¼ãƒˆç”¨ï¼‰
 */
class MinHeap<T> {
  #items: T[] = [];
  #comparator: (a: T, b: T) => number;

  constructor(comparator: (a: T, b: T) => number) {
    this.#comparator = comparator;
  }

  push(item: T): void {
    this.#items.push(item);
    this.#bubbleUp(this.#items.length - 1);
  }

  pop(): T | undefined {
    if (this.#items.length === 0) return undefined;
    if (this.#items.length === 1) return this.#items.pop();

    const top = this.#items[0];
    this.#items[0] = this.#items.pop()!;
    this.#bubbleDown(0);
    return top;
  }

  size(): number {
    return this.#items.length;
  }

  #bubbleUp(index: number): void {
    while (index > 0) {
      const parentIndex = Math.floor((index - 1) / 2);
      if (this.#comparator(this.#items[index]!, this.#items[parentIndex]!) >= 0) {
        break;
      }
      [this.#items[index], this.#items[parentIndex]] = [
        this.#items[parentIndex]!,
        this.#items[index]!,
      ];
      index = parentIndex;
    }
  }

  #bubbleDown(index: number): void {
    while (true) {
      const leftChild = 2 * index + 1;
      const rightChild = 2 * index + 2;
      let smallest = index;

      if (
        leftChild < this.#items.length &&
        this.#comparator(this.#items[leftChild]!, this.#items[smallest]!) < 0
      ) {
        smallest = leftChild;
      }

      if (
        rightChild < this.#items.length &&
        this.#comparator(this.#items[rightChild]!, this.#items[smallest]!) < 0
      ) {
        smallest = rightChild;
      }

      if (smallest === index) break;

      [this.#items[index], this.#items[smallest]] = [this.#items[smallest]!, this.#items[index]!];
      index = smallest;
    }
  }
}
```

---

### Step 2: RemoteDataSourceFactoryã®æ”¹ä¿®

**ãƒ•ã‚¡ã‚¤ãƒ«**: `packages/suite-base/src/dataSources/RemoteDataSourceFactory.tsx`

**å¤‰æ›´å†…å®¹**:

```typescript
// SPDX-FileCopyrightText: Copyright (C) 2023-2025 Bayerische Motoren Werke Aktiengesellschaft (BMW AG)<umi@bmwgroup.com>
// SPDX-License-Identifier: MPL-2.0

import path from "path";

import { AllowedFileExtensions } from "@umi/suite-base/constants/allowedFileExtensions";
import {
  IDataSourceFactory,
  DataSourceFactoryInitializeArgs,
} from "@umi/suite-base/context/PlayerSelectionContext";
import { IterablePlayer } from "@umi/suite-base/players/IterablePlayer";
import { UnifiedStreamingSource } from "@umi/suite-base/players/IterablePlayer/UnifiedStreamingSource"; // âœ… æ–°è¦è¿½åŠ 
import { Player } from "@umi/suite-base/players/types";

const fileTypesAllowed: AllowedFileExtensions[] = [
  AllowedFileExtensions.BAG,
  AllowedFileExtensions.MCAP,
];

export function checkExtensionMatch(fileExtension: string, previousExtension?: string): string {
  if (previousExtension != undefined && previousExtension !== fileExtension) {
    throw new Error("All sources need to be from the same type");
  }
  return fileExtension;
}

class RemoteDataSourceFactory implements IDataSourceFactory {
  public id = "remote-file";
  public legacyIds = ["mcap-remote-file", "ros1-remote-bagfile"];
  public type: IDataSourceFactory["type"] = "connection";
  public displayName = "Remote file";
  public iconName: IDataSourceFactory["iconName"] = "FileASPX";
  public supportedFileTypes = fileTypesAllowed;
  public description = "Open pre-recorded .bag or .mcap files from a remote location.";

  // ... æ—¢å­˜ã®docsLinksã¨formConfig ...

  public initialize(args: DataSourceFactoryInitializeArgs): Player | undefined {
    if (args.params?.url == undefined) {
      return;
    }
    const urls = args.params.url.split(",");

    // æ‹¡å¼µå­ãƒã‚§ãƒƒã‚¯
    let extension = "";
    urls.forEach((url) => {
      extension = path.extname(new URL(url).pathname);
      checkExtensionMatch(extension);
    });

    // âœ… è¤‡æ•°URLã®å ´åˆã¯çµ±åˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚½ãƒ¼ã‚¹ã‚’ä½¿ç”¨
    if (urls.length > 1) {
      console.log(`Using UnifiedStreamingSource for ${urls.length} files`);

      const source = new UnifiedStreamingSource({
        urls,
        chunkSize: 1024 * 1024, // 1MB per chunk
        maxMemory: 100 * 1024 * 1024, // 100MB total memory
      });

      return new IterablePlayer({
        source,
        name: `${urls.length} files`, // ã‚·ãƒ³ãƒ—ãƒ«ãªè¡¨ç¤ºå
        metricsCollector: args.metricsCollector,
        urlParams: { urls },
        sourceId: this.id,
        // âœ… readAheadDurationã¯ä¸è¦ï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‹ã®ãŸã‚ï¼‰
      });
    }

    // å˜ä¸€URLã®å ´åˆã¯æ—¢å­˜ã®å®Ÿè£…ã‚’ä½¿ç”¨
    // ... æ—¢å­˜ã‚³ãƒ¼ãƒ‰ ...
  }

  // ... æ—¢å­˜ã®#validateUrl ...
}

export default RemoteDataSourceFactory;
```

---

## ğŸ“Š ãƒ¡ãƒªãƒƒãƒˆãƒ»ãƒ‡ãƒ¡ãƒªãƒƒãƒˆæ¯”è¼ƒ

### âœ… ãƒ¡ãƒªãƒƒãƒˆ

| é …ç›®                 | å¾“æ¥ã®å®Ÿè£…               | UnifiedStreamingSource |
| -------------------- | ------------------------ | ---------------------- |
| **ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**     | 500MB-1GB Ã— URLæ•°        | å¸¸ã«100MBä»¥ä¸‹          |
| **ä½ã‚¹ãƒšãƒƒã‚¯PCå¯¾å¿œ** | âŒ 4GBä»¥ä¸‹ã§ã¯ä¸å¯       | âœ… 2GBä»¥ä¸‹ã§ã‚‚å‹•ä½œ     |
| **è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«å†ç”Ÿ** | âŒ é…ã„ãƒ»ä¸å®‰å®š          | âœ… ã‚¹ãƒ ãƒ¼ã‚º            |
| **ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆ**   | âŒ Lambda/S3è¿½åŠ è²»ç”¨     | âœ… ã‚¼ãƒ­                |
| **å®Ÿè£…ã‚³ã‚¹ãƒˆ**       | ä½ï¼ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´ã®ã¿ï¼‰ | ä¸­ï¼ˆæ–°è¦å®Ÿè£…å¿…è¦ï¼‰     |
| **é•·æœŸçš„ãªæ‹¡å¼µæ€§**   | âŒ é™ç•ŒãŒã‚ã‚‹            | âœ… ç„¡åˆ¶é™ã«ã‚¹ã‚±ãƒ¼ãƒ«    |

### âš ï¸ ãƒ‡ãƒ¡ãƒªãƒƒãƒˆã¨å¯¾ç­–

1. **åˆå›èª­ã¿è¾¼ã¿ãŒå°‘ã—é…ã„**

   - å¯¾ç­–: åˆæœŸãƒ—ãƒªãƒ•ã‚§ãƒƒãƒã‚’ä¸¦åˆ—åŒ–
   - ä½“æ„Ÿ: 1-2ç§’ç¨‹åº¦ã®é…å»¶ï¼ˆè¨±å®¹ç¯„å›²ï¼‰

2. **ã‚·ãƒ¼ã‚¯æ“ä½œãŒè¤‡é›‘**

   - å¯¾ç­–: ãƒãƒƒã‚¯ãƒ•ã‚£ãƒ«æ©Ÿèƒ½ã®å®Ÿè£…
   - å¿…è¦æ€§: ä¸­ç¨‹åº¦ï¼ˆå¤šãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯é †æ¬¡å†ç”Ÿï¼‰

3. **å®Ÿè£…ã‚³ã‚¹ãƒˆ**
   - å¯¾ç­–: æ®µéšçš„ãªå®Ÿè£…ï¼ˆMVP â†’ å®Œå…¨ç‰ˆï¼‰
   - æœŸé–“: 1-2é€±é–“

---

## ğŸ¯ å®Ÿè£…ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### Phase 1: MVPå®Ÿè£…ï¼ˆ1é€±é–“ï¼‰

**ç›®æ¨™**: åŸºæœ¬çš„ãªã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å†ç”Ÿã‚’å®Ÿç¾

1. **Day 1-2**: UnifiedStreamingSourceã®éª¨æ ¼å®Ÿè£…

   - MinHeapå®Ÿè£…
   - åŸºæœ¬çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚­ãƒ¥ãƒ¼
   - å˜ç´”ãªãƒãƒ£ãƒ³ã‚¯èª­ã¿è¾¼ã¿

2. **Day 3-4**: MCAPãƒ‘ãƒ¼ã‚¹çµ±åˆ

   - @mcap/coreã®çµ±åˆ
   - ãƒãƒ£ãƒ³ã‚¯ã®ãƒ‘ãƒ¼ã‚¹å‡¦ç†
   - ã‚¹ã‚­ãƒ¼ãƒãƒ»ãƒˆãƒ”ãƒƒã‚¯æƒ…å ±ã®æŠ½å‡º

3. **Day 5**: RemoteDataSourceFactoryã®æ”¹ä¿®

   - è¤‡æ•°URLåˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
   - UnifiedStreamingSourceã¸ã®åˆ‡ã‚Šæ›¿ãˆ

4. **Day 6-7**: ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒãƒƒã‚°
   - å˜ä½“ãƒ†ã‚¹ãƒˆ
   - çµ±åˆãƒ†ã‚¹ãƒˆ
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

### Phase 2: æœ€é©åŒ–ï¼ˆ1é€±é–“ï¼‰

1. **ä¸¦åˆ—ãƒ•ã‚§ãƒƒãƒæœ€é©åŒ–**

   - HTTP/2ãƒãƒ«ãƒãƒ—ãƒ¬ãƒƒã‚¯ã‚¹æ´»ç”¨
   - æ¥ç¶šãƒ—ãƒ¼ãƒªãƒ³ã‚°

2. **ãƒ¡ãƒ¢ãƒªç®¡ç†ã®æ”¹å–„**

   - ã‚ˆã‚Šè³¢ã„evictionæˆ¦ç•¥
   - å‹•çš„ãƒ¡ãƒ¢ãƒªåˆ¶é™èª¿æ•´

3. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–**
   - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã®å†è©¦è¡Œ
   - éƒ¨åˆ†çš„ãªãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†

### Phase 3: é«˜åº¦ãªæ©Ÿèƒ½ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

1. **ã‚·ãƒ¼ã‚¯æ©Ÿèƒ½ã®å®Ÿè£…**
2. **å†ç”Ÿé€Ÿåº¦èª¿æ•´ã®æœ€é©åŒ–**
3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬æ©Ÿèƒ½**

---

## ğŸ’» æŠ€è¡“çš„ãªè©³ç´°

### ãƒ¡ãƒ¢ãƒªç®¡ç†æˆ¦ç•¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ¡ãƒ¢ãƒªãƒãƒƒãƒ•ã‚¡ (100MBå›ºå®š)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [Chunk 1: 1MB] URL1: messages 1-10   â”‚
â”‚ [Chunk 2: 1MB] URL2: messages 1-8    â”‚
â”‚ [Chunk 3: 1MB] URL3: messages 1-12   â”‚
â”‚ [Chunk 4: 1MB] URL1: messages 11-20  â”‚
â”‚ ...                                   â”‚
â”‚ [Chunk N: 1MB] æœ€å¤§100å€‹ã¾ã§         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

èª­ã¿è¾¼ã¿ãƒ«ãƒ¼ãƒ«:
1. ãƒãƒƒãƒ•ã‚¡ãŒ80%ã‚’è¶…ãˆãŸã‚‰ã€å¤ã„ãƒãƒ£ãƒ³ã‚¯ã‚’å‰Šé™¤
2. ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæœ€ã‚‚å¤ã„URLã‹ã‚‰å„ªå…ˆçš„ã«èª­ã¿è¾¼ã¿
3. æœ€å¤§3ã¤ã®URLã‹ã‚‰ä¸¦åˆ—ãƒ•ã‚§ãƒƒãƒ
```

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç‰¹æ€§

**ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡**:

- å›ºå®š: 100MB
- ãƒ”ãƒ¼ã‚¯: 120MB (ä¸€æ™‚çš„ãªãƒãƒƒãƒ•ã‚¡)
- æœ€å°: 50MB (ã‚¢ã‚¤ãƒ‰ãƒ«æ™‚)

**ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ä½¿ç”¨é‡**:

- å¿…è¦ãªéƒ¨åˆ†ã®ã¿ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
- æ—©é€ã‚Šæ™‚: ä¸­é–“ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¹ã‚­ãƒƒãƒ—
- å¸¯åŸŸç¯€ç´„: 30-50% (å¾“æ¥æ¯”)

**CPUä½¿ç”¨ç‡**:

- è»½é‡: ãƒ‘ãƒ¼ã‚¹å‡¦ç†ã®ã¿
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰: Workerå®Ÿè¡Œ
- ä½ã‚¹ãƒšãƒƒã‚¯PC: å•é¡Œãªã—

---

## ğŸ“ˆ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### å®šé‡çš„ãªæ”¹å–„

| æŒ‡æ¨™                      | ç¾çŠ¶    | æ”¹å–„å¾Œ  | æ”¹å–„ç‡         |
| ------------------------- | ------- | ------- | -------------- |
| ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ (10ãƒ•ã‚¡ã‚¤ãƒ«) | 5GB     | 100MB   | **98%å‰Šæ¸›**    |
| ä½ã‚¹ãƒšãƒƒã‚¯PCå‹•ä½œ          | âŒ ä¸å¯ | âœ… å¯èƒ½ | -              |
| åˆå›èª­ã¿è¾¼ã¿æ™‚é–“          | 10-20ç§’ | 3-5ç§’   | **60-75%å‰Šæ¸›** |
| ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆ            | $30/æœˆ  | $0/æœˆ   | **100%å‰Šæ¸›**   |

### å®šæ€§çš„ãªæ”¹å–„

1. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“**

   - âœ… ã©ã‚“ãªã‚¹ãƒšãƒƒã‚¯ã®PCã§ã‚‚å‹•ä½œ
   - âœ… è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã‚¹ãƒ ãƒ¼ã‚ºã«å†ç”Ÿ
   - âœ… ãƒ¡ãƒ¢ãƒªä¸è¶³ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„

2. **é‹ç”¨ã‚³ã‚¹ãƒˆ**

   - âœ… Lambdaé–¢æ•°ä¸è¦
   - âœ… ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç”Ÿæˆä¸è¦
   - âœ… S3ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šä¸è¦

3. **å°†æ¥ã®æ‹¡å¼µæ€§**
   - âœ… 10ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚100ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚åŒã˜ãƒ¡ãƒ¢ãƒª
   - âœ… å·¨å¤§ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ10GB+ï¼‰ã‚‚å†ç”Ÿå¯èƒ½
   - âœ… ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã¸ã®æ‹¡å¼µãŒå®¹æ˜“

---

## ğŸ”§ å®Ÿè£…æ™‚ã®æ³¨æ„ç‚¹

### 1. MCAPãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®æ‰±ã„

```typescript
// @mcap/core ã‚’ä½¿ç”¨ã—ãŸã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ‘ãƒ¼ã‚¹
import { McapStreamReader } from "@mcap/core";

async function parseChunk(data: Uint8Array): Promise<Message[]> {
  const reader = new McapStreamReader();
  reader.append(data);

  const messages: Message[] = [];
  for (let record; (record = reader.nextRecord()); ) {
    if (record.type === "Message") {
      messages.push(record);
    }
  }

  return messages;
}
```

### 2. ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã®æ­£ç¢ºãªå‡¦ç†

```typescript
// è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’æ­£ç¢ºã«ãƒãƒ¼ã‚¸
function mergeMessages(queues: Map<string, Message[]>): Message[] {
  const heap = new MinHeap<Message>((a, b) => compare(a.timestamp, b.timestamp));

  // å„ã‚­ãƒ¥ãƒ¼ã®å…ˆé ­è¦ç´ ã‚’ãƒ’ãƒ¼ãƒ—ã«è¿½åŠ 
  for (const messages of queues.values()) {
    if (messages.length > 0) {
      heap.push(messages[0]);
    }
  }

  const merged: Message[] = [];
  while (heap.size() > 0) {
    const message = heap.pop();
    merged.push(message);
  }

  return merged;
}
```

### 3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```typescript
async function fetchChunkWithRetry(
  url: string,
  offset: number,
  size: number,
  maxRetries: number = 3,
): Promise<Uint8Array> {
  for (let i = 0; i < maxRetries; i++) {
    try {
      const response = await fetch(url, {
        headers: { Range: `bytes=${offset}-${offset + size - 1}` },
      });

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      return new Uint8Array(await response.arrayBuffer());
    } catch (error) {
      if (i === maxRetries - 1) throw error;

      // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•
      await new Promise((resolve) => setTimeout(resolve, Math.pow(2, i) * 1000));
    }
  }

  throw new Error("Unreachable");
}
```

---

## ğŸ†š ä»–ã®è§£æ±ºç­–ã¨ã®æ¯”è¼ƒ

| ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ                 | ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡  | ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆ | å®Ÿè£…ã‚³ã‚¹ãƒˆ | æ¨å¥¨åº¦         |
| -------------------------- | ------------- | -------------- | ---------- | -------------- |
| **UnifiedStreamingSource** | **100MBå›ºå®š** | **ã‚¼ãƒ­**       | **ä¸­**     | **â­â­â­â­â­** |
| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª¿æ•´             | 1GB Ã— URLæ•°   | ã‚¼ãƒ­           | ä½         | â­â­           |
| MCAPã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹åŒ–         | 500MB Ã— URLæ•° | $30/æœˆ         | ä¸­         | â­â­â­         |
| å°‚ç”¨ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼       | 500MB Ã— URLæ•° | $100+/æœˆ       | å¤§         | â­â­           |

**çµè«–**: UnifiedStreamingSourceãŒæœ€é©è§£

---

## ğŸš€ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³

### ä»Šã™ãé–‹å§‹ã§ãã‚‹ã“ã¨

1. **UnifiedStreamingSource.tsã®ä½œæˆ**

   ```bash
   touch packages/suite-base/src/players/IterablePlayer/UnifiedStreamingSource.ts
   ```

2. **MinHeapå®Ÿè£…ã®ãƒ†ã‚¹ãƒˆ**

   ```typescript
   // å˜ä½“ãƒ†ã‚¹ãƒˆã§å‹•ä½œç¢ºèª
   const heap = new MinHeap<number>((a, b) => a - b);
   heap.push(5);
   heap.push(3);
   heap.push(7);
   console.log(heap.pop()); // 3
   ```

3. **MVPæ©Ÿèƒ½ã®ãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—**
   - 2ãƒ•ã‚¡ã‚¤ãƒ«ã®ç°¡å˜ãªãƒãƒ¼ã‚¸
   - ãƒ¡ãƒ¢ãƒªåˆ¶é™ã®å‹•ä½œç¢ºèª

### 1é€±é–“å¾Œã®ç›®æ¨™

- âœ… MVPå®Ÿè£…å®Œäº†
- âœ… åŸºæœ¬çš„ãªã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å†ç”Ÿå‹•ä½œ
- âœ… ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡100MBä»¥ä¸‹ã‚’ç¢ºèª

### 2é€±é–“å¾Œã®ç›®æ¨™

- âœ… æœ¬ç•ªç’°å¢ƒã§10ãƒ•ã‚¡ã‚¤ãƒ«å†ç”ŸæˆåŠŸ
- âœ… ä½ã‚¹ãƒšãƒƒã‚¯PCï¼ˆ4GB RAMï¼‰ã§å‹•ä½œç¢ºèª
- âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è¨ˆæ¸¬çµæœã®å–å¾—

---

## ğŸ“š å‚è€ƒè³‡æ–™

### æ—¢å­˜ã®å®Ÿè£…ã‚’å­¦ã¶

1. **BufferedIterableSource.ts**

   - ãƒ—ãƒ­ãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼ãƒ»ã‚³ãƒ³ã‚·ãƒ¥ãƒ¼ãƒãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‚è€ƒ
   - ãƒ¡ãƒ¢ãƒªãƒãƒƒãƒ•ã‚¡ç®¡ç†ã®å®Ÿè£…ä¾‹

2. **BlockLoader.ts**

   - ãƒ–ãƒ­ãƒƒã‚¯å˜ä½ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
   - ãƒ¡ãƒ¢ãƒªåœ§è¿«æ™‚ã®å‰Šé™¤æˆ¦ç•¥

3. **WorkerSerializedIterableSource.ts**
   - Workeré€šä¿¡ã®å®Ÿè£…
   - éåŒæœŸã‚¤ãƒ†ãƒ¬ãƒ¼ã‚¿ã®ä½¿ç”¨æ–¹æ³•

### é–¢é€£æŠ€è¡“

- **MCAPä»•æ§˜**: https://mcap.dev/
- **HTTP Range Requests**: https://developer.mozilla.org/en-US/docs/Web/HTTP/Range_requests
- **JavaScript ãƒ’ãƒ¼ãƒ—å®Ÿè£…**: https://github.com/datastructures-js/heap

---

## ğŸ“ ã¾ã¨ã‚

### æ ¹æœ¬çš„ãªè§£æ±º = ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

**å¾“æ¥ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆãƒ—ãƒªãƒ­ãƒ¼ãƒ‰å‹ï¼‰**:

```
âŒ ãƒ•ã‚¡ã‚¤ãƒ«å…¨ä½“ã‚’ãƒ¡ãƒ¢ãƒªã« â†’ ãƒ¡ãƒ¢ãƒªä¸è¶³ â†’ Lambda/S3ã§æœ€é©åŒ– â†’ ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆ
```

**ææ¡ˆã™ã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°å‹ï¼‰**:

```
âœ… å¿…è¦ãªéƒ¨åˆ†ã ã‘ãƒ¡ãƒ¢ãƒªã« â†’ ãƒ¡ãƒ¢ãƒªä¸€å®š â†’ è¿½åŠ ã‚¤ãƒ³ãƒ•ãƒ©ä¸è¦ â†’ ã‚³ã‚¹ãƒˆã‚¼ãƒ­
```

### å®Ÿç¾å¯èƒ½æ€§

- **æŠ€è¡“çš„**: âœ… æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’æ´»ç”¨å¯èƒ½
- **ã‚³ã‚¹ãƒˆçš„**: âœ… ã‚¤ãƒ³ãƒ•ãƒ©ã‚³ã‚¹ãƒˆã‚¼ãƒ­
- **æ™‚é–“çš„**: âœ… 1-2é€±é–“ã§å®Ÿè£…å¯èƒ½

### æŠ•è³‡å¯¾åŠ¹æœ

- **å®Ÿè£…ã‚³ã‚¹ãƒˆ**: 1-2é€±é–“ã®é–‹ç™ºæ™‚é–“
- **ç¶™ç¶šã‚³ã‚¹ãƒˆ**: ã‚¼ãƒ­
- **åŠ¹æœ**:
  - ãƒ¡ãƒ¢ãƒª98%å‰Šæ¸›
  - ä½ã‚¹ãƒšãƒƒã‚¯PCå¯¾å¿œ
  - ç„¡åˆ¶é™ã®ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£

**ROI**: éå¸¸ã«é«˜ã„ ğŸš€
