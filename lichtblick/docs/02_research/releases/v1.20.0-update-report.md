# Lichtblick v1.20.0 アップデートレポート

## 概要

このドキュメントは、Lichtblick v1.20.0 のリリースにおける変更内容をまとめたものです。

- **リリース日**: 2025年10月2日
- **対象バージョン**: v1.19.0 → v1.20.0
- **GitHubリリース**: https://github.com/lichtblick-suite/lichtblick/releases/tag/v1.20.0
- **コミットハッシュ**: 359c6fc2f1da5cd05baed9420f559f12b0ff1184

## 主要な新機能・改善

### 1. 🔄 Transform事前読み込み機能のデフォルト値変更

**PR #620**: Preloading TF as false by default

- **変更内容**: Transform（座標変換）の事前読み込み機能のデフォルト値を`true`から`false`に変更
- **実装の詳細**:
  - `Renderer.ts`でpreloadTransformsのデフォルト値を`false`に変更（情報源: PR #620 files）
  - Settings APIに新しいtooltipフィールドを追加し、パフォーマンス警告を表示
  - 設定画面にツールチップを追加: "Please be aware that performance may be impacted when turning preloading on."
- **技術的背景**:
  - Settings APIの応答性の問題を一時的に回避するための変更
  - UIの更新は即座に行われるが、実際の状態とレイアウトの更新は1秒のスロットルにより遅延が発生していた
  - 根本的な解決策はTree Loaderでの実装を予定（feature/tree-loaderブランチ）
- **影響**: パフォーマンス問題を軽減、特に大規模なTransformデータを扱う場合の初期読み込み速度が向上
- **ユーザーへの影響**: Transform treeを使用するユーザーは、より正確な可視化のために手動で有効化する必要がある
- **関連issue**: [#382](https://github.com/lichtblick-suite/lichtblick/issues/382)
- **情報源**: [PR #620](https://github.com/lichtblick-suite/lichtblick/pull/620)、[変更ファイル](https://github.com/lichtblick-suite/lichtblick/pull/620/files)

### 2. ⚡ Panel Settings 保存スロットル時間の短縮

**PR #619**: Reduce panel settings save throttle time

- **変更内容**: ThreeDeeRenderパネルの設定保存のdebounce時間を1000msから100msに短縮
- **実装の詳細**:
  - `ThreeDeeRender.tsx`のthrottledSave関数のdebounce時間を変更
  - 変更前: `1000ms` → 変更後: `100ms`
  - maxWaitは`1000ms`のまま維持
  - I/O操作の頻度は増加するが、UIの応答性が大幅に向上
- **技術的背景**:
  - Settings APIがUI更新と設定保存が密結合している課題の一時的な回避策
  - UIは即座に更新されるが、Settings APIの状態は設定が永続化されるまで更新されない
  - この変更により、変更がシステム全体により速く伝播し、Settings APIがほぼリアルタイムで応答
- **影響**:
  - 設定変更が即座に反映されるようになり、ユーザー体験が向上
  - 特にSettings APIを使用する拡張機能での応答性が改善
- **将来の改善**: UIフィードバックとレイアウトの永続化を分離する必要性を認識
- **情報源**: [PR #619](https://github.com/lichtblick-suite/lichtblick/pull/619)、[変更ファイル](https://github.com/lichtblick-suite/lichtblick/pull/619/files)

### 3. 🖼️ 画像歪み補正のセグメント数増加

**PR #647**: Add more segments to image distortion

- **変更内容**: 画像レンダリングの平面ジオメトリの解像度を10セグメントから100セグメントに増加
- **実装の詳細**:
  - `ImageRenderable.ts`の`createGeometry`関数内の定数を変更
  - `WIDTH_SEGMENTS`: `10` → `100`
  - `HEIGHT_SEGMENTS`: `10` → `100`
  - 計算はイメージ作成時または新しいカメラモデル選択時のみ実行されるため、ランタイムパフォーマンスへの影響はなし
- **技術的背景**:
  - 一部のカメラモデルで画像エッジ付近に顕著な歪みが発生し、視覚的に不正確なレンダリングとなっていた
  - セグメント数を増やすことで、歪み補正の精度が向上
- **Before/After**: PRに視覚的な改善を示すスクリーンショットが含まれている
- **影響**: 画像パネルでの歪み補正の精度が大幅に向上、特にエッジ部分の描画品質が改善
- **今後の検討事項**:
  - 将来的にはユースケースに応じて動的にセグメント数を調整する可能性
  - ユーザー入力による設定も検討中
- **情報源**: [PR #647](https://github.com/lichtblick-suite/lichtblick/pull/647)、[変更ファイル](https://github.com/lichtblick-suite/lichtblick/pull/647/files)

### 4. 🔧 Sync Instances の実験的機能からの正式化

**PR #648**: Remove sync instances feature from experimental features

- **変更内容**: Sync Instances機能を実験的機能から正式機能に昇格
- **実装の詳細**:
  - `AppSetting.ts`から`SHOW_SYNC_LB_INSTANCES`設定を削除
  - `ExperimentalFeatureSettings.tsx`からSync Instances関連のUI要素を削除
  - `SyncInstanceToggle.tsx`から実験的機能のチェックロジックを削除（14行のコード削除）
  - E2Eテストを追加（115行）: `sync-instances.web.spec.ts`
- **テストカバレッジ**:
  - 2つのブラウザタブ間での同期動作を検証
  - 再生、一時停止、シーク操作の同期を確認
  - BroadcastChannelを使用した通信の動作確認
- **ユーザーへの影響**:
  - ユーザーは実験的機能を有効化せずにSync Instances機能を利用可能
  - 常に表示され、デフォルトで無効（ユーザーが手動で有効化）
- **関連ドキュメント**: [lichtblick-suite/docs#48](https://github.com/lichtblick-suite/docs/pull/48)
- **情報源**: [PR #648](https://github.com/lichtblick-suite/lichtblick/pull/648)、[変更ファイル](https://github.com/lichtblick-suite/lichtblick/pull/648/files)

### 5. 📋 レイアウトセクションでの一括操作の修正と改善

**PR #664**: Improve layout section - Bulk actions

- **変更内容**: レイアウトの複数選択と一括操作機能を修正し、正しく動作するように実装
- **実装の詳細**:
  - **以前の問題**: UIは一括操作（削除、復元、複製、保存）をサポートしているように見えたが、実際には壊れているか誤解を招く動作をしていた
  - **修正内容**:
    - 複数選択時の一括操作（Delete、Revert、Duplicate、Save）を正しく実装
    - `modKey + マウスクリック`で複数選択をサポート
    - `shift + マウスクリック`による複数選択は意図的に無効化
    - Revertアクションの修正（当初動作していなかった）
  - **コード変更**:
    - 209行の新しいユニットテストを`LayoutRow.test.tsx`に追加
    - `LayoutRow.tsx`: 42行の変更（コードの整理とバグ修正）
    - `LayoutSection.tsx`や関連コンポーネントのリファクタリング
    - 型定義とスタイルの整理
- **テストカバレッジ**:
  - 複数選択時の各アクションの動作を検証
  - 確認ダイアログの動作テスト
  - 無効化されるべき操作（Rename、Export）の検証
- **影響**: レイアウト管理の使いやすさが大幅に向上、複数レイアウトの一括操作が実際に機能
- **コードの変更量**: +1,030行、-94行
- **情報源**: [PR #664](https://github.com/lichtblick-suite/lichtblick/pull/664)、[変更ファイル](https://github.com/lichtblick-suite/lichtblick/pull/664/files)

### 6. 📚 Linux `.tar.gz` パッケージの依存関係に関する注意事項を README に追加

**PR #704**: Add missing dependencies note to readme

- **変更内容**: READMEファイルにLinux `.tar.gz` パッケージ使用時のシステム依存関係に関する警告セクションを追加
- **実装の詳細**:
  - **新規セクション追加**: "Note on Linux dependencies (.tar.gz only)"
  - **追加行数**: +31行
  - **コミット数**: 3コミット（初期追加、リンク修正、`-y`フラグ削除）
- **記載内容**:
  - `.tar.gz`パッケージでは`.deb`パッケージと異なり、システム依存関係が自動インストールされないことを明示
  - Google ChromeやChromiumベースのアプリケーションがインストール済みの場合、多くの場合は動作することを説明
  - 不足している可能性のある主要な依存関係のリスト（14個）:
    - `libgtk-3-0`, `libatk1.0-0`, `libatk-bridge2.0-0`, `libatspi2.0-0`
    - `libnss3`, `libnspr4`, `libasound2`, `libcups2`
    - `libnotify4`, `libxtst6`, `xdg-utils`, `libdrm2`
    - `libgbm1`, `libxcb-dri3-0`
  - Debian/Ubuntu向けのインストールコマンド例を提供:
    ```bash
    sudo apt-get update && sudo apt-get install libgtk-3-0 libatk1.0-0 libatk-bridge2.0-0 libatspi2.0-0 libnss3 libnspr4 libasound2 libcups2 libnotify4 libxtst6 xdg-utils libdrm2 libgbm1 libxcb-dri3-0
    ```
  - ターミナルのエラーメッセージを確認して不足ライブラリを特定する推奨事項を記載
- **技術的背景**:
  - Electron/Chromiumベースのアプリケーションは特定のシステムライブラリに依存
  - `.deb`パッケージはパッケージマネージャーが自動的に依存関係を解決
  - `.tar.gz`パッケージはポータブルだが、ユーザーが手動で依存関係を管理する必要がある
- **ユーザーへの影響**:
  - `.tar.gz`パッケージを使用するLinuxユーザーが起動時のライブラリ不足エラーを解決しやすくなる
  - トラブルシューティングの時間を削減
  - セットアップドキュメントの完全性が向上
- **レビュー状況**: @iorio-tux により承認済み
- **コード品質**: SonarQube Cloud - Quality Gate Passed（新規issues: 0、Security Hotspots: 0）
- **情報源**:
  - [PR #704](https://github.com/lichtblick-suite/lichtblick/pull/704)
  - [変更ファイル](https://github.com/lichtblick-suite/lichtblick/pull/704/files)

---

## 🛠 バグ修正

### SonarCloud 検出問題の修正

**PR #641**: Bugfix/resolve sonar issue invalid loop

- **変更内容**: SonarCloudが検出したコード品質問題を修正
- **実装の詳細**:
  - **対象ファイル**: `benchmark/src/players/BenchmarkPlayer.ts`
  - **変更行数**: +5行、-5行（計10行の変更）
  - **コミット数**: 2コミット
    1. "resolve sonar issue - Invalid loop"
    2. "resolve sonar issue - Readonly attrs"
- **具体的な修正内容**:
  - **無効なループ処理の修正**:
    - 従来: `for (const alert of result.alerts) { throw new Error(alert.message); }`
    - 修正後: `if (result.alerts.length > 0) { throw new Error(result.alerts[0]!.message); }`
    - ループで最初の要素のみを使用していた非効率な処理を条件分岐に変更
  - **readonly属性の追加**:
    - `#source: IDeserializedIterableSource` → `readonly #source: IDeserializedIterableSource`
    - `#name: string` → `readonly #name: string`
    - `#alertManager = new PlayerAlertManager()` → `readonly #alertManager = new PlayerAlertManager()`
    - 変更されることのないプライベートフィールドにreadonly修飾子を追加
- **技術的背景**:
  - SonarCloudは静的コード解析でコード品質とセキュリティの問題を検出
  - 無効なループ: ループの最初の要素のみを使用して即座にbreakまたはreturnする非効率なパターン
  - readonly属性: 一度設定された後変更されないフィールドに対する型安全性の向上
- **品質向上効果**:
  - パフォーマンス改善: 不要なループ処理の削除
  - 型安全性向上: readonly修飾子によるランタイムエラーの防止
  - 可読性向上: 意図がより明確なコード
- **テスト状況**:
  - Webバージョン: テスト済み、正常動作確認
  - デスクトップバージョン: テスト済み、正常動作確認
  - ユニットテストによるカバレッジ: 対応済み
- **レビュー状況**: @luluiz により承認済み（2025年8月13日）
- **コード品質**: SonarQube Cloud - Quality Gate Passed（新規issues: 0、Security Hotspots: 0）
- **情報源**:
  - [PR #641](https://github.com/lichtblick-suite/lichtblick/pull/641)
  - [変更ファイル](https://github.com/lichtblick-suite/lichtblick/pull/641/files)

---

## 🔧 その他の変更

### 1. Teleopパネルの品質向上（テストコード追加）

#### 概要

Teleopパネルに対して、自動テストコードを大幅に追加しました。これは品質保証のための内部改善で、ユーザーが直接目にする機能の変更はありません。

#### 実装内容

**PR #646, #626**: Teleopパネルの自動テスト強化

**何が変わったか**:

- Teleopパネルの方向パッド（上下左右ボタン）の動作を自動的に検証するテストを追加
- コードの構造を整理し、スタイル定義や型定義を別ファイルに分離

**具体的な実装**:

- 方向ボタン（上・下・左・右）の動作テストを追加
- ボタンが無効な状態での動作テストを追加
- マウスクリックやホバー時の動作テストを追加
- スタイル定義を `DirectionalPad.style.ts` に分離（64行）
- SVGパスの定義を `constants.ts` に分離
- 型定義を `types.ts` に分離

**既存機能への影響**:

- ✅ **影響なし**: ユーザーから見た動作は全く変わりません
- ✅ **品質向上**: 将来のバグを未然に防ぐテストが充実しました
- ✅ **保守性向上**: コードが整理され、今後の機能追加や修正がしやすくなりました

**情報源**:

- [PR #646](https://github.com/lichtblick-suite/lichtblick/pull/646)
- [PR #626](https://github.com/lichtblick-suite/lichtblick/pull/626)

### 2. Map パネルのパフォーマンス改善（実験的API追加）

#### 概要

GPSデータなどの大量の位置情報を表示するMapパネルで、データ読み込みを高速化する新しい仕組みを実験的に導入しました。

#### 実装内容

**PR #643**: 実験的なメッセージ範囲購読API

**何が変わったか**:

- 大量のGPSデータを効率的に読み込む新しいAPI（`unstable_subscribeMessageRange`）を追加
- Mapパネルでマウスをホバーした際にマーカーが消える不具合を修正
- 高速にマウスを動かしても正しく1つのマーカーだけがハイライトされるように改善

**具体的な実装**:

- メッセージを16ミリ秒ごとのバッチ（まとめ）で処理する仕組みを実装
- Map パネルで新しいAPIを使用してパフォーマンスを向上
- ホバー時の状態管理を改善

**既存機能への影響**:

- ✅ **改善あり**: Mapパネルで大量のGPSデータを表示する際の速度が向上
- ✅ **バグ修正**: マウスホバー時にマーカーが消える問題を解決
- ⚠️ **実験的機能**: APIには`unstable`という接頭辞が付いており、将来変更される可能性があります

**今後の予定**:

- 3Dパネル、グラフパネル、状態遷移パネルでも同じ仕組みを採用予定
- 十分な検証後、古いデータ読み込みシステム（Block Loader）を廃止予定

**情報源**:

- [PR #643](https://github.com/lichtblick-suite/lichtblick/pull/643)

### 3. リリースプロセスの自動化（開発者向け）

#### 概要

ソフトウェアのリリース作業を自動化し、より安定したリリースプロセスを確立しました。これは開発プロセスの改善で、エンドユーザーには直接影響しません。

#### 実装内容

**PR #645**: Git Flowベースのリリース自動化

**何が変わったか**:

- リリース作業を自動化する仕組みを導入
- ブランチ（コードの枝分かれ）の管理方法を標準化

**具体的な実装**:

- **ブランチの役割分担**:

  - `main`ブランチ: 正式リリース版のコード
  - `develop`ブランチ: 開発中のコード（新しい作業の起点）
  - `feature`ブランチ: 新機能の開発用
  - `release`ブランチ: リリース準備用
  - `hotfix`ブランチ: 緊急バグ修正用

- **自動化されたワークフロー**:
  - mainブランチにマージすると自動的にバージョン番号が更新される
  - developブランチでテスト版（プレリリース）を簡単に作成できる
  - ブランチ名の命名規則を自動チェック

**既存機能への影響**:

- ✅ **影響なし**: ユーザーが使用する機能に変更はありません
- ✅ **品質向上**: リリースプロセスが標準化され、バグの混入リスクが低減
- ✅ **リリース頻度向上**: 作業が自動化され、より早く新機能を届けられる

**情報源**:

- [PR #645](https://github.com/lichtblick-suite/lichtblick/pull/645)

### 4. 複数ウィンドウ起動時のファイル読み込み修正（デスクトップ版）

#### 概要

デスクトップ版で複数のウィンドウを開く際、コマンドラインから指定したファイルが正しく開かれない問題を修正しました。

#### 実装内容

**PR #683**: 複数ウィンドウ起動時のファイルオープン修正

**何が変わったか**:

- コマンドラインで複数の方法でファイルを指定した場合でも、すべて正しく開かれるようになった
- 同じファイルが重複して指定された場合、1回だけ開くように改善

**具体的な実装**:

- ファイル指定の2つの方法を統合:
  - 直接指定: `lichtblick file1.mcap file2.bag`
  - フラグ指定: `lichtblick --source=file1.mcap,file2.bag`
- 両方を同時に使用した場合でも正しく動作するように修正
- ファイルパスの重複を自動的に削除
- 相対パス（`./data.mcap`など）も正しく処理

**既存機能への影響**:

- ✅ **バグ修正**: 以前は`--source`フラグで指定したファイルが開かれないことがあった
- ✅ **改善**: 複数の方法でファイルを指定できるようになり、柔軟性が向上
- ✅ **影響範囲**: デスクトップ版のみ（Web版には影響なし）

**情報源**:

- [PR #683](https://github.com/lichtblick-suite/lichtblick/pull/683)

### 5. 開発プロセスの改善（内部品質向上）

以下は開発者向けの内部改善で、ユーザーが使用する機能には直接影響しません。

#### 5-1. レイアウトマネージャーのテスト追加

**PR #696**: Unit tests for layout manager

**何が変わったか**:
レイアウト管理機能の自動テストを追加し、バグ防止を強化しました。

**変更されたファイル**:

- `packages/suite-base/src/services/LayoutManager/LayoutManager.test.ts` (新規作成)
  - レイアウトの作成、更新、削除の動作テスト
  - エラーハンドリングのテスト
  - 同期処理のテスト

**実装内容**:

- レイアウトの保存・読み込み動作の検証テストを追加
- エラーが発生した場合の動作を確認するテストを追加
- 複数のレイアウトを同時に扱う場合のテストを追加

**情報源**:

- [PR #696](https://github.com/lichtblick-suite/lichtblick/pull/696)

#### 5-2. コード品質チェックの強化

**PR #697**: Updated branches for SonarCloud workflow to include develop

**何が変わったか**:
開発中のコードも自動的に品質チェックされるようになり、問題の早期発見が可能になりました。

**変更されたファイル**:

- `.github/workflows/sonarqube.yml`
  - `develop`ブランチを品質チェックの対象に追加
  - コードの複雑度、重複、潜在的なバグを自動検出

**実装内容**:

- SonarCloudの実行対象ブランチに`develop`を追加
- これにより、開発段階でコード品質の問題を早期に発見できる
- mainブランチにマージする前に問題を修正可能

**情報源**:

- [PR #697](https://github.com/lichtblick-suite/lichtblick/pull/697)

#### 5-3. セキュリティチェックの自動化

**PR #700**: NPM audit in CI workflow

**何が変わったか**:
使用しているライブラリのセキュリティ脆弱性を自動的にチェックする仕組みを導入しました。

**変更されたファイル**:

- `.github/workflows/ci.yml`
  - `npm audit`コマンドをCIパイプラインに追加
  - 依存ライブラリの既知の脆弱性を自動検出

**実装内容**:

- プルリクエストが作成されるたびに自動的にセキュリティチェックを実行
- 脆弱性が見つかった場合は警告を表示
- これにより、セキュリティ問題を含むコードがmainブランチにマージされるのを防止

**情報源**:

- [PR #700](https://github.com/lichtblick-suite/lichtblick/pull/700)

**既存機能への影響**:

- ✅ **影響なし**: ユーザー向け機能に変更はありません
- ✅ **品質向上**: バグやセキュリティ問題の早期発見により、より安全で安定したソフトウェアを提供
- ✅ **開発効率向上**: 問題を早期に発見することで、修正コストを削減

### 6. レイアウト管理システムの内部改善

#### 概要

画面レイアウトを保存・読み込みする仕組みを大幅に改善しました。これは内部アーキテクチャの改善で、現時点ではユーザーが直接目にする機能の変更はありません。

#### 実装内容

**PR #695**: レイアウトAPI基盤の整備

**何が変わったか**:

- レイアウトデータの管理方法を標準化
- サーバーとの通信方法を改善
- データの保存・読み込み速度を最適化

**具体的な実装**:

- レイアウトデータの型定義を整備
- RESTful APIの基盤を整備
- 1,200行以上のテストコードを追加

**既存機能への影響**:

- **⚠️ 現在開発中の複数バージョン対応のマーケットプレイス機能に直接影響はしませんが、設計がどのようになっているのか注意をして今後のマージをする必要がありそうです。**

**詳細情報**:
より技術的な詳細については、コメントで後述します。

**情報源**:

- [PR #695](https://github.com/lichtblick-suite/lichtblick/pull/695)

### 7. ライブラリの更新

**Dependabot による自動更新**: 使用しているライブラリを最新版に更新し、セキュリティパッチや最新機能を適用しました。

**既存機能への影響**:

- ✅ **セキュリティ向上**: 既知の脆弱性が修正されたバージョンに更新
- ✅ **互換性向上**: 最新のライブラリとの互換性を確保

## 📊 このリリースの影響まとめ

### ユーザーに見える変化

**パフォーマンス**:

- ✅ 初期読み込みが高速化（Transform事前読み込みをデフォルトでオフに）
- ✅ 設定変更の反映が約高速化
- ✅ 画像の歪み補正の精度が向上

**使いやすさ**:

- ✅ レイアウトの一括操作（複数選択して削除など）が正常に動作するように修正
- ✅ Mapパネルで大量データを表示する際の速度向上
- ✅ 複数ウィンドウを開いた時のブラウザタブ間の同期機能が正式版に

**注意が必要な変更**:

- ⚠️ Transform treeを使用する場合、設定で「事前読み込み」を手動で有効化する必要があります

### 開発プロセスの改善（ユーザーには直接見えない部分）

- ✅ テストコードを大幅に追加（バグの早期発見）
- ✅ リリース作業を自動化（より早く新機能を提供）
- ✅ セキュリティチェックを強化（より安全なソフトウェア）
- ✅ コード品質チェックを強化（より安定した動作）

## 🔗 関連リンク

- [フルチェンジログ](https://github.com/lichtblick-suite/lichtblick/compare/v1.19.0...v1.20.0)
- [リリースページ](https://github.com/lichtblick-suite/lichtblick/releases/tag/v1.20.0)
- [ソースコード](https://github.com/lichtblick-suite/lichtblick/tree/v1.20.0)
