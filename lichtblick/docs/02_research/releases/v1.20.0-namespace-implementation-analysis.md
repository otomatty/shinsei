# Lichtblick v1.20.0 åå‰ç©ºé–“ï¼ˆNamespaceï¼‰å®Ÿè£… è©³ç´°èª¿æŸ»ãƒ¬ãƒãƒ¼ãƒˆ

## ğŸ“‹ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæƒ…å ±

- **ä½œæˆæ—¥**: 2025å¹´10æœˆ5æ—¥
- **å¯¾è±¡ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: Lichtblick v1.20.0
- **èª¿æŸ»ç¯„å›²**: Layout API ãŠã‚ˆã³æ‹¡å¼µæ©Ÿèƒ½ã‚·ã‚¹ãƒ†ãƒ ã«ãŠã‘ã‚‹åå‰ç©ºé–“ã®å®Ÿè£…
- **é–¢é€£PR**: [#695 - Lichtblick Layouts API](https://github.com/lichtblick-suite/lichtblick/pull/695)

---

## ğŸ¯ æ¦‚è¦

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€Lichtblick v1.20.0ã§å°å…¥ã•ã‚ŒãŸLayout APIã«ãŠã‘ã‚‹**åå‰ç©ºé–“ï¼ˆNamespaceï¼‰**æ©Ÿèƒ½ã¨ã€æ—¢å­˜ã®æ‹¡å¼µæ©Ÿèƒ½ã‚·ã‚¹ãƒ†ãƒ ã§ã®åå‰ç©ºé–“å®Ÿè£…ã«ã¤ã„ã¦ã€å®Ÿéš›ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’èª¿æŸ»ã—ãŸçµæœã‚’ã¾ã¨ã‚ãŸã‚‚ã®ã§ã™ã€‚

### åå‰ç©ºé–“ã¨ã¯

åå‰ç©ºé–“ï¼ˆNamespaceï¼‰ã¯ã€**ãƒ‡ãƒ¼ã‚¿ã‚’è«–ç†çš„ã«åˆ†é›¢ãƒ»æ•´ç†ã™ã‚‹ãŸã‚ã®è­˜åˆ¥å­**ã§ã™ã€‚Lichtblickã§ã¯ä»¥ä¸‹ã®ç›®çš„ã§ä½¿ç”¨ã•ã‚Œã¾ã™ï¼š

- **ãƒ‡ãƒ¼ã‚¿ã®åˆ†é›¢**: ç•°ãªã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»çµ„ç¹”ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ··åœ¨ã•ã›ãªã„
- **è¡çªã®é˜²æ­¢**: åŒã˜IDã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚„æ‹¡å¼µæ©Ÿèƒ½ãŒä¸Šæ›¸ãã•ã‚Œãªã„
- **ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡**: ç‰¹å®šã®åå‰ç©ºé–“ã«ç´ã¥ã„ãŸãƒ‡ãƒ¼ã‚¿ã®ã¿ã‚’æ“ä½œ
- **ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œ**: è¤‡æ•°ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç’°å¢ƒã‚’å˜ä¸€ã‚·ã‚¹ãƒ†ãƒ ã§ç®¡ç†

---

## ğŸ—ï¸ Layout APIã«ãŠã‘ã‚‹åå‰ç©ºé–“å®Ÿè£…

### 1. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```mermaid
flowchart TD
    A[ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹<br/>https://app.lichtblick.com/?namespace=user-123] --> B[StudioApp.tsx<br/>URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰åå‰ç©ºé–“ã‚’æŠ½å‡º<br/>LayoutsAPIã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ]

    B --> C[LayoutsAPI<br/>ãƒªãƒ¢ãƒ¼ãƒˆAPI<br/>namespace: user-123]
    B --> D[IdbLayoutStorage<br/>ãƒ­ãƒ¼ã‚«ãƒ«DB<br/>è¤‡åˆã‚­ãƒ¼: namespace, id]

    C --> E[HTTP API<br/>GET /layouts?namespace=xxx]
    D --> F[IndexedDB<br/>foxglove-layouts]

    style A fill:#e1f5ff
    style B fill:#fff4e1
    style C fill:#ffe1e1
    style D fill:#ffe1e1
    style E fill:#e1ffe1
    style F fill:#e1ffe1
```

### 2. LayoutsAPI ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: `packages/suite-base/src/api/layouts/LayoutsAPI.ts`

```typescript
export class LayoutsAPI implements IRemoteLayoutStorage {
  public readonly namespace: string;
  public readonly baseUrl: string = "layouts";

  /**
   * ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
   * @param namespace - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯çµ„ç¹”ã‚’è­˜åˆ¥ã™ã‚‹åå‰ç©ºé–“
   */
  public constructor(namespace: string) {
    this.namespace = namespace;
  }

  /**
   * ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¸€è¦§ã‚’å–å¾—
   * HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«åå‰ç©ºé–“ã‚’å«ã‚ã‚‹
   */
  public async getLayouts(): Promise<RemoteLayout[]> {
    const { data: layoutData } = await HttpService.get<LayoutApiResponse[]>(this.baseUrl, {
      namespace: this.namespace, // â† åå‰ç©ºé–“ã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦é€ä¿¡
    });

    // ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆç”¨ã®å‹ã«å¤‰æ›
    return layoutData.map((layout) => ({
      id: layout.layoutId,
      externalId: layout.id,
      name: layout.name,
      data: layout.data,
      permission: layout.permission,
      savedAt: layout.updatedBy as ISO8601Timestamp | undefined,
    }));
  }

  /**
   * æ–°è¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä¿å­˜
   */
  public async saveNewLayout(params: SaveNewLayoutParams): Promise<RemoteLayout> {
    const requestPayload: CreateLayoutRequest = {
      layoutId: params.id,
      namespace: this.namespace, // â† åå‰ç©ºé–“ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã«å«ã‚ã‚‹
      data: params.data,
      name: params.name,
      permission: params.permission,
    };

    const { data: layoutData } = await HttpService.post<LayoutApiResponse>(
      this.baseUrl,
      requestPayload,
    );

    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å¤‰æ›ã—ã¦è¿”ã™
    return {
      id: layoutData.layoutId,
      externalId: layoutData.id,
      name: layoutData.name,
      data: layoutData.data,
      permission: layoutData.permission,
      savedAt: layoutData.updatedBy as ISO8601Timestamp | undefined,
    };
  }

  /**
   * ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ›´æ–°
   */
  public async updateLayout(params: UpdateLayoutRequest): Promise<UpdateLayoutResponse> {
    const requestBody: UpdateLayoutRequestBody = {
      name: params.name,
      data: params.data,
      permission: params.permission,
    };

    // åå‰ç©ºé–“ã¯æ—¢ã«ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§è¨­å®šã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€
    // ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¯externalIdã®ã¿ã§æŒ‡å®š
    const { data: layoutData } = await HttpService.put<LayoutApiResponse>(
      `${this.baseUrl}/${params.externalId}`,
      requestBody,
    );

    const newLayout: RemoteLayout = {
      id: layoutData.layoutId,
      externalId: layoutData.id,
      name: layoutData.name,
      data: layoutData.data,
      permission: layoutData.permission,
      savedAt: layoutData.updatedBy as ISO8601Timestamp | undefined,
    };

    return { status: "success", newLayout };
  }

  /**
   * ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å‰Šé™¤
   */
  public async deleteLayout(id: string): Promise<boolean> {
    const deletedLayout = await HttpService.delete<RemoteLayout | undefined>(
      `${this.baseUrl}/${id}`,
    );
    return deletedLayout.data != undefined;
  }
}
```

### 3. StudioAppã§ã®åå‰ç©ºé–“ã®åˆæœŸåŒ–

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: `packages/suite-base/src/StudioApp.tsx`

```typescript
export default function StudioApp(props: StudioAppProps): React.JSX.Element {
  // ... ä»–ã®ã‚³ãƒ¼ãƒ‰

  // URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰åå‰ç©ºé–“ã‚’å–å¾—
  const url = new URL(window.location.href);
  const namespace = url.searchParams.get("namespace");

  // åå‰ç©ºé–“ã¨APIã®URLãŒä¸¡æ–¹è¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿
  // ãƒªãƒ¢ãƒ¼ãƒˆãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½œæˆ
  const remoteLayoutStorage = useMemo(() => {
    if (namespace && APP_CONFIG.apiUrl) {
      return new LayoutsAPI(namespace);
    }
    return undefined;
  }, [namespace]);

  // ãƒªãƒ¢ãƒ¼ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã«è¿½åŠ 
  if (remoteLayoutStorage) {
    providers.unshift(
      <RemoteLayoutStorageContext.Provider value={remoteLayoutStorage} />
    );
  }

  // ... ä»–ã®ã‚³ãƒ¼ãƒ‰
}
```

**ä½¿ç”¨ä¾‹**:

```
# ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ºæœ‰ã®åå‰ç©ºé–“
https://app.lichtblick.com/?namespace=user-alice-123

# çµ„ç¹”ã®åå‰ç©ºé–“
https://app.lichtblick.com/?namespace=org-acme-corp

# ãƒãƒ¼ãƒ ã®åå‰ç©ºé–“
https://app.lichtblick.com/?namespace=team-engineering
```

### 4. IndexedDBã§ã®åå‰ç©ºé–“ç®¡ç†

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: `packages/suite-base/src/IdbLayoutStorage.ts`

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒ

```typescript
/**
 * IndexedDBã®ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
 *
 * ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯åå‰ç©ºé–“ã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆIDã®è¤‡åˆã‚­ãƒ¼ã§ç®¡ç†ã•ã‚Œã‚‹
 */
interface LayoutsDB extends IDB.DBSchema {
  layouts: {
    /** è¤‡åˆãƒ—ãƒ©ã‚¤ãƒãƒªã‚­ãƒ¼: [åå‰ç©ºé–“, ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆID] */
    key: [namespace: string, id: LayoutID];

    /** ä¿å­˜ã•ã‚Œã‚‹å€¤ */
    value: {
      /** ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒå±ã™ã‚‹åå‰ç©ºé–“ */
      namespace: string;
      /** ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿æœ¬ä½“ */
      layout: Layout;
    };

    /** æ¤œç´¢ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ */
    indexes: {
      /** åå‰ç©ºé–“ã§ã®æ¤œç´¢ã‚’é«˜é€ŸåŒ–ã™ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ */
      namespace: string;
    };
  };
}
```

#### å®Ÿè£…

````typescript
export class IdbLayoutStorage implements ILayoutStorage {
  /**
   * IndexedDBãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¸ã®æ¥ç¶š
   */
  #db = IDB.openDB<LayoutsDB>(DATABASE_NAME, 1, {
    upgrade(db) {
      // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚¹ãƒˆã‚¢ã‚’ä½œæˆ
      const store = db.createObjectStore(OBJECT_STORE_NAME, {
        // è¤‡åˆã‚­ãƒ¼[namespace, layout.id]ã‚’æŒ‡å®š
        keyPath: ["namespace", "layout.id"],
      });

      // åå‰ç©ºé–“ã§ã®é«˜é€Ÿæ¤œç´¢ã®ãŸã‚ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
      store.createIndex("namespace", "namespace");
    },
  });

  /**
   * æŒ‡å®šã•ã‚ŒãŸåå‰ç©ºé–“ã®ã™ã¹ã¦ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å–å¾—
   *
   * @param namespace - ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®åå‰ç©ºé–“
   * @returns ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®é…åˆ—
   *
   * @example
   * ```typescript
   * // å€‹äººãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å–å¾—
   * const personalLayouts = await storage.list('user-alice-123');
   *
   * // çµ„ç¹”ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å–å¾—
   * const orgLayouts = await storage.list('org-acme-corp');
   * ```
   */
  public async list(namespace: string): Promise<readonly Layout[]> {
    const results: Layout[] = [];

    // åå‰ç©ºé–“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨ã—ã¦åŠ¹ç‡çš„ã«æ¤œç´¢
    const records = await (
      await this.#db
    ).getAllFromIndex(OBJECT_STORE_NAME, "namespace", namespace);

    // å„ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç§»è¡Œå‡¦ç†ã‚’é€šã—ã¦ã‹ã‚‰çµæœã«è¿½åŠ 
    for (const record of records) {
      try {
        results.push(migrateLayout(record.layout));
      } catch (err: unknown) {
        log.error(err);
      }
    }

    return results;
  }

  /**
   * æŒ‡å®šã•ã‚ŒãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å–å¾—
   *
   * @param namespace - ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®åå‰ç©ºé–“
   * @param id - ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆID
   * @returns ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã€å­˜åœ¨ã—ãªã„å ´åˆã¯`undefined`
   *
   * @example
   * ```typescript
   * const layout = await storage.get('user-alice-123', 'my-layout-id');
   * if (layout) {
   *   console.log('ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå:', layout.name);
   * }
   * ```
   */
  public async get(namespace: string, id: LayoutID): Promise<Layout | undefined> {
    // è¤‡åˆã‚­ãƒ¼[namespace, id]ã§ç›´æ¥å–å¾—
    const record = await (await this.#db).get(OBJECT_STORE_NAME, [namespace, id]);
    return record == undefined ? undefined : migrateLayout(record.layout);
  }

  /**
   * ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä¿å­˜ï¼ˆæ–°è¦ä½œæˆã¾ãŸã¯æ›´æ–°ï¼‰
   *
   * @param namespace - ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®åå‰ç©ºé–“
   * @param layout - ä¿å­˜ã™ã‚‹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
   * @returns ä¿å­˜ã•ã‚ŒãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
   *
   * @example
   * ```typescript
   * const newLayout = {
   *   id: 'my-layout',
   *   name: 'My Custom Layout',
   *   data: { /* ... */ }
   * };
   * await storage.put('user-alice-123', newLayout);
   * ```
   */
  public async put(namespace: string, layout: Layout): Promise<Layout> {
    // åå‰ç©ºé–“ã¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ãƒšã‚¢ã§ä¿å­˜
    await (await this.#db).put(OBJECT_STORE_NAME, { namespace, layout });
    return layout;
  }

  /**
   * ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å‰Šé™¤
   *
   * @param namespace - ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®åå‰ç©ºé–“
   * @param id - å‰Šé™¤ã™ã‚‹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆID
   *
   * @example
   * ```typescript
   * await storage.delete('user-alice-123', 'unused-layout-id');
   * ```
   */
  public async delete(namespace: string, id: LayoutID): Promise<void> {
    // è¤‡åˆã‚­ãƒ¼[namespace, id]ã§å‰Šé™¤
    await (await this.#db).delete(OBJECT_STORE_NAME, [namespace, id]);
  }

  /**
   * å¤ã„åå‰ç©ºé–“ãªã—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ–°ã—ã„åå‰ç©ºé–“ã«ç§»è¡Œ
   *
   * @param namespace - ç§»è¡Œå…ˆã®åå‰ç©ºé–“
   *
   * @remarks
   * v1.20.0ä»¥å‰ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‹ã‚‰ç§»è¡Œã™ã‚‹éš›ã«ä½¿ç”¨
   */
  public async migrateUnnamespacedLayouts(namespace: string): Promise<void> {
    // å®Ÿè£…ã®è©³ç´°ã¯çœç•¥
    // å¤ã„LocalStorageã‹ã‚‰IndexedDBã¸ã®ç§»è¡Œå‡¦ç†
  }
}
````

### 5. ILayoutStorage ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: `packages/suite-base/src/services/ILayoutStorage.ts`

```typescript
/**
 * ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®æŠ½è±¡ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
 *
 * ã™ã¹ã¦ã®ãƒ¡ã‚½ãƒƒãƒ‰ã¯åå‰ç©ºé–“ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦å—ã‘å–ã‚‹
 */
export interface ILayoutStorage {
  /**
   * æŒ‡å®šã•ã‚ŒãŸåå‰ç©ºé–“ã®ã™ã¹ã¦ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä¸€è¦§è¡¨ç¤º
   */
  list(namespace: string): Promise<readonly Layout[]>;

  /**
   * æŒ‡å®šã•ã‚ŒãŸåå‰ç©ºé–“ã¨IDã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å–å¾—
   */
  get(namespace: string, id: LayoutID): Promise<Layout | undefined>;

  /**
   * æŒ‡å®šã•ã‚ŒãŸåå‰ç©ºé–“ã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä¿å­˜
   */
  put(namespace: string, layout: Layout): Promise<Layout>;

  /**
   * æŒ‡å®šã•ã‚ŒãŸåå‰ç©ºé–“ã‹ã‚‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å‰Šé™¤
   */
  delete(namespace: string, id: LayoutID): Promise<void>;

  /**
   * åå‰ç©ºé–“ãªã—ã®ãƒ¬ã‚¬ã‚·ãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ–°ã—ã„åå‰ç©ºé–“ã«ç§»è¡Œ
   * ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰
   */
  migrateUnnamespacedLayouts?(namespace: string): Promise<void>;
}
```

### 6. IRemoteLayoutStorage ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: `packages/suite-base/src/services/IRemoteLayoutStorage.ts`

```typescript
/**
 * ãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã•ã‚ŒãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ç®¡ç†ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
 */
export interface IRemoteLayoutStorage {
  /**
   * ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¯¾å¿œã™ã‚‹åå‰ç©ºé–“
   *
   * @remarks
   * LayoutManagerãŒãƒ‡ã‚£ã‚¹ã‚¯ä¸Šã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ•´ç†ã™ã‚‹ãŸã‚ã«ä½¿ç”¨
   */
  readonly namespace: string;

  /**
   * ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¸€è¦§ã‚’å–å¾—
   */
  getLayouts: () => Promise<readonly RemoteLayout[]>;

  /**
   * ç‰¹å®šã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å–å¾—
   */
  getLayout: (id: LayoutID) => Promise<RemoteLayout | undefined>;

  /**
   * æ–°è¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä¿å­˜
   */
  saveNewLayout: (params: SaveNewLayoutParams) => Promise<RemoteLayout>;

  /**
   * æ—¢å­˜ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ›´æ–°
   */
  updateLayout: (params: UpdateLayoutRequest) => Promise<UpdateLayoutResponse>;

  /**
   * ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å‰Šé™¤
   * @returns ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒå­˜åœ¨ã—ã¦å‰Šé™¤ã•ã‚ŒãŸå ´åˆtrueã€å­˜åœ¨ã—ãªã‹ã£ãŸå ´åˆfalse
   */
  deleteLayout: (id: string) => Promise<boolean>;
}
```

---

## ğŸ”Œ æ‹¡å¼µæ©Ÿèƒ½ã‚·ã‚¹ãƒ†ãƒ ã«ãŠã‘ã‚‹åå‰ç©ºé–“å®Ÿè£…

### 1. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```mermaid
flowchart TD
    A[æ‹¡å¼µæ©Ÿèƒ½ãƒ­ãƒ¼ãƒ€ãƒ¼ã®åˆæœŸåŒ–] --> B[new IdbExtensionLoader local]
    A --> C[new IdbExtensionLoader official]

    B --> D[IdbExtensionStorage<br/>åå‰ç©ºé–“ã”ã¨ã«åˆ¥ã®IndexedDBãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆ]
    C --> D

    D --> E[IndexedDB<br/>lichtblick-extensions-local]
    D --> F[IndexedDB<br/>lichtblick-extensions-official]

    style A fill:#e1f5ff
    style B fill:#ffe1e1
    style C fill:#ffe1e1
    style D fill:#fff4e1
    style E fill:#e1ffe1
    style F fill:#e1ffe1
```

### 2. IdbExtensionStorage ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: `packages/suite-base/src/services/extension/IdbExtensionStorage.ts`

```typescript
/**
 * IndexedDBã‚¹ã‚­ãƒ¼ãƒå®šç¾©
 */
interface ExtensionsDB extends IDB.DBSchema {
  metadata: {
    key: string;
    value: ExtensionInfo;
  };
  extensions: {
    key: string;
    value: StoredExtension;
  };
}

/**
 * æ‹¡å¼µæ©Ÿèƒ½ã‚’IndexedDBã«ä¿å­˜ã™ã‚‹ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®Ÿè£…
 *
 * ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨ã¯ç•°ãªã‚Šã€åå‰ç©ºé–“ã”ã¨ã«åˆ¥ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆ
 */
export class IdbExtensionStorage implements IExtensionStorage {
  #db: Promise<IDB.IDBPDatabase<ExtensionsDB>>;
  public namespace: string;

  /**
   * ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
   * @param namespace - æ‹¡å¼µæ©Ÿèƒ½ã®åå‰ç©ºé–“ï¼ˆä¾‹: "local", "official", "community"ï¼‰
   */
  public constructor(namespace: string) {
    this.namespace = namespace;

    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åã«åå‰ç©ºé–“ã‚’çµ„ã¿è¾¼ã‚€
    // ä¾‹: "lichtblick-extensions-local", "lichtblick-extensions-official"
    this.#db = IDB.openDB<ExtensionsDB>([DATABASE_BASE_NAME, namespace].join("-"), 1, {
      upgrade: (db) => {
        log.debug("Creating extension object stores");

        // ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚¹ãƒˆã‚¢
        db.createObjectStore(METADATA_STORE_NAME, {
          keyPath: "id",
        });

        // æ‹¡å¼µæ©Ÿèƒ½ã‚¹ãƒˆã‚¢
        db.createObjectStore(EXTENSION_STORE_NAME, {
          keyPath: "info.id",
        });
      },
    });
  }

  /**
   * ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿æ‹¡å¼µæ©Ÿèƒ½ã®ä¸€è¦§ã‚’å–å¾—
   */
  public async list(): Promise<ExtensionInfo[]> {
    const start = performance.now();
    const records = await (await this.#db).getAll(METADATA_STORE_NAME);

    log.debug(
      `Loaded ${records.length} extensions in`,
      (performance.now() - start).toFixed(1),
      "ms",
    );

    return records;
  }

  /**
   * ç‰¹å®šã®æ‹¡å¼µæ©Ÿèƒ½ã‚’å–å¾—
   */
  public async get(id: string): Promise<undefined | StoredExtension> {
    const start = performance.now();
    const extension = await (await this.#db).get(EXTENSION_STORE_NAME, id);
    log.debug("Getting extension", id, "took", (performance.now() - start).toFixed(1), "ms");
    return extension;
  }

  /**
   * æ‹¡å¼µæ©Ÿèƒ½ã‚’ä¿å­˜
   */
  public async put(extension: StoredExtension): Promise<StoredExtension> {
    const start = performance.now();

    const transaction = (await this.#db).transaction(
      [METADATA_STORE_NAME, EXTENSION_STORE_NAME],
      "readwrite",
    );

    await Promise.all([
      transaction.db.put(METADATA_STORE_NAME, extension.info),
      transaction.db.put(EXTENSION_STORE_NAME, extension),
      transaction.done,
    ]);

    log.debug(
      "Stored extension",
      { extension },
      "in",
      (performance.now() - start).toFixed(1),
      "ms",
    );

    return extension;
  }

  /**
   * æ‹¡å¼µæ©Ÿèƒ½ã‚’å‰Šé™¤
   */
  public async delete(id: string): Promise<void> {
    const start = performance.now();

    const transaction = (await this.#db).transaction(
      [METADATA_STORE_NAME, EXTENSION_STORE_NAME],
      "readwrite",
    );

    await Promise.all([
      transaction.db.delete(METADATA_STORE_NAME, id),
      transaction.db.delete(EXTENSION_STORE_NAME, id),
      transaction.done,
    ]);

    log.debug("Deleted extension", id, "in", (performance.now() - start).toFixed(1), "ms");
  }
}
```

### 3. IdbExtensionLoader ã‚¯ãƒ©ã‚¹ã®å®Ÿè£…

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: `packages/suite-base/src/services/extension/IdbExtensionLoader.ts`

```typescript
/**
 * IndexedDBã‹ã‚‰æ‹¡å¼µæ©Ÿèƒ½ã‚’ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ­ãƒ¼ãƒ€ãƒ¼å®Ÿè£…
 */
export class IdbExtensionLoader implements IExtensionLoader {
  readonly #storage: IExtensionStorage;
  public readonly namespace: Namespace;
  public readonly type: TypeExtensionLoader = "browser";

  /**
   * ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
   * @param namespace - æ‹¡å¼µæ©Ÿèƒ½ã®åå‰ç©ºé–“
   */
  public constructor(namespace: Namespace) {
    this.namespace = namespace;
    this.#storage = new IdbExtensionStorage(namespace);
  }

  /**
   * ç‰¹å®šã®æ‹¡å¼µæ©Ÿèƒ½ã‚’å–å¾—
   */
  public async getExtension(id: string): Promise<ExtensionInfo | undefined> {
    log.debug("[IndexedDB] Get extension", id);
    const storedExtension = await this.#storage.get(id);
    return storedExtension?.info;
  }

  /**
   * ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿æ‹¡å¼µæ©Ÿèƒ½ã®ä¸€è¦§ã‚’å–å¾—
   */
  public async getExtensions(): Promise<ExtensionInfo[]> {
    log.debug("[IndexedDB] Listing extensions");
    return await this.#storage.list();
  }

  /**
   * æ‹¡å¼µæ©Ÿèƒ½ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒ­ãƒ¼ãƒ‰
   */
  public async loadExtension(id: string): Promise<LoadedExtension> {
    log.debug("[IndexedDB] Load extension", id);
    const storedExtension = await this.#storage.get(id);

    if (!storedExtension) {
      throw new Error(`Extension ${id} not found`);
    }

    return {
      info: storedExtension.info,
      sourceCode: new TextDecoder().decode(storedExtension.sourceCode),
    };
  }

  /**
   * æ‹¡å¼µæ©Ÿèƒ½ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   */
  public async installExtension({
    foxeFileData,
    externalId,
  }: InstallExtensionProps): Promise<ExtensionInfo> {
    // æ‹¡å¼µæ©Ÿèƒ½ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’è§£æ
    const rawInfo = parseExtensionInfo(foxeFileData);

    // æ‹¡å¼µæ©Ÿèƒ½IDã‚’ç”Ÿæˆ
    const baseId = `${normalizedPublisher}.${rawInfo.name}`;

    // æ‹¡å¼µæ©Ÿèƒ½æƒ…å ±ã‚’ä½œæˆ
    const info: ExtensionInfo = {
      ...rawInfo,
      id: baseId,
      namespace: this.namespace, // â† åå‰ç©ºé–“ã‚’è¨­å®š
      qualifiedName: baseId,
    };

    // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    await this.#storage.put({
      info,
      sourceCode: extractSourceCode(foxeFileData),
      externalId,
    });

    log.info(`[IndexedDB] Installed extension ${info.id} in namespace ${this.namespace}`);

    return info;
  }

  /**
   * æ‹¡å¼µæ©Ÿèƒ½ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   */
  public async uninstallExtension(id: string): Promise<void> {
    log.debug("[IndexedDB] Uninstall extension", id);
    await this.#storage.delete(id);
  }
}
```

### 4. ExtensionInfo å‹ã§ã®åå‰ç©ºé–“

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: `packages/suite-base/src/types/Extensions.ts`

```typescript
/**
 * æ‹¡å¼µæ©Ÿèƒ½ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
 */
export type ExtensionInfo = {
  /** æ‹¡å¼µæ©Ÿèƒ½ã®ä¸€æ„è­˜åˆ¥å­ */
  id: string;

  /** æ‹¡å¼µæ©Ÿèƒ½ã®èª¬æ˜ */
  description: string;

  /** æ‹¡å¼µæ©Ÿèƒ½ã®è¡¨ç¤ºå */
  displayName: string;

  /** æ‹¡å¼µæ©Ÿèƒ½ã®ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸URL */
  homepage: string;

  /** æ¤œç´¢ç”¨ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é…åˆ— */
  keywords: string[];

  /** ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æƒ…å ± */
  license: string;

  /** æ‹¡å¼µæ©Ÿèƒ½ã®åå‰ */
  name: string;

  /**
   * åå‰ç©ºé–“ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ï¼‰
   *
   * @remarks
   * - "local": ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸæ‹¡å¼µæ©Ÿèƒ½
   * - "official": å…¬å¼ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã‹ã‚‰ã®æ‹¡å¼µæ©Ÿèƒ½
   * - "community": ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æä¾›ã®æ‹¡å¼µæ©Ÿèƒ½
   * - ã‚«ã‚¹ã‚¿ãƒ å€¤: çµ„ç¹”å›ºæœ‰ã®åå‰ç©ºé–“
   */
  namespace?: Namespace;

  /** ç™ºè¡Œè€…å */
  publisher: string;

  /** å®Œå…¨ä¿®é£¾åï¼ˆé€šå¸¸ã¯ "publisher.name" ã®å½¢å¼ï¼‰ */
  qualifiedName: string;

  /** ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ–‡å­—åˆ—ï¼ˆã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°æ¨å¥¨ï¼‰ */
  version: string;

  /** READMEæ–‡æ›¸ï¼ˆMarkdownå½¢å¼ï¼‰ */
  readme?: string;

  /** å¤‰æ›´å±¥æ­´ï¼ˆMarkdownå½¢å¼ï¼‰ */
  changelog?: string;
};
```

### 5. ExtensionsAPI ã§ã®åå‰ç©ºé–“

**ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹**: `packages/suite-base/src/api/extensions/ExtensionsAPI.ts`

```typescript
/**
 * ãƒªãƒ¢ãƒ¼ãƒˆæ‹¡å¼µæ©Ÿèƒ½APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
 */
class ExtensionsAPI implements IExtensionAPI {
  public readonly remoteNamespace: string;
  private readonly extensionEndpoint = "extensions";

  /**
   * ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿
   * @param namespace - ãƒªãƒ¢ãƒ¼ãƒˆAPIç”¨ã®åå‰ç©ºé–“
   */
  public constructor(namespace: string) {
    this.remoteNamespace = namespace;
  }

  /**
   * ãƒªãƒ¢ãƒ¼ãƒˆã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ‹¡å¼µæ©Ÿèƒ½ä¸€è¦§ã‚’å–å¾—
   */
  public async list(): Promise<ExtensionInfo[]> {
    const { data } = await HttpService.get<ExtensionInfo[]>(this.extensionEndpoint, {
      namespace: this.remoteNamespace, // â† åå‰ç©ºé–“ã‚’ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§é€ä¿¡
    });
    return data;
  }

  /**
   * ç‰¹å®šã®æ‹¡å¼µæ©Ÿèƒ½ã‚’å–å¾—
   */
  public async get(id: string): Promise<StoredExtension | undefined> {
    const { data } = await HttpService.get<StoredExtension>(`${this.extensionEndpoint}/${id}`, {
      namespace: this.remoteNamespace,
    });
    return data;
  }

  /**
   * æ‹¡å¼µæ©Ÿèƒ½ã‚’ä½œæˆã¾ãŸã¯æ›´æ–°
   */
  public async createOrUpdate(extension: ExtensionInfoSlug, file: File): Promise<StoredExtension> {
    const formData = new FormData();
    formData.append("file", file);
    formData.append("namespace", this.remoteNamespace);

    const { data } = await HttpService.post<StoredExtension>(this.extensionEndpoint, formData);
    return data;
  }

  /**
   * æ‹¡å¼µæ©Ÿèƒ½ã‚’å‰Šé™¤
   */
  public async remove(id: string): Promise<boolean> {
    const { data } = await HttpService.delete<{ success: boolean }>(
      `${this.extensionEndpoint}/${id}`,
      {
        namespace: this.remoteNamespace,
      },
    );
    return data.success;
  }
}
```

---

## ğŸ”„ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨æ‹¡å¼µæ©Ÿèƒ½ã®åå‰ç©ºé–“ã®æ¯”è¼ƒ

### å…±é€šç‚¹

| ç‰¹å¾´              | ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ                        | æ‹¡å¼µæ©Ÿèƒ½                             |
| ----------------- | --------------------------------- | ------------------------------------ |
| **ãƒ‡ãƒ¼ã‚¿åˆ†é›¢**    | âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’åˆ†é›¢ | âœ… åå‰ç©ºé–“ã”ã¨ã«æ‹¡å¼µæ©Ÿèƒ½ã‚’åˆ†é›¢      |
| **IndexedDBä½¿ç”¨** | âœ… `foxglove-layouts`             | âœ… `foxglove-extensions-{namespace}` |
| **HTTP APIçµ±åˆ**  | âœ… ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§é€ä¿¡         | âœ… ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§é€ä¿¡            |
| **å‹å®‰å…¨æ€§**      | âœ… TypeScriptã§å³å¯†ã«å‹ä»˜ã‘       | âœ… TypeScriptã§å³å¯†ã«å‹ä»˜ã‘          |

### ç›¸é•ç‚¹

| é …ç›®                 | ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ                             | æ‹¡å¼µæ©Ÿèƒ½                         |
| -------------------- | -------------------------------------- | -------------------------------- |
| **åå‰ç©ºé–“ã®å–å¾—å…ƒ** | URLã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (`?namespace=xxx`) | ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¾ãŸã¯å›ºå®šå€¤         |
| **å€¤ã®ä¾‹**           | `user-alice-123`, `org-acme-corp`      | `local`, `official`, `community` |
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ** | å˜ä¸€DB + è¤‡åˆã‚­ãƒ¼ `[namespace, id]`    | åå‰ç©ºé–“ã”ã¨ã«åˆ¥DB               |
| **ä¸»ãªç›®çš„**         | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»çµ„ç¹”ã®è­˜åˆ¥                   | ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ƒã®åˆ†é¡             |
| **å‹•çš„/é™çš„**        | å‹•çš„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦å¤‰ã‚ã‚‹ï¼‰         | é™çš„ï¼ˆå›ºå®šå€¤ãŒä¸€èˆ¬çš„ï¼‰           |
| **ç§»è¡Œæ©Ÿèƒ½**         | `migrateUnnamespacedLayouts()` ã‚ã‚Š    | ãªã—                             |
| **æ¨©é™ç®¡ç†**         | `LayoutPermission` ã§ç®¡ç†              | åå‰ç©ºé–“ã«ã‚ˆã‚‹åˆ†é¡ã®ã¿           |

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ã®é•ã„

#### ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```mermaid
graph TB
    DB[IndexedDB: foxglove-layouts]

    DB --> Store[Object Store: layouts]

    Store --> L1["[namespace: user-alice, id: layout-1] â†’ Layout"]
    Store --> L2["[namespace: user-alice, id: layout-2] â†’ Layout"]
    Store --> L3["[namespace: user-bob, id: layout-1] â†’ Layout"]
    Store --> L4["[namespace: org-acme, id: layout-1] â†’ Layout"]

    style DB fill:#e1f5ff
    style Store fill:#fff4e1
    style L1 fill:#e1ffe1
    style L2 fill:#e1ffe1
    style L3 fill:#e1ffe1
    style L4 fill:#e1ffe1
```

#### æ‹¡å¼µæ©Ÿèƒ½

```mermaid
graph TB
    subgraph DB1[IndexedDB: lichtblick-extensions-local]
        Store1[Object Store: extensions]
        Store1 --> E1["id: publisher.extension-1 â†’ Extension"]
        Store1 --> E2["id: publisher.extension-2 â†’ Extension"]
    end

    subgraph DB2[IndexedDB: lichtblick-extensions-official]
        Store2[Object Store: extensions]
        Store2 --> E3["id: official.panel-3d â†’ Extension"]
        Store2 --> E4["id: official.data-source â†’ Extension"]
    end

    style DB1 fill:#e1f5ff
    style DB2 fill:#e1f5ff
    style Store1 fill:#fff4e1
    style Store2 fill:#fff4e1
    style E1 fill:#e1ffe1
    style E2 fill:#e1ffe1
    style E3 fill:#e1ffe1
    style E4 fill:#e1ffe1
```

---

## ğŸ¯ åå‰ç©ºé–“ã§å®Ÿç¾ã§ãã‚‹ã“ã¨

### 1. ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼ç’°å¢ƒ

```typescript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
const userALayouts = await layoutStorage.list("user-alice-123");
console.log(userALayouts.length); // 5

// ãƒ¦ãƒ¼ã‚¶ãƒ¼Bã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
const userBLayouts = await layoutStorage.list("user-bob-456");
console.log(userBLayouts.length); // 3

// äº’ã„ã«å¹²æ¸‰ã—ãªã„
// ãƒ¦ãƒ¼ã‚¶ãƒ¼Aã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼Bã¯åŒã˜ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆIDã‚’ä½¿ç”¨ã§ãã‚‹
```

### 2. çµ„ç¹”å˜ä½ã®ç®¡ç†

```typescript
// çµ„ç¹”Aã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
const orgALayouts = await layoutStorage.list("org-acme-corp");

// çµ„ç¹”Bã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
const orgBLayouts = await layoutStorage.list("org-beta-inc");

// çµ„ç¹”å…±æœ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨å€‹äººãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ä½µç”¨
const allLayouts = [
  ...(await layoutStorage.list("user-alice-123")), // å€‹äººç”¨
  ...(await layoutStorage.list("org-acme-corp")), // çµ„ç¹”å…±æœ‰
];
```

### 3. ç’°å¢ƒåˆ†é›¢ï¼ˆé–‹ç™ºãƒ»ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ãƒ»æœ¬ç•ªï¼‰

```typescript
// é–‹ç™ºç’°å¢ƒ
const devLayouts = await layoutStorage.list("env-development");

// ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒ
const stagingLayouts = await layoutStorage.list("env-staging");

// æœ¬ç•ªç’°å¢ƒ
const prodLayouts = await layoutStorage.list("env-production");
```

### 4. æ‹¡å¼µæ©Ÿèƒ½ã®åˆ†é¡

```typescript
// ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸæ‹¡å¼µæ©Ÿèƒ½
const localExtensions = await new IdbExtensionLoader("local").getExtensions();

// å…¬å¼ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã®æ‹¡å¼µæ©Ÿèƒ½
const officialExtensions = await new IdbExtensionLoader("official").getExtensions();

// ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®æ‹¡å¼µæ©Ÿèƒ½
const thirdPartyExtensions = await new IdbExtensionLoader("community").getExtensions();
```

### 5. ãƒãƒ¼ãƒ åˆ¥ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç®¡ç†

```typescript
// ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ãƒãƒ¼ãƒ 
const engLayouts = await layoutStorage.list("team-engineering");

// ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚¨ãƒ³ã‚¹ãƒãƒ¼ãƒ 
const dsLayouts = await layoutStorage.list("team-data-science");

// å“è³ªä¿è¨¼ãƒãƒ¼ãƒ 
const qaLayouts = await layoutStorage.list("team-qa");
```

---

## ğŸ’¡ å®Ÿè£…ä¾‹: åå‰ç©ºé–“ã‚’ä½¿ã£ãŸå®Ÿéš›ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼

### ã‚·ãƒŠãƒªã‚ª1: ä¼æ¥­ã§ã®Lichtblickåˆ©ç”¨

```typescript
/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
 */
class UserSession {
  private userId: string;
  private organizationId: string;
  private userNamespace: string;
  private orgNamespace: string;

  constructor(userId: string, organizationId: string) {
    this.userId = userId;
    this.organizationId = organizationId;

    // åå‰ç©ºé–“ã‚’ç”Ÿæˆ
    this.userNamespace = `user-${userId}`;
    this.orgNamespace = `org-${organizationId}`;
  }

  /**
   * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
   */
  public launchApp(): void {
    // URLã«åå‰ç©ºé–“ã‚’å«ã‚ã¦ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’èµ·å‹•
    const appUrl = new URL("https://app.lichtblick.com");
    appUrl.searchParams.set("namespace", this.userNamespace);

    window.location.href = appUrl.toString();
    // â†’ https://app.lichtblick.com/?namespace=user-alice-123
  }

  /**
   * ãƒ¦ãƒ¼ã‚¶ãƒ¼å°‚ç”¨ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å–å¾—
   */
  public async getUserLayouts(): Promise<Layout[]> {
    const layoutManager = getLayoutManager();
    return await layoutManager.getLayouts();
    // â†’ è‡ªå‹•çš„ã«userNamespaceã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ã¿å–å¾—
  }

  /**
   * çµ„ç¹”å…±æœ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å–å¾—
   */
  public async getOrganizationLayouts(): Promise<Layout[]> {
    const layoutStorage = getLayoutStorage();
    return await layoutStorage.list(this.orgNamespace);
  }

  /**
   * ã™ã¹ã¦ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å–å¾—ï¼ˆå€‹äºº+çµ„ç¹”ï¼‰
   */
  public async getAllLayouts(): Promise<Layout[]> {
    const [userLayouts, orgLayouts] = await Promise.all([
      this.getUserLayouts(),
      this.getOrganizationLayouts(),
    ]);

    return [...userLayouts, ...orgLayouts];
  }

  /**
   * æ–°è¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä½œæˆ
   */
  public async createLayout(name: string, data: LayoutData): Promise<Layout> {
    const layoutManager = getLayoutManager();

    return await layoutManager.saveNewLayout({
      name,
      data,
      permission: "CREATOR_WRITE",
    });
    // â†’ è‡ªå‹•çš„ã«userNamespaceé…ä¸‹ã«ä¿å­˜ã•ã‚Œã‚‹
  }
}

/**
 * ä½¿ç”¨ä¾‹
 */
async function main() {
  // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
  const session = new UserSession("alice-123", "acme-corp");

  // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•
  session.launchApp();

  // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç®¡ç†
  const userLayouts = await session.getUserLayouts();
  const orgLayouts = await session.getOrganizationLayouts();

  console.log(`å€‹äººãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ: ${userLayouts.length}å€‹`);
  console.log(`çµ„ç¹”ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ: ${orgLayouts.length}å€‹`);
}
```

### ã‚·ãƒŠãƒªã‚ª2: æ‹¡å¼µæ©Ÿèƒ½ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¨åˆ†é¡

```typescript
/**
 * æ‹¡å¼µæ©Ÿèƒ½ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
 */
class ExtensionManager {
  private localLoader: IExtensionLoader;
  private officialLoader: IExtensionLoader;
  private communityLoader: IExtensionLoader;

  constructor() {
    // å„åå‰ç©ºé–“ç”¨ã®ãƒ­ãƒ¼ãƒ€ãƒ¼ã‚’åˆæœŸåŒ–
    this.localLoader = new IdbExtensionLoader("local");
    this.officialLoader = new IdbExtensionLoader("official");
    this.communityLoader = new IdbExtensionLoader("community");
  }

  /**
   * ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æ‹¡å¼µæ©Ÿèƒ½ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   */
  public async installFromFile(file: File): Promise<ExtensionInfo> {
    const fileData = new Uint8Array(await file.arrayBuffer());

    return await this.localLoader.installExtension({
      foxeFileData: fileData,
    });
    // â†’ "local" åå‰ç©ºé–“ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  }

  /**
   * å…¬å¼ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   */
  public async installFromMarketplace(extensionId: string): Promise<ExtensionInfo> {
    // ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    const fileData = await downloadFromMarketplace(extensionId);

    return await this.officialLoader.installExtension({
      foxeFileData: fileData,
      externalId: extensionId,
    });
    // â†’ "official" åå‰ç©ºé–“ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  }

  /**
   * ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿æ‹¡å¼µæ©Ÿèƒ½ã®ä¸€è¦§ã‚’å–å¾—
   */
  public async getAllExtensions(): Promise<CategorizedExtensions> {
    const [local, official, community] = await Promise.all([
      this.localLoader.getExtensions(),
      this.officialLoader.getExtensions(),
      this.communityLoader.getExtensions(),
    ]);

    return {
      local,
      official,
      community,
    };
  }

  /**
   * æ‹¡å¼µæ©Ÿèƒ½ã‚’ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   */
  public async uninstall(id: string, namespace: Namespace): Promise<void> {
    switch (namespace) {
      case "local":
        await this.localLoader.uninstallExtension(id);
        break;
      case "official":
        await this.officialLoader.uninstallExtension(id);
        break;
      case "community":
        await this.communityLoader.uninstallExtension(id);
        break;
    }
  }
}

interface CategorizedExtensions {
  local: ExtensionInfo[];
  official: ExtensionInfo[];
  community: ExtensionInfo[];
}

/**
 * ä½¿ç”¨ä¾‹
 */
async function main() {
  const manager = new ExtensionManager();

  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  const file = await selectFile();
  const localExt = await manager.installFromFile(file);
  console.log(`ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†: ${localExt.name} (local)`);

  // å…¬å¼ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  const officialExt = await manager.installFromMarketplace("official.3d-panel");
  console.log(`ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å®Œäº†: ${officialExt.name} (official)`);

  // ã™ã¹ã¦ã®æ‹¡å¼µæ©Ÿèƒ½ã‚’å–å¾—
  const extensions = await manager.getAllExtensions();
  console.log(`ãƒ­ãƒ¼ã‚«ãƒ«: ${extensions.local.length}å€‹`);
  console.log(`å…¬å¼: ${extensions.official.length}å€‹`);
  console.log(`ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£: ${extensions.community.length}å€‹`);
}
```

---

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

### ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®æ¨©é™ç®¡ç†

```typescript
/**
 * ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®æ¨©é™ã‚¿ã‚¤ãƒ—
 */
export type LayoutPermission =
  | "CREATOR_WRITE" // ä½œæˆè€…ã®ã¿ç·¨é›†å¯èƒ½
  | "ORG_READ" // çµ„ç¹”ãƒ¡ãƒ³ãƒãƒ¼ã¯èª­ã¿å–ã‚Šã®ã¿
  | "ORG_WRITE"; // çµ„ç¹”ãƒ¡ãƒ³ãƒãƒ¼ã‚‚ç·¨é›†å¯èƒ½

/**
 * æ¨©é™ãƒã‚§ãƒƒã‚¯ã®ä¾‹
 */
async function checkLayoutAccess(
  layoutId: LayoutID,
  userId: string,
  organizationId: string,
): Promise<boolean> {
  const layout = await layoutStorage.get(`user-${userId}`, layoutId);

  if (!layout) {
    return false;
  }

  switch (layout.permission) {
    case "CREATOR_WRITE":
      // ä½œæˆè€…ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
      return layout.namespace === `user-${userId}`;

    case "ORG_READ":
    case "ORG_WRITE":
      // çµ„ç¹”ãƒ¡ãƒ³ãƒãƒ¼ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
      return layout.namespace === `user-${userId}` || layout.namespace === `org-${organizationId}`;

    default:
      return false;
  }
}
```

### åå‰ç©ºé–“ã®æ¤œè¨¼

```typescript
/**
 * åå‰ç©ºé–“ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
 */
function validateNamespace(namespace: string): boolean {
  // åå‰ç©ºé–“ã®å½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯
  const namespacePattern = /^(user|org|team|env)-[a-zA-Z0-9-]+$/;
  return namespacePattern.test(namespace);
}

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåå‰ç©ºé–“ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹æ¨©é™ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
 */
async function canAccessNamespace(userId: string, namespace: string): Promise<boolean> {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã®åå‰ç©ºé–“
  if (namespace === `user-${userId}`) {
    return true;
  }

  // çµ„ç¹”ã®åå‰ç©ºé–“
  if (namespace.startsWith("org-")) {
    const orgId = namespace.replace("org-", "");
    return await isUserInOrganization(userId, orgId);
  }

  // ãƒãƒ¼ãƒ ã®åå‰ç©ºé–“
  if (namespace.startsWith("team-")) {
    const teamId = namespace.replace("team-", "");
    return await isUserInTeam(userId, teamId);
  }

  return false;
}
```

---

## ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®è€ƒæ…®äº‹é …

### IndexedDBã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ´»ç”¨

```typescript
/**
 * ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ: åå‰ç©ºé–“ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ã‚ˆã‚‹é«˜é€Ÿæ¤œç´¢
 */
export class IdbLayoutStorage implements ILayoutStorage {
  #db = IDB.openDB<LayoutsDB>(DATABASE_NAME, 1, {
    upgrade(db) {
      const store = db.createObjectStore(OBJECT_STORE_NAME, {
        keyPath: ["namespace", "layout.id"],
      });

      // åå‰ç©ºé–“ã§ã®æ¤œç´¢ã‚’é«˜é€ŸåŒ–
      store.createIndex("namespace", "namespace");
    },
  });

  public async list(namespace: string): Promise<readonly Layout[]> {
    // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½¿ç”¨ã—ãŸåŠ¹ç‡çš„ãªæ¤œç´¢
    // O(log n) ã®æ™‚é–“è¤‡é›‘åº¦
    const records = await (
      await this.#db
    ).getAllFromIndex(OBJECT_STORE_NAME, "namespace", namespace);

    return records.map((record) => record.layout);
  }
}
```

### ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

```typescript
/**
 * ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®å®Ÿè£…ä¾‹
 */
class LayoutCache {
  private cache = new Map<string, Map<LayoutID, Layout>>();

  /**
   * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å–å¾—
   */
  public get(namespace: string, id: LayoutID): Layout | undefined {
    return this.cache.get(namespace)?.get(id);
  }

  /**
   * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’è¿½åŠ 
   */
  public set(namespace: string, layout: Layout): void {
    if (!this.cache.has(namespace)) {
      this.cache.set(namespace, new Map());
    }
    this.cache.get(namespace)!.set(layout.id, layout);
  }

  /**
   * ç‰¹å®šã®åå‰ç©ºé–“ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
   */
  public clearNamespace(namespace: string): void {
    this.cache.delete(namespace);
  }

  /**
   * ã™ã¹ã¦ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢
   */
  public clearAll(): void {
    this.cache.clear();
  }
}
```

### ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®æœ€é©åŒ–

```typescript
/**
 * æ‹¡å¼µæ©Ÿèƒ½: åå‰ç©ºé–“ã”ã¨ã«åˆ¥DBã§åˆ†é›¢
 * ãƒ¡ãƒªãƒƒãƒˆ: ä¸è¦ãªåå‰ç©ºé–“ã®ãƒ‡ãƒ¼ã‚¿ã¯ãƒ¡ãƒ¢ãƒªã«èª­ã¿è¾¼ã¾ã‚Œãªã„
 */

// "local" åå‰ç©ºé–“ã®ã¿ã‚’ãƒ­ãƒ¼ãƒ‰ï¼ˆ"official" ã¯ãƒ­ãƒ¼ãƒ‰ã•ã‚Œãªã„ï¼‰
const localLoader = new IdbExtensionLoader("local");
const localExtensions = await localLoader.getExtensions();

// å¿…è¦ã«å¿œã˜ã¦ "official" ã‚’ãƒ­ãƒ¼ãƒ‰
const officialLoader = new IdbExtensionLoader("official");
const officialExtensions = await officialLoader.getExtensions();
```

---

## ğŸš€ å°†æ¥ã®æ‹¡å¼µå¯èƒ½æ€§

### 1. éšå±¤çš„åå‰ç©ºé–“

```typescript
/**
 * å°†æ¥çš„ãªéšå±¤æ§‹é€ ã®ã‚µãƒãƒ¼ãƒˆ
 */
interface HierarchicalNamespace {
  root: string; // "org-acme"
  department?: string; // "engineering"
  team?: string; // "robotics"
}

// ä¾‹: "org-acme/engineering/robotics"
function buildNamespace(hierarchy: HierarchicalNamespace): string {
  const parts = [hierarchy.root];
  if (hierarchy.department) parts.push(hierarchy.department);
  if (hierarchy.team) parts.push(hierarchy.team);
  return parts.join("/");
}
```

### 2. åå‰ç©ºé–“ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹

```typescript
/**
 * åå‰ç©ºé–“ã®ã‚¨ã‚¤ãƒªã‚¢ã‚¹æ©Ÿèƒ½
 */
interface NamespaceAlias {
  alias: string; // "my-workspace"
  target: string; // "user-alice-123"
}

class NamespaceResolver {
  private aliases = new Map<string, string>();

  public registerAlias(alias: string, target: string): void {
    this.aliases.set(alias, target);
  }

  public resolve(namespace: string): string {
    return this.aliases.get(namespace) ?? namespace;
  }
}
```

### 3. å‹•çš„åå‰ç©ºé–“ã®åˆ‡ã‚Šæ›¿ãˆ

```typescript
/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¤‡æ•°ã®åå‰ç©ºé–“ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã‚‹æ©Ÿèƒ½
 */
class NamespaceSwitcher {
  private currentNamespace: string;
  private availableNamespaces: string[];

  constructor(userId: string, organizationIds: string[]) {
    this.currentNamespace = `user-${userId}`;
    this.availableNamespaces = [
      `user-${userId}`,
      ...organizationIds.map((orgId) => `org-${orgId}`),
    ];
  }

  /**
   * åå‰ç©ºé–“ã‚’åˆ‡ã‚Šæ›¿ãˆ
   */
  public async switchNamespace(namespace: string): Promise<void> {
    if (!this.availableNamespaces.includes(namespace)) {
      throw new Error(`Access denied to namespace: ${namespace}`);
    }

    this.currentNamespace = namespace;

    // URLã‚’æ›´æ–°
    const url = new URL(window.location.href);
    url.searchParams.set("namespace", namespace);
    window.history.pushState({}, "", url.toString());

    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å†èª­ã¿è¾¼ã¿
    await reloadLayouts();
  }

  /**
   * åˆ©ç”¨å¯èƒ½ãªåå‰ç©ºé–“ã®ä¸€è¦§ã‚’å–å¾—
   */
  public getAvailableNamespaces(): string[] {
    return [...this.availableNamespaces];
  }
}
```

---

## ğŸ“š ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. åå‰ç©ºé–“ã®å‘½åè¦å‰‡

```typescript
/**
 * æ¨å¥¨ã•ã‚Œã‚‹åå‰ç©ºé–“ã®å‘½åãƒ‘ã‚¿ãƒ¼ãƒ³
 */
const NAMESPACE_PATTERNS = {
  // ãƒ¦ãƒ¼ã‚¶ãƒ¼å€‹äººç”¨
  USER: (userId: string) => `user-${userId}`,

  // çµ„ç¹”ç”¨
  ORGANIZATION: (orgId: string) => `org-${orgId}`,

  // ãƒãƒ¼ãƒ ç”¨
  TEAM: (teamId: string) => `team-${teamId}`,

  // ç’°å¢ƒç”¨
  ENVIRONMENT: (env: "dev" | "staging" | "prod") => `env-${env}`,

  // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨
  PROJECT: (projectId: string) => `project-${projectId}`,
};

/**
 * ä½¿ç”¨ä¾‹
 */
const userNamespace = NAMESPACE_PATTERNS.USER("alice-123");
// â†’ "user-alice-123"

const orgNamespace = NAMESPACE_PATTERNS.ORGANIZATION("acme-corp");
// â†’ "org-acme-corp"
```

### 2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

```typescript
/**
 * åå‰ç©ºé–“é–¢é€£ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¨ãƒ©ãƒ¼
 */
class NamespaceError extends Error {
  constructor(
    message: string,
    public readonly namespace: string,
    public readonly code: string,
  ) {
    super(message);
    this.name = "NamespaceError";
  }
}

/**
 * å®‰å…¨ãªåå‰ç©ºé–“ã‚¢ã‚¯ã‚»ã‚¹
 */
async function safeGetLayouts(namespace: string): Promise<Layout[]> {
  try {
    // åå‰ç©ºé–“ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!validateNamespace(namespace)) {
      throw new NamespaceError(
        `Invalid namespace format: ${namespace}`,
        namespace,
        "INVALID_FORMAT",
      );
    }

    // ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®ãƒã‚§ãƒƒã‚¯
    const hasAccess = await canAccessNamespace(getCurrentUserId(), namespace);
    if (!hasAccess) {
      throw new NamespaceError(
        `Access denied to namespace: ${namespace}`,
        namespace,
        "ACCESS_DENIED",
      );
    }

    // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å–å¾—
    return await layoutStorage.list(namespace);
  } catch (error) {
    if (error instanceof NamespaceError) {
      log.error(`Namespace error [${error.code}]:`, error.message);
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
      showErrorNotification(error.message);
    } else {
      log.error("Unexpected error:", error);
    }
    return [];
  }
}
```

### 3. ãƒ†ã‚¹ãƒˆã§ã®åå‰ç©ºé–“åˆ©ç”¨

```typescript
/**
 * ãƒ†ã‚¹ãƒˆç”¨ã®åå‰ç©ºé–“ã‚’ä½¿ç”¨
 */
describe("LayoutStorage", () => {
  const testNamespace = "test-" + Date.now();
  let storage: IdbLayoutStorage;

  beforeEach(async () => {
    storage = new IdbLayoutStorage();
  });

  afterEach(async () => {
    // ãƒ†ã‚¹ãƒˆå¾Œã«ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
    const layouts = await storage.list(testNamespace);
    for (const layout of layouts) {
      await storage.delete(testNamespace, layout.id);
    }
  });

  it("should save and retrieve layout in test namespace", async () => {
    const layout: Layout = {
      id: "test-layout",
      name: "Test Layout",
      data: {
        /* ... */
      },
    };

    await storage.put(testNamespace, layout);
    const retrieved = await storage.get(testNamespace, "test-layout");

    expect(retrieved).toEqual(layout);
  });
});
```

---

## ğŸ“ ã¾ã¨ã‚

### ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®åå‰ç©ºé–“

**ç‰¹å¾´**:

- âœ… URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å‹•çš„ã«å–å¾—
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»çµ„ç¹”ã®è­˜åˆ¥ã«ä½¿ç”¨
- âœ… å˜ä¸€ã®IndexedDBã§è¤‡åˆã‚­ãƒ¼ç®¡ç†
- âœ… ãƒªãƒ¢ãƒ¼ãƒˆAPIã¨ã®åŒæœŸã«å¯¾å¿œ
- âœ… æ¨©é™ç®¡ç†ã¨ã®çµ±åˆ

**ä¸»ãªç”¨é€”**:

- ãƒãƒ«ãƒãƒ¦ãƒ¼ã‚¶ãƒ¼ç’°å¢ƒã§ã®ãƒ‡ãƒ¼ã‚¿åˆ†é›¢
- çµ„ç¹”ãƒ»ãƒãƒ¼ãƒ å˜ä½ã§ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå…±æœ‰
- ç’°å¢ƒï¼ˆé–‹ç™º/æœ¬ç•ªï¼‰ã®åˆ†é›¢

### æ‹¡å¼µæ©Ÿèƒ½ã®åå‰ç©ºé–“

**ç‰¹å¾´**:

- âœ… å›ºå®šå€¤ã¾ãŸã¯è¨­å®šã§æŒ‡å®š
- âœ… ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ƒã®åˆ†é¡ã«ä½¿ç”¨
- âœ… åå‰ç©ºé–“ã”ã¨ã«åˆ¥ã®IndexedDB
- âœ… ãƒ­ãƒ¼ã‚«ãƒ«/å…¬å¼/ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®åˆ†é›¢
- âœ… ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã¨ã—ã¦ä¿å­˜

**ä¸»ãªç”¨é€”**:

- æ‹¡å¼µæ©Ÿèƒ½ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å…ƒã®ç®¡ç†
- ãƒ­ãƒ¼ã‚«ãƒ«ãƒ»å…¬å¼ãƒ»ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã®åˆ†é›¢
- æ‹¡å¼µæ©Ÿèƒ½ã®æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

### å…±é€šèªè­˜

**è³ªå•**: æ‹¡å¼µæ©Ÿèƒ½ã§ã‚‚åå‰ç©ºé–“ã¯ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ãŒã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¨åŒã˜ä½¿ã„æ–¹ã¨ã„ã†èªè­˜ã§è‰¯ã„ã®ã§ã—ã‚‡ã†ã‹ï¼Ÿ

**å›ç­”**: **åŸºæœ¬çš„ãªæ¦‚å¿µã¯åŒã˜ã§ã™ãŒã€ä½¿ã„æ–¹ã¨ç›®çš„ãŒç•°ãªã‚Šã¾ã™**

- **å…±é€šç‚¹**: ãƒ‡ãƒ¼ã‚¿ã®è«–ç†çš„ãªåˆ†é›¢ã€IndexedDBã§ã®ç®¡ç†ã€HTTP APIã§ã®é€ä¿¡
- **ç›¸é•ç‚¹**:
  - **ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ**: å‹•çš„ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¾å­˜ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é‡è¦–
  - **æ‹¡å¼µæ©Ÿèƒ½**: é™çš„ãƒ»åˆ†é¡ç›®çš„ãƒ»ç®¡ç†ã®ä¾¿å®œ

ã©ã¡ã‚‰ã‚‚ã€Œãƒ‡ãƒ¼ã‚¿ã®è¡çªã‚’é˜²ãã€æ•´ç†ã™ã‚‹ã€ã¨ã„ã†æœ¬è³ªçš„ãªå½¹å‰²ã¯åŒã˜ã§ã™ãŒã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯ã‚ˆã‚Šå‹•çš„ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸­å¿ƒã€æ‹¡å¼µæ©Ÿèƒ½ã¯ã‚ˆã‚Šé™çš„ã§ç®¡ç†ä¸­å¿ƒã®è¨­è¨ˆã¨ãªã£ã¦ã„ã¾ã™ã€‚

---

## ğŸ“ å‚è€ƒãƒªãƒ³ã‚¯

### ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰

- **LayoutsAPI**: `packages/suite-base/src/api/layouts/LayoutsAPI.ts`
- **IdbLayoutStorage**: `packages/suite-base/src/IdbLayoutStorage.ts`
- **IdbExtensionStorage**: `packages/suite-base/src/services/extension/IdbExtensionStorage.ts`
- **IdbExtensionLoader**: `packages/suite-base/src/services/extension/IdbExtensionLoader.ts`
- **StudioApp**: `packages/suite-base/src/StudioApp.tsx`

### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [v1.20.0 Layout API è©³ç´°åˆ†æãƒ¬ãƒãƒ¼ãƒˆ](./v1.20.0-layout-api-detailed-analysis.md)
- [PR #695 - Lichtblick Layouts API](https://github.com/lichtblick-suite/lichtblick/pull/695)

---

_ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ã€å®Ÿéš›ã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰èª¿æŸ»ã«åŸºã¥ã„ã¦ä½œæˆã•ã‚Œã¦ã„ã¾ã™ã€‚æŠ€è¡“çš„ãªè©³ç´°ã¯ã€è©²å½“ã™ã‚‹ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚_

**æœ€çµ‚æ›´æ–°**: 2025å¹´10æœˆ5æ—¥
