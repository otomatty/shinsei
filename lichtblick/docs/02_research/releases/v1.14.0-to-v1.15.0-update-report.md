# Lichtblick v1.14.0 → v1.15.0 変更調査レポート

## 概要

**アップデート日**: 2025年6月17日
**対象バージョン**: v1.14.0 → v1.15.0
**総コミット数**: 44件（実質的な機能追加・修正は19件）
**総変更行数**: 大規模な変更（詳細統計は数千行レベル）
**主要な特徴**: E2Eテスト基盤の構築と新機能の大幅な追加

## 主要な新機能・改善

### 1. 🎥 カスタムカメラモデル対応

**PR #508**: Add custom camera models via extensions
**作成者**: Alexandre Neuwald CTW
**コミット**: 2a76a16c066edfb025083aafbfeb35640e579b1e
**日付**: 2025年5月27日

#### 概要

拡張機能を通じてカスタムカメラモデルを登録できる機能を追加。従来のPinholeカメラモデルのみの制約から解放され、ユーザー独自のカメラモデルを実装可能に。

#### 主要な変更

1. **新しいカメラモデルAPI**: `ICameraModel`インターフェースの導入
2. **拡張機能登録システム**: `registerCameraModel()`メソッドの追加
3. **動的モデル選択**: `distortion_model`属性による自動選択
4. **後方互換性**: 未知のモデルはPinholeモデルにフォールバック

#### 技術実装詳細

```typescript
// 拡張機能でのカメラモデル登録例
extensionContext.registerCameraModel({
  name: "CylinderCameraModel",
  modelBuilder: (cameraInfo: CameraInfo) => new CylinderCameraModel(cameraInfo),
});
```

#### 影響範囲

- **新規ファイル**: `selectCameraModel.ts`, `cameraModels.ts`
- **変更コンポーネント**: ImageMode, Images, ThreeDeeRender
- **テストファイル**: カスタムカメラモデル用テストアセット追加

### 2. 🎭 ドラッグ&ドロップレイアウト機能

**PR #522**: Drag and drop for Layouts
**作成者**: ctw-joao-luis
**コミット**: a42e87cc4244ab4ad7f38c888ffedcd9eb01d4ff
**日付**: 2025年6月4日

#### 概要

レイアウトファイル（.json）のドラッグ&ドロップ機能を追加。拡張機能やMCAPファイルと同様に、レイアウトも直感的にインポート可能に。

#### 主要な変更

1. **ファイル拡張子サポート**: `.json`ファイルの受け入れ
2. **レイアウト解析**: `parseAndInstallLayout`関数の抽出・共通化
3. **IndexedDB統合**: ドロップされたレイアウトの自動保存
4. **UI一貫性**: 他のファイルタイプと統一されたドラッグ&ドロップ体験

#### 技術実装詳細

- **ファイルハンドリング**: `useHandleFiles`フックの拡張
- **レイアウト転送**: `useLayoutTransfer`の論理分離
- **バリデーション**: JSON構文チェック（内容検証は今後の課題）

### 3. 🛠️ 拡張機能メッセージコンバーター修正

**PR #544**: Fixing multiple message converters not being registered
**作成者**: ctw-joao-luis
**コミット**: d2377a70dd48130833b7ac0545a5ffdbaf133baa
**日付**: 2025年6月16日

#### 概要

拡張機能インストール時に複数のメッセージコンバーターとエイリアス関数が正しく登録されない問題を修正。

#### 技術的な問題

- **原因**: `_.uniqBy`フィルターにより、拡張機能IDごとに1つのコンバーターのみ登録
- **影響**: 複数のコンバーターを持つ拡張機能で機能制限
- **解決**: フィルター処理の除去により全コンバーターの登録を保証

### 4. 🧪 E2E テスト基盤の大幅拡充

**PR #517**: Feature/configure new e2e tests
**作成者**: gabriela-almeida-ctw
**コミット**: e77594c32
**日付**: 2025年6月4日

#### 概要

Playwrightベースの包括的なE2Eテスト環境を構築。従来のintegration-testから移行し、より堅牢なテスト基盤を確立。

#### 新規E2Eテスト

1. **ファイル操作テスト** (PR #541):

   - CLI経由のファイルオープン
   - ドラッグ&ドロップによるファイル操作

2. **カスタムカメラモデルテスト** (PR #539):

   - 拡張機能によるカメラモデル登録・使用

3. **UI操作テスト** (PR #540):
   - サイドバーの表示・非表示
   - ショートカットキー操作

#### E2Eテスト環境詳細

```
e2e/
├── fixtures/          # テスト用アセット・ヘルパー
├── tests/desktop/      # デスクトップ版テスト
├── tests/web/          # Web版テスト
└── README.md          # E2Eテスト実行ガイド
```

### 5. 📱 UI/UX改善

#### パネルのタイトルフィールド追加 (PR #518)

- **機能**: パネルにカスタムタイトルを設定可能
- **メリット**: パネルの識別性向上、ワークフロー効率化

#### 初期ダイアログの「今後表示しない」オプション (PR #521)

- **機能**: 初期ダイアログにチェックボックス追加
- **メリット**: リピートユーザーの利便性向上

#### レイアウト右クリックメニュー修正 (PR #520)

- **問題**: レイアウト上での右クリックメニューの不具合
- **修正**: コンテキストメニューの正常動作を保証

### 6. 🔧 デスクトップ版拡張機能重複読み込み修正

**PR #537**: Fix repetitive loading extensions for desktop version
**作成者**: Luiz Bezerra
**コミット**: e793fd14f
**日付**: 2025年6月9日

#### 概要

デスクトップ版で拡張機能が重複して読み込まれる問題を修正。パフォーマンス向上とメモリ使用量の最適化を実現。

## 依存関係の大幅更新

### 主要ライブラリ更新

- **mathjs**: 11.11.1 → 14.5.2（大幅バージョンアップ）
- **Electron**: 36.0.1 → 36.3.2（セキュリティ・安定性向上）
- **Storybook**: 最新版への更新（6パッケージ）
- **Webpack**: 5.99.7 → 5.99.9
- **Babel**: 3パッケージの更新
- **zustand**: 4.4.1 → 4.5.7

### 開発環境改善

- **Windows CI**: パッケージジョブのWindows版更新
- **Dependabot**: 自動依存関係更新の活発化
- **ESLint**: ヘッダールール更新とコード品質向上

## インフラ・開発基盤改善

### 1. 旧Integration-testの削除

**削除対象**:

```
desktop/integration-test/
├── buildSize.test.ts
├── filterOfTopicsNodeEditor.test.ts
├── launchApp.ts
├── layouts.test.ts
├── mapPanel.test.ts
├── menus.test.ts
├── open-extension.test.ts
├── openFile.test.ts
├── startup.test.ts
├── uninstall-extension.test.ts
└── websocket.test.ts
```

### 2. 新E2E基盤への移行

**新規追加**:

```
e2e/
├── fixtures/
│   ├── assets/                    # テスト用データファイル
│   ├── electron.ts               # Electronテスト設定
│   ├── load-file.ts              # ファイル読み込みヘルパー
│   └── urls.ts                   # URL設定
├── tests/desktop/                # デスクトップ版テスト
│   ├── extension/                # 拡張機能テスト
│   ├── layout/                   # レイアウトテスト
│   ├── menu/                     # メニューテスト
│   ├── open-files/               # ファイルオープンテスト
│   ├── panel/                    # パネルテスト
│   ├── topics/                   # トピックテスト
│   └── websocket/                # WebSocket接続テスト
└── tests/web/                    # Web版テスト
```

## ファイル構造の変更

### 新規追加ファイル（主要なもの）

```
packages/den/image/
├── selectCameraModel.test.ts     # カメラモデル選択テスト
├── selectCameraModel.ts          # カメラモデル選択ロジック
└── types.ts                      # カメラ関連型定義

packages/suite/src/
└── cameraModels.ts               # カメラモデルエクスポート

packages/suite-base/src/types.ts  # 共通型定義追加

e2e/                              # E2Eテスト基盤（全体）
└── [多数のテストファイル]
```

### 削除ファイル

```
desktop/integration-test/         # 旧テスト基盤（全体）
packages/den/image/CameraInfo.ts  # カメラ情報（移行）
integration-test-build.ts         # 旧ビルドスクリプト
```

## 品質向上・技術改善

### テスト観点

1. **E2Eテストカバレッジ**: 主要機能の包括的テスト化
2. **テスト環境統一**: Playwright採用による一貫した基盤
3. **自動テスト**: CI/CD統合による継続的品質保証
4. **リアルなユーザーシナリオ**: 実際の使用パターンを反映

### コード品質

1. **拡張機能API**: より柔軟で強力な拡張システム
2. **型安全性**: TypeScript型定義の充実
3. **モジュール化**: 機能の適切な分離と再利用性向上
4. **エラーハンドリング**: 拡張機能エラーの適切な処理

## 影響範囲分析

### 高影響

1. **カスタムカメラモデル**: 画像処理・3D表示の拡張性向上
2. **E2Eテスト基盤**: 開発プロセスと品質保証の大幅改善
3. **レイアウトD&D**: ユーザビリティの大幅向上

### 中影響

1. **拡張機能修正**: 既存拡張機能の動作改善
2. **UI改善**: 日常的な使用における利便性向上
3. **依存関係更新**: 安定性・セキュリティの向上

### 低影響

1. **開発環境改善**: 開発者体験の向上
2. **ドキュメント更新**: README追加・更新

## 互換性情報

### 破壊的変更

- **なし**: このアップデートに破壊的変更は含まれていません

### API拡張

- **カメラモデルAPI**: 新しい拡張機能API追加
- **レイアウト処理**: 内部API拡張（後方互換性維持）

### 新規要件

- **Playwright**: E2Eテスト実行にPlaywright環境が必要
- **Node.js**: 依存関係更新により、最新のNode.js推奨

## パフォーマンス影響

### 改善点

1. **拡張機能読み込み**: 重複読み込み問題の解決
2. **メッセージコンバーター**: 正しい登録による処理効率化
3. **依存関係最新化**: 全体的なパフォーマンス向上

### 注意点

- カスタムカメラモデル使用時の処理負荷（モデル依存）
- E2Eテスト実行時のリソース使用量

## テスト戦略

### E2Eテスト実行方法

```bash
# デスクトップ版E2Eテスト
npm run test:e2e:desktop

# Web版E2Eテスト
npm run test:e2e:web

# 特定テスト実行
npx playwright test e2e/tests/desktop/extension/
```

### テストカバレッジ

- **機能テスト**: 主要機能の動作確認
- **統合テスト**: 拡張機能とコア機能の連携
- **UI/UXテスト**: ユーザーインタラクションの検証
- **回帰テスト**: 既存機能のデグレーション防止

## 移行・導入手順

### 開発者向け

1. **依存関係更新**: `yarn install`で最新依存関係取得
2. **E2E環境構築**: Playwright環境のセットアップ
3. **テスト実行**: 新しいE2Eテストの動作確認
4. **拡張機能更新**: カスタムカメラモデルAPI活用検討

### エンドユーザー向け

- **通常アップデート**: 特別な操作は不要
- **新機能利用**:
  - レイアウトのドラッグ&ドロップが可能
  - パネルタイトルのカスタマイズが可能
  - カスタムカメラモデル拡張機能の利用

## 今後の推奨事項

### 短期的改善

1. **レイアウトバリデーション**: JSONファイル内容の詳細検証実装
2. **E2Eテスト拡充**: より多くのユースケースカバー
3. **カメラモデルドキュメント**: 拡張機能開発ガイド整備

### 中期的発展

1. **E2E CI統合**: 自動テスト実行の本格運用
2. **拡張機能エコシステム**: コミュニティ拡張の促進
3. **パフォーマンス最適化**: 大規模データセット対応強化

## セキュリティ考慮事項

### 改善点

- **依存関係更新**: セキュリティパッチの適用
- **Electron更新**: 最新セキュリティ機能の利用

### 注意点

- **JSONファイル処理**: ドラッグ&ドロップ時の入力検証
- **拡張機能**: カスタムコード実行時のサンドボックス化

## 関連リソース

### 参考リンク

- [v1.14.0...v1.15.0 比較](https://github.com/lichtblick-suite/lichtblick/compare/v1.14.0...v1.15.0)
- [PR #508: Add custom camera models via extensions](https://github.com/lichtblick-suite/lichtblick/pull/508)
- [PR #522: Drag and drop for Layouts](https://github.com/lichtblick-suite/lichtblick/pull/522)
- [PR #544: Fixing multiple message converters](https://github.com/lichtblick-suite/lichtblick/pull/544)
- [PR #517: Feature/configure new e2e tests](https://github.com/lichtblick-suite/lichtblick/pull/517)
- [Lichtblick GitHub Repository](https://github.com/lichtblick-suite/lichtblick)
- [リリースノート v1.15.0](https://github.com/lichtblick-suite/lichtblick/releases/tag/v1.15.0)

### 技術文書

- [Playwright Documentation](https://playwright.dev/docs/intro)
- [Lichtblick Extension Development Guide](https://docs.lichtblick.org/extensions)
- [Camera Model Implementation Guide](https://docs.lichtblick.org/camera-models)

---

**調査実施日**: 2025年7月31日
**調査者**: システム管理者
**レポート作成日**: 2025年7月31日
**ファイル**: LICHTBLICK_V1.14.0_TO_V1.15.0_UPDATE_REPORT.md
