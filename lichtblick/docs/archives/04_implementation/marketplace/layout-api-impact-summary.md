# Layout API v1.20.0 影響調査 - エグゼクティブサマリー

> **調査日**: 2025年10月2日
> **調査対象**: Lichtblick v1.20.0 Layout API (PR #695)
> **影響範囲**: マーケットプレイス機能のレイアウト管理

---

## 🎯 調査結論

### ✅ マーケットプレイス機能は v1.20.0 と **基本的に互換性あり**

**理由:**

1. **異なるレイヤーで動作**: マーケットプレイス機能は既存のLayoutManager APIを利用する設計
2. **権限管理が適切**: マーケットプレイスからのインストールは`CREATOR_WRITE`（個人レイアウト）で実行され、リモート同期の対象外
3. **データ構造の独立性**: マーケットプレイス起源情報はlocalStorageで別管理され、v1.20.0の新しいレイアウト構造と競合しない

---

## 📊 影響度評価

| 項目                   | 影響度 | 対応必要性 | 対応時期     |
| ---------------------- | ------ | ---------- | ------------ |
| **データ構造の競合**   | 🟢 低  | なし       | -            |
| **API呼び出しの重複**  | 🟢 低  | なし       | -            |
| **レイアウト更新処理** | 🟡 中  | あり       | 即座         |
| **同期処理の競合**     | 🟡 中  | 将来検討   | 次回リリース |
| **実装の複雑性**       | 🟢 低  | なし       | -            |

---

## 🔍 主な差分

### 1. v1.20.0の新機能

- **baseline/working方式**: 保存済みバージョンと編集中バージョンの分離
- **リモート同期**: サーバーとの自動同期機能
- **externalId**: リモートレイアウトとローカルレイアウトの紐付け
- **syncInfo**: 同期状態の追跡

### 2. マーケットプレイス機能

- **marketplace起源情報**: マーケットプレイスからのインストール情報を独自管理
- **バージョン追跡**: マーケットプレイスのリリースバージョンを記録
- **更新検出**: 新しいバージョンの利用可能性をチェック

### 3. 両者の関係

```
マーケットプレイス機能
    ↓ (レイアウトデータをダウンロード)
LayoutManager (v1.20.0の改善を活用)
    ↓ (CREATOR_WRITEで保存)
ILayoutStorage (IndexedDB)

※ リモート同期は発生しない（CREATOR_WRITE なので）
※ マーケットプレイス起源情報は localStorage で別管理
```

---

## ⚠️ 軽微な調整が必要な箇所

### 1. レイアウト更新処理の改善 (最優先)

**問題:**
現在の`updateMarketplaceLayout`実装では、`updateLayout`を呼ぶと編集中のworkingコピーが作成されるが、マーケットプレイスからの更新では新しいbaselineとして保存したい。

**解決策:**

```typescript
// 現在
const updatedLayout = await layoutManager.updateLayout({
  id: layoutId,
  data: newLayoutData,
});

// 推奨（workingをbaselineに昇格）
await layoutManager.updateLayout({
  id: layoutId,
  data: newLayoutData,
});
const updatedLayout = await layoutManager.overwriteLayout({ id: layoutId });
```

**工数見積**: 4-6時間

---

## 📋 推奨対応項目

### 即座に実施（現在のリリース前）

1. **✅ updateMarketplaceLayoutの改善**

   - `overwriteLayout`の追加呼び出し
   - 工数: 4-6時間

2. **✅ 統合テストの追加**

   - マーケットプレイス・v1.20.0連携テスト
   - リモート同期が発生しないことの確認
   - 工数: 4-6時間

3. **✅ ドキュメント更新**
   - v1.20.0対応の記載追加
   - 実装例の更新
   - 工数: 2-4時間

**合計工数**: 10-16時間 (約2日)

### 次回リリース（2-3ヶ月後）

1. **ILayoutManager拡張**
   - `markAsMarketplaceLayout`メソッド追加
   - `getMarketplaceOrigin`メソッド追加
   - 工数: 40-60時間 (1-1.5週間)

### 将来のリリース（6-12ヶ月後）

1. **マーケットプレイス起源情報のリモート同期**
   - 複数デバイス間での情報共有
   - 工数: 144-228時間 (3.5-5.5週間)

---

## 🧪 必須テストシナリオ

### 1. インストールテスト

```typescript
✓ マーケットプレイスからレイアウトをインストール
✓ インストールしたレイアウトが CREATOR_WRITE であること
✓ リモート同期が発生しないこと
✓ マーケットプレイス起源情報が保持されること
```

### 2. 更新テスト

```typescript
✓ マーケットプレイスレイアウトを新バージョンに更新
✓ 更新後もマーケットプレイス起源情報が保持されること
✓ baselineが更新され、workingが空になること
```

### 3. 編集テスト

```typescript
✓ マーケットプレイスレイアウトを編集
✓ 編集後もマーケットプレイス起源情報が保持されること
✓ working/baseline構造が正しく機能すること
```

---

## 📚 詳細ドキュメント

**包括的な分析レポート**: `docs/marketplace/layout-api-impact-analysis.md`

以下を含む詳細分析:

- v1.20.0の主要変更点の詳細
- データ構造の完全な比較
- 実装例とコードサンプル
- マイグレーション計画
- E2Eテストシナリオ
- リスク管理とベストプラクティス

---

## ✅ 推奨アクションプラン

### Step 1: v1.20.0マージ前（1時間）

```bash
# 現在の実装をバックアップ
git checkout -b backup/marketplace-pre-v1.20.0
git push origin backup/marketplace-pre-v1.20.0
```

### Step 2: マージ作業（2-4時間）

```bash
# v1.20.0をマージ
git fetch upstream
git merge upstream/main

# 競合解決とビルド確認
npm run build
npm run test
```

### Step 3: 必須修正の実施（6-8時間）

1. `LayoutCatalogProvider.tsx`の`updateMarketplaceLayout`を修正
2. 統合テストの追加と実行
3. ドキュメントの更新

### Step 4: 動作確認（2-4時間）

1. マニュアルテストの実施
2. E2Eテストの実行
3. パフォーマンステスト

**合計所要時間**: 11-17時間 (約2-3日)

---

## 🚦 リスク評価

| リスク               | 発生確率 | 影響度 | 対策                           |
| -------------------- | -------- | ------ | ------------------------------ |
| マージ時の競合       | 🟡 中    | 🟡 中  | バックアップブランチ作成       |
| 既存機能の破壊       | 🟢 低    | 🔴 高  | 包括的な統合テスト             |
| パフォーマンス低下   | 🟢 低    | 🟡 中  | ベンチマークテスト             |
| ユーザーデータの損失 | 🟢 低    | 🔴 高  | データマイグレーション慎重設計 |

---

## 💡 重要なポイント

### ✅ Good News

1. **大きな変更は不要**: マーケットプレイス機能の基本設計は変更なし
2. **v1.20.0の恩恵を受けられる**: より堅牢なレイアウト管理が可能に
3. **将来の拡張性向上**: v1.20.0の基盤が将来的な機能追加を支援

### ⚠️ 注意点

1. **更新処理の改善が必須**: `overwriteLayout`の追加呼び出し
2. **テストの追加が重要**: リモート同期が発生しないことの確認
3. **将来的な統合を検討**: マーケットプレイス起源情報のより良い管理方法

---

## 📞 次のステップ

1. **詳細レポートの確認**

   - `docs/marketplace/layout-api-impact-analysis.md` を精読

2. **実装計画の策定**

   - v1.20.0マージのタイミング決定
   - 必須修正の担当者アサイン

3. **テスト計画の作成**

   - 統合テストシナリオの詳細化
   - E2Eテストの実装

4. **レビューとQA**
   - コードレビューの実施
   - QAチームとの連携

---

**Document Version**: 1.0.0
**Last Updated**: 2025年10月2日
**Author**: AI Technical Advisor
