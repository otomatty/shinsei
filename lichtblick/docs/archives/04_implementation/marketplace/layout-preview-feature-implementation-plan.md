# ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ å®Ÿè£…è¨ˆç”»æ›¸

## ğŸ“‹ ç›®æ¬¡

1. [æ¦‚è¦](#æ¦‚è¦)
2. [ç¾åœ¨ã®å®Ÿè£…çŠ¶æ³](#ç¾åœ¨ã®å®Ÿè£…çŠ¶æ³)
3. [è¦ä»¶å®šç¾©](#è¦ä»¶å®šç¾©)
4. [æŠ€è¡“çš„èª²é¡Œã¨è§£æ±ºç­–](#æŠ€è¡“çš„èª²é¡Œã¨è§£æ±ºç­–)
5. [ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ](#ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ)
6. [å®Ÿè£…è©³ç´°](#å®Ÿè£…è©³ç´°)
7. [å®Ÿè£…æ‰‹é †](#å®Ÿè£…æ‰‹é †)
8. [ãƒ†ã‚¹ãƒˆè¨ˆç”»](#ãƒ†ã‚¹ãƒˆè¨ˆç”»)
9. [ãƒªã‚¹ã‚¯ã¨å¯¾å¿œç­–](#ãƒªã‚¹ã‚¯ã¨å¯¾å¿œç­–)

---

## æ¦‚è¦

### ç›®çš„

ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å‰ã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®å†…å®¹ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã€‚

### èƒŒæ™¯

ç¾åœ¨ã®ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹æ©Ÿèƒ½ã§ã¯ã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¸€è¦§ã‹ã‚‰ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚’ç›´æ¥ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã ã‘ã®å®Ÿè£…ã¨ãªã£ã¦ãŠã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®å†…å®¹ã‚’äº‹å‰ã«ç¢ºèªã§ããªã„ã€‚ã“ã‚Œã«ã‚ˆã‚Šä»¥ä¸‹ã®å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã‚‹ï¼š

- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒã©ã®ã‚ˆã†ãªãƒ‘ãƒãƒ«æ§‹æˆãªã®ã‹åˆ†ã‹ã‚‰ãªã„
- ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã«æœŸå¾…ã¨ç•°ãªã‚‹å†…å®¹ã ã£ãŸå ´åˆã®æ‰‹æˆ»ã‚ŠãŒç™ºç”Ÿ
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®ä½ä¸‹

### ã‚´ãƒ¼ãƒ«

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹å‰ã«å†…å®¹ã‚’ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã‚‹
- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã®ä¸€æ™‚çš„ãªçŠ¶æ…‹ã§ã‚ã‚‹ã“ã¨ãŒæ˜ç¢ºã«åˆ†ã‹ã‚‹UI
- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ç›´æ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã¾ãŸã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦å…ƒã«æˆ»ã›ã‚‹

---

## ç¾åœ¨ã®å®Ÿè£…çŠ¶æ³

### èª¿æŸ»çµæœã‚µãƒãƒªãƒ¼

#### 1. ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

**`LayoutMarketplaceSettings.tsx`**

```
ãƒ‘ã‚¹: packages/suite-base/src/components/LayoutMarketplaceSettings.tsx
å½¹å‰²: ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã®ãƒ¡ã‚¤ãƒ³ç”»é¢
ä¸»ãªæ©Ÿèƒ½:
- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¸€è¦§ã®è¡¨ç¤º
- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å‡¦ç†
- MarketplaceCardã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®ä½¿ç”¨
```

**ç¾åœ¨ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ•ãƒ­ãƒ¼:**

```typescript
const installLayout = useCallback(
  async (layout: LayoutMarketplaceDetail) => {
    setInstallingIds((prev) => new Set(prev).add(layout.id));
    try {
      const result = await catalog.installLayoutFromMarketplace(layout);
      if (!result.success) {
        throw new Error(/* ... */);
      }
    } catch {
      // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
    } finally {
      setInstallingIds(/* ... */);
    }
  },
  [catalog],
);
```

#### 2. Extensionãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã®è©³ç´°è¡¨ç¤ºæ©Ÿèƒ½

**`ExtensionMarketplaceSettings.tsx`**

```typescript
// Extensionã§ã¯æ—¢ã«è©³ç´°è¡¨ç¤ºæ©Ÿèƒ½ã‚’å®Ÿè£…æ¸ˆã¿
const [focusedExtension, setFocusedExtension] = useState<{
  installed: boolean;
  extension: ExtensionMarketplaceDetail;
} | undefined>();

if (focusedExtension) {
  return (
    <ExtensionDetail
      installed={focusedExtension.installed}
      extension={focusedExtension.extension}
      onClose={() => setFocusedExtension(undefined)}
    />
  );
}
```

**`ExtensionDetail.tsx`**

- MarketplaceDetailBaseã‚’ä½¿ç”¨ã—ãŸçµ±ä¸€UI
- README/CHANGELOGã®è¡¨ç¤º
- ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«/ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ©Ÿèƒ½
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±è¡¨ç¤º

#### 3. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç®¡ç†ã‚·ã‚¹ãƒ†ãƒ 

**CurrentLayoutProvider (packages/suite-base/src/providers/CurrentLayoutProvider/index.tsx)**

```typescript
// ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ç®¡ç†ã®ä¸­æ ¸
interface LayoutState {
  selectedLayout?: {
    id: LayoutID;
    loading?: boolean;
    data: LayoutData | undefined;
    name?: string;
    edited?: boolean;
  };
  sharedPanelState?: Record<PanelType, SharedPanelState>;
}

// ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
const setSelectedLayoutId = useCallback(
  async (id: LayoutID | undefined, saveToProfile = true) => {
    if (!id) {
      setLayoutState({ selectedLayout: undefined });
      return;
    }

    const layout = await layoutManager.getLayout(id);
    setLayoutState({
      selectedLayout: {
        loading: false,
        id: layout.id,
        data: layout.working?.data ?? layout.baseline.data,
        name: layout.name,
      },
    });
  },
  [layoutManager, setLayoutState],
);
```

**ä¸»è¦ãªæ©Ÿèƒ½:**

- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®æ°¸ç¶šåŒ–ç®¡ç†
- ãƒ‘ãƒãƒ«é…ç½®ã®çŠ¶æ…‹ç®¡ç†
- ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚µãƒãƒ¼ãƒˆ
- è‡ªå‹•ä¿å­˜æ©Ÿèƒ½

#### 4. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚«ã‚¿ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ 

**LayoutCatalogContext (packages/suite-base/src/context/LayoutCatalogContext.ts)**

```typescript
export interface LayoutCatalog {
  // ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã‹ã‚‰ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  installLayoutFromMarketplace: (
    detail: LayoutMarketplaceDetail,
    name?: string,
  ) => Promise<InstallLayoutResult>;

  // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®å–å¾—
  getInstalledMarketplaceLayouts: () => Promise<Layout[]>;

  // ã‚¢ãƒ³ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
  uninstallMarketplaceLayout: (id: LayoutID) => Promise<void>;

  // ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹èµ·æºæƒ…å ±ã®ç®¡ç†
  getMarketplaceOrigin: (layoutId: LayoutID) => Promise<MarketplaceOrigin | undefined>;
  markAsMarketplaceLayout: (layoutId: LayoutID, origin: MarketplaceOrigin) => Promise<void>;
}
```

**LayoutCatalogProvider (packages/suite-base/src/providers/LayoutCatalogProvider.tsx)**

```typescript
// ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å‡¦ç†ã®å®Ÿè£…
const installLayoutFromMarketplace = useCallback(
  async (detail: LayoutMarketplaceDetail, name?: string): Promise<InstallLayoutResult> => {
    try {
      // 1. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      const layoutData = await downloadLayoutFromMarketplace(detail);

      // 2. ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      const isValid = await validateLayoutData(layoutData);
      if (!isValid) {
        return { success: false, error: new Error("Validation failed") };
      }

      // 3. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      const layout = await layoutManager.saveNewLayout({
        name: name ?? detail.name,
        data: layoutData,
        permission: "CREATOR_WRITE",
      });

      // 4. ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹èµ·æºæƒ…å ±ã®è¨˜éŒ²
      const origin: MarketplaceOrigin = {
        marketplaceId: detail.id,
        installedAt: new Date().toISOString(),
        originalUrl: detail.layoutUrl,
        author: detail.author,
      };
      await markAsMarketplaceLayout(layout.id, origin);

      return { success: true, layout };
    } catch (error) {
      return { success: false, error };
    }
  },
  [downloadLayoutFromMarketplace, layoutManager, markAsMarketplaceLayout, validateLayoutData],
);
```

#### 5. ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚·ã‚¹ãƒ†ãƒ 

**AppSettingsDialog (packages/suite-base/src/components/AppSettingsDialog/AppSettingsDialog.tsx)**

```typescript
import { Dialog, DialogActions, DialogTitle } from "@mui/material";

export function AppSettingsDialog(
  props: DialogProps & { activeTab?: AppSettingsTab }
): React.JSX.Element {
  return (
    <Dialog {...props} fullWidth maxWidth="md">
      <DialogTitle>Settings</DialogTitle>
      {/* ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      <DialogActions>
        <Button onClick={handleClose}>Close</Button>
      </DialogActions>
    </Dialog>
  );
}
```

- MUI Dialogã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨
- ãƒ•ãƒ«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã¾ãŸã¯ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
- ã‚¿ãƒ–ãƒ™ãƒ¼ã‚¹ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³

#### 6. å…±é€šUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

**MarketplaceCard (packages/suite-base/src/components/shared/MarketplaceUI/MarketplaceCard.tsx)**

```typescript
export interface MarketplaceCardProps {
  name: string;
  version: string;
  description?: string;
  author?: string;
  tags?: string[];
  installed?: boolean;
  loading?: boolean;
  onInstall?: (version?: string) => void;
  onUninstall?: (version?: string) => void;
  onViewDetails?: (version?: string) => void; // è©³ç´°è¡¨ç¤ºç”¨
  icon?: ReactNode;
  thumbnail?: string;
  versions?: VersionInfo[];
}
```

- Extension/Layoutä¸¡æ–¹ã§ä½¿ç”¨ã•ã‚Œã‚‹çµ±ä¸€UI
- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã®ã‚µãƒãƒ¼ãƒˆ
- ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤º
- ã‚¿ã‚°ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

### æ—¢å­˜æ©Ÿèƒ½ã®åˆ¶ç´„ã¨èª²é¡Œ

#### åˆ¶ç´„äº‹é …

1. **ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒå¿…é ˆ**

   - ç¾åœ¨ã®å®Ÿè£…ã§ã¯ã€ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã™ã‚‹ã«ã¯`installLayoutFromMarketplace()`ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚‹
   - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã¨è‡ªå‹•çš„ã«LayoutManagerã«æ°¸ç¶šåŒ–ã•ã‚Œã‚‹
   - ä¸€æ™‚çš„ãªè¡¨ç¤ºã®ãŸã‚ã®ä»•çµ„ã¿ãŒå­˜åœ¨ã—ãªã„

2. **ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®åˆ‡ã‚Šæ›¿ãˆã¯ä¿å­˜ã‚’å‰æ**

   - `setSelectedLayoutId()`ã¯å¸¸ã«æ°¸ç¶šåŒ–ã•ã‚ŒãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å¯¾è±¡ã¨ã™ã‚‹
   - ä¸€æ™‚çš„ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã‚’ä¿æŒã™ã‚‹æ©Ÿèƒ½ãŒãªã„

3. **CurrentLayoutProviderã®çŠ¶æ…‹ç®¡ç†**
   - `selectedLayout`ã¯æ°¸ç¶šåŒ–ã•ã‚ŒãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆIDã‚’æŒã¤ã“ã¨ã‚’å‰æã¨ã—ã¦ã„ã‚‹
   - ä¸€æ™‚çš„ãªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ…‹ã¨ã®åŒºåˆ¥ãŒå¿…è¦

#### æŠ€è¡“çš„èª²é¡Œ

1. **ä¸€æ™‚çš„ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¡¨ç¤º**

   - ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã›ãšã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€å¿…è¦ãŒã‚ã‚‹
   - CurrentLayoutProviderã«ä¸€æ™‚çš„ãªçŠ¶æ…‹ã‚’æ³¨å…¥ã™ã‚‹æ–¹æ³•ãŒå¿…è¦

2. **å…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¸ã®å¾©å…ƒ**

   - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‰ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã‚’ä¿å­˜
   - ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã«ç¢ºå®Ÿã«å¾©å…ƒã™ã‚‹

3. **UIã®çŠ¶æ…‹ç®¡ç†**

   - ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®é–‹é–‰çŠ¶æ…‹
   - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®ãƒ•ãƒ©ã‚°
   - ç¢ºèªUIã®è¡¨ç¤ºåˆ¶å¾¡

4. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®ç¶­æŒ**
   - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã‚‚æ“ä½œæ€§ã‚’ç¶­æŒ
   - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã‚ã‚‹ã“ã¨ã®æ˜ç¤º
   - ã‚¹ãƒ ãƒ¼ã‚ºãªé·ç§»

---

## è¦ä»¶å®šç¾©

### æ©Ÿèƒ½è¦ä»¶

#### FR-1: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã®é…ç½®

- **èª¬æ˜**: MarketplaceCardã«Previewãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
- **å‹•ä½œ**:
  - Layoutãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹: Detailãƒœã‚¿ãƒ³ã®ä»£ã‚ã‚Šã«Previewãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
  - Extensionãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹: æ—¢å­˜ã®Detailãƒœã‚¿ãƒ³ã‚’ãã®ã¾ã¾ä½¿ç”¨ï¼ˆå¤‰æ›´ãªã—ï¼‰
  - ã‚¯ãƒªãƒƒã‚¯ã§ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã«ç§»è¡Œ
- **å®Ÿè£…æ–¹é‡**:
  - `LayoutMarketplaceSettings`ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§`onViewDetails`ãƒ—ãƒ­ãƒƒãƒ—ã‚’ä½¿ç”¨
  - ãƒœã‚¿ãƒ³ãƒ©ãƒ™ãƒ«ã¯ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ã¨è¡¨ç¤º
  - Extensionãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã®Detailãƒœã‚¿ãƒ³ã«ã¯å½±éŸ¿ã‚’ä¸ãˆãªã„

#### FR-2: ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ä¸€æ™‚çš„ãªé–‰ã˜ã‚‹

- **èª¬æ˜**: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
- **å‹•ä½œ**:
  - ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’éè¡¨ç¤º
  - ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®çŠ¶æ…‹ã¯ä¿æŒï¼ˆå†åº¦é–‹ã„ãŸæ™‚ã«åŒã˜çŠ¶æ…‹ï¼‰

#### FR-3: ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ä¸€æ™‚çš„ãªè¡¨ç¤º

- **èª¬æ˜**: ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã›ãšã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«è¡¨ç¤º
- **å‹•ä½œ**:
  1. ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã‹ã‚‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
  2. ç¾åœ¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã‚’ä¿å­˜
  3. ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚çš„ã«é©ç”¨
  4. ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’è¡¨ç¤º
- **åˆ¶ç´„**:
  - ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã«ã¯ä¿å­˜ã—ãªã„
  - ä¸€æ™‚çš„ãªãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ…‹ã¨ã—ã¦ãƒãƒ¼ã‚¯

#### FR-4: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã®ç¢ºèªUIè¡¨ç¤º

- **èª¬æ˜**: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã§ã‚ã‚‹ã“ã¨ã‚’æ˜ç¤ºã™ã‚‹UIã‚’è¡¨ç¤º
- **UIè¦ç´ **:
  - ãƒãƒŠãƒ¼å‹ã®é€šçŸ¥
  - ã€Œã“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿã€ã¨ã„ã†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  - ã€Œã™ãã«ä½¿ã†ã€ãƒœã‚¿ãƒ³
  - ã€Œã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ãƒœã‚¿ãƒ³
- **é…ç½®**:
  - ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ä¸Šéƒ¨ã«å›ºå®šè¡¨ç¤º
  - åŠé€æ˜èƒŒæ™¯ã§ç›®ç«‹ã¤ãƒ‡ã‚¶ã‚¤ãƒ³

#### FR-5: ã™ãã«ä½¿ã†ãƒœã‚¿ãƒ³ã®å‹•ä½œ

- **èª¬æ˜**: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ­£å¼ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- **å‹•ä½œ**:
  1. ç¢ºèªUIã‚’éè¡¨ç¤º
  2. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ­£å¼ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆLayoutManagerã«ä¿å­˜ï¼‰
  3. ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æˆåŠŸã®é€šçŸ¥ã‚’è¡¨ç¤º
  4. ãƒ‘ãƒãƒ«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¯å¤‰åŒ–ãªã—ï¼ˆæ—¢ã«è¡¨ç¤ºæ¸ˆã¿ã®ãŸã‚ï¼‰
  5. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤

#### FR-6: ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®å‹•ä½œ

- **èª¬æ˜**: ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦å…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«æˆ»ã‚‹
- **å‹•ä½œ**:
  1. ç¢ºèªUIã‚’éè¡¨ç¤º
  2. ä¿å­˜ã—ã¦ãŠã„ãŸå…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã‚’å¾©å…ƒ
  3. ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å†åº¦é–‹ã
  4. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’è§£é™¤

### éæ©Ÿèƒ½è¦ä»¶

#### NFR-1: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰: 3ç§’ä»¥å†…
- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã¸ã®åˆ‡ã‚Šæ›¿ãˆ: 1ç§’ä»¥å†…
- å…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã¸ã®å¾©å…ƒ: 1ç§’ä»¥å†…

#### NFR-2: ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£

- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã§ã‚ã‚‹ã“ã¨ãŒä¸€ç›®ã§åˆ†ã‹ã‚‹UI
- æ“ä½œã®å–ã‚Šæ¶ˆã—ãŒå®¹æ˜“
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒåˆ†ã‹ã‚Šã‚„ã™ã„

#### NFR-3: ä¿¡é ¼æ€§

- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã®ã‚¨ãƒ©ãƒ¼ã§å…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒå¤±ã‚ã‚Œãªã„
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã®é©åˆ‡ãªãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ä¿è¨¼

#### NFR-4: ä¿å®ˆæ€§

- æ—¢å­˜ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚·ã‚¹ãƒ†ãƒ ã¸ã®å½±éŸ¿ã‚’æœ€å°é™ã«
- ã‚³ãƒ¼ãƒ‰ã®å†åˆ©ç”¨æ€§ã‚’è€ƒæ…®
- ãƒ†ã‚¹ãƒˆã—ã‚„ã™ã„è¨­è¨ˆ

---

## æŠ€è¡“çš„èª²é¡Œã¨è§£æ±ºç­–

### èª²é¡Œ1: ä¸€æ™‚çš„ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¡¨ç¤º

**å•é¡Œ:**

- CurrentLayoutProviderã¯æ°¸ç¶šåŒ–ã•ã‚ŒãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆIDã‚’å‰æã¨ã—ã¦ã„ã‚‹
- ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã›ãšã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨ã™ã‚‹æ©Ÿèƒ½ãŒãªã„

**è§£æ±ºç­–: æ–°ã—ã„Context API ã‚’æ¡ç”¨**

å°‚ç”¨ã® `PreviewLayoutContext` ã‚’ä½œæˆã—ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã‚’ç‹¬ç«‹ã—ã¦ç®¡ç†ã—ã¾ã™ã€‚

```typescript
// PreviewLayoutContext.ts
export interface PreviewLayoutContext {
  isPreviewMode: boolean;
  previewLayout: LayoutData | undefined;
  originalLayoutId: LayoutID | undefined;

  startPreview: (layoutData: LayoutData, originalLayoutId: LayoutID) => void;
  confirmPreview: () => Promise<void>;
  cancelPreview: () => Promise<void>;
}
```

**ã“ã®æ–¹é‡ã‚’é¸æŠã—ãŸç†ç”±:**

âœ… **æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¸ã®å½±éŸ¿ã‚’æœ€å°åŒ–**

- CurrentLayoutProviderã®å¤‰æ›´ãŒä¸è¦
- æ—¢å­˜ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ã¨åˆ†é›¢
- æ®µéšçš„ãªå®Ÿè£…ã¨ãƒ†ã‚¹ãƒˆãŒå¯èƒ½

âœ… **ä¿å®ˆæ€§ã¨æ‹¡å¼µæ€§**

- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒä¸€ç®‡æ‰€ã«é›†ç´„
- å°†æ¥çš„ãªæ©Ÿèƒ½æ‹¡å¼µãŒå®¹æ˜“ï¼ˆä¾‹: è¤‡æ•°ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®æ¯”è¼ƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
- ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®ä½œæˆãŒå®¹æ˜“

âœ… **æ˜ç¢ºãªè²¬å‹™åˆ†é›¢**

- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ…‹ã®ç®¡ç†ãŒæ˜ç¢º
- ãƒ‡ãƒãƒƒã‚°ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒå®¹æ˜“
- ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§å‘ä¸Š

### èª²é¡Œ2: å…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã®ä¿å­˜ã¨å¾©å…ƒ

**å•é¡Œ:**

- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼å‰ã®çŠ¶æ…‹ã‚’ç¢ºå®Ÿã«ä¿å­˜ã™ã‚‹å¿…è¦ãŒã‚ã‚‹
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç·¨é›†å†…å®¹ã‚‚å«ã‚ã¦å¾©å…ƒã™ã‚‹å¿…è¦ãŒã‚ã‚‹

**è§£æ±ºç­–:**

```typescript
interface PreviewState {
  originalLayoutId: LayoutID;
  originalLayoutData: LayoutData; // å¿µã®ãŸã‚ãƒ‡ãƒ¼ã‚¿ã‚‚ä¿å­˜
  wasEdited: boolean;
}

// ä¿å­˜
const savePreviewState = (): PreviewState => {
  const currentState = getCurrentLayoutState();
  return {
    originalLayoutId: currentState.selectedLayout!.id,
    originalLayoutData: _.cloneDeep(currentState.selectedLayout!.data),
    wasEdited: currentState.selectedLayout!.edited ?? false,
  };
};

// å¾©å…ƒ
const restorePreviewState = async (state: PreviewState) => {
  await setSelectedLayoutId(state.originalLayoutId);
  // ç·¨é›†çŠ¶æ…‹ã‚‚å¾©å…ƒ
  if (state.wasEdited) {
    // ç·¨é›†ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
  }
};
```

### èª²é¡Œ3: ç¢ºèªUIã®å®Ÿè£…

**å•é¡Œ:**

- ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ä¸Šéƒ¨ã«å›ºå®šè¡¨ç¤ºã™ã‚‹UIãŒå¿…è¦
- æ—¢å­˜ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚·ã‚¹ãƒ†ãƒ ã¨å¹²æ¸‰ã—ãªã„é…ç½®

**è§£æ±ºç­–:**

```typescript
// PreviewConfirmationBanner.tsx
export function PreviewConfirmationBanner({
  layoutName,
  onConfirm,
  onCancel,
}: PreviewConfirmationBannerProps): React.JSX.Element {
  return (
    <Portal>
      <Box
        sx={{
          position: 'fixed',
          top: 0,
          left: 0,
          right: 0,
          zIndex: (theme) => theme.zIndex.snackbar,
          backgroundColor: 'rgba(0, 0, 0, 0.85)',
          backdropFilter: 'blur(10px)',
          borderBottom: '2px solid',
          borderColor: 'primary.main',
        }}
      >
        <Container maxWidth="lg">
          <Stack direction="row" spacing={2} alignItems="center" py={2}>
            <InfoIcon color="primary" />
            <Typography variant="body1" sx={{ flex: 1 }}>
              ã“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ "{layoutName}" ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ
            </Typography>
            <Button variant="contained" onClick={onConfirm}>
              ã™ãã«ä½¿ã†
            </Button>
            <Button variant="outlined" onClick={onCancel}>
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </Button>
          </Stack>
        </Container>
      </Box>
    </Portal>
  );
}
```

**é…ç½®æˆ¦ç•¥:**

- Portalã‚’ä½¿ç”¨ã—ã¦DOMãƒ„ãƒªãƒ¼ã®æœ€ä¸Šä½ã«é…ç½®
- z-indexã§ç¢ºå®Ÿã«æœ€å‰é¢è¡¨ç¤º
- å›ºå®šä½ç½®ï¼ˆfixedï¼‰ã§ç”»é¢ä¸Šéƒ¨ã«é…ç½®

---

## ã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆ

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Workspace (Main App)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚        PreviewConfirmationBanner (Portal)          â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              CurrentLayoutProvider                  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚         PreviewLayoutProvider               â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â”‚         PanelLayout                    â”‚ â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           AppSettingsDialog (Marketplace)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚        LayoutMarketplaceSettings                    â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚         MarketplaceCard                      â”‚  â”‚ â”‚
â”‚  â”‚  â”‚    [Install] [Preview]                       â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

#### 1. PreviewLayoutContext & Provider

**è²¬å‹™:**

- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®çŠ¶æ…‹ç®¡ç†
- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹/ç¢ºå®š/ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ãƒ­ã‚¸ãƒƒã‚¯
- å…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã®ä¿å­˜ã¨å¾©å…ƒ

```typescript
// PreviewLayoutContext.ts
export interface PreviewLayoutState {
  isPreviewMode: boolean;
  previewLayoutData: LayoutData | undefined;
  previewLayoutDetail: LayoutMarketplaceDetail | undefined;
  originalLayoutId: LayoutID | undefined;
  originalLayoutData: LayoutData | undefined;
}

export interface PreviewLayoutActions {
  startPreview: (detail: LayoutMarketplaceDetail, data: LayoutData) => Promise<void>;
  confirmPreview: () => Promise<void>;
  cancelPreview: () => Promise<void>;
}

export interface PreviewLayoutContext {
  state: PreviewLayoutState;
  actions: PreviewLayoutActions;
}
```

#### 2. PreviewConfirmationBanner

**è²¬å‹™:**

- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã®é€šçŸ¥UIè¡¨ç¤º
- ã™ãã«ä½¿ã†/ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®æä¾›

```typescript
// PreviewConfirmationBanner.tsx
export interface PreviewConfirmationBannerProps {
  layoutName: string;
  onConfirm: () => void | Promise<void>;
  onCancel: () => void | Promise<void>;
  loading?: boolean;
}

export function PreviewConfirmationBanner(props: PreviewConfirmationBannerProps): React.JSX.Element;
```

#### 3. LayoutMarketplaceSettingsï¼ˆæ‹¡å¼µï¼‰

**è²¬å‹™:**

- Previewãƒœã‚¿ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®è¿½åŠ 
- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã¸ã®é·ç§»

```typescript
// è¿½åŠ éƒ¨åˆ†
const { actions: previewActions } = usePreviewLayout();
const workspaceActions = useWorkspaceActions();

const handlePreview = useCallback(
  async (layout: LayoutMarketplaceDetail) => {
    try {
      // 1. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      const layoutData = await marketplace.downloadLayout(layout.layoutUrl);

      // 2. ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
      workspaceActions.dialogPreferencesClose();

      // 3. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
      await previewActions.startPreview(layout, layoutData);
    } catch (error) {
      enqueueSnackbar(`Failed to preview: ${error}`, { variant: "error" });
    }
  },
  [marketplace, previewActions, workspaceActions],
);
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

#### ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹ãƒ•ãƒ­ãƒ¼

```
1. User clicks "Preview" button
   â†“
2. LayoutMarketplaceSettings.handlePreview()
   â†“
3. marketplace.downloadLayout(url) - ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
   â†“
4. workspaceActions.dialogPreferencesClose() - ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
   â†“
5. previewActions.startPreview(detail, data)
   â”œâ”€ ç¾åœ¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã‚’ä¿å­˜
   â”œâ”€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°ã‚’ã‚»ãƒƒãƒˆ
   â””â”€ ä¸€æ™‚çš„ã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’é©ç”¨
   â†“
6. PreviewConfirmationBannerè¡¨ç¤º
   â†“
7. PanelLayoutã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’è¡¨ç¤º
```

#### ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºå®šãƒ•ãƒ­ãƒ¼

```
1. User clicks "ã™ãã«ä½¿ã†" button
   â†“
2. PreviewConfirmationBanner.onConfirm()
   â†“
3. previewActions.confirmPreview()
   â”œâ”€ catalog.installLayoutFromMarketplace() - æ­£å¼ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   â”œâ”€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°ã‚’è§£é™¤
   â””â”€ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«åˆ‡ã‚Šæ›¿ãˆ
   â†“
4. PreviewConfirmationBanneréè¡¨ç¤º
   â†“
5. æˆåŠŸé€šçŸ¥ã‚’è¡¨ç¤º
```

#### ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ•ãƒ­ãƒ¼

```
1. User clicks "ã‚­ãƒ£ãƒ³ã‚»ãƒ«" button
   â†“
2. PreviewConfirmationBanner.onCancel()
   â†“
3. previewActions.cancelPreview()
   â”œâ”€ ä¿å­˜ã—ã¦ãŠã„ãŸå…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’å¾©å…ƒ
   â”œâ”€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°ã‚’è§£é™¤
   â””â”€ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
   â†“
4. PreviewConfirmationBanneréè¡¨ç¤º
   â†“
5. workspaceActions.dialogPreferencesOpen() - ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å†åº¦é–‹ã
```

### çŠ¶æ…‹ç®¡ç†

```typescript
// PreviewLayoutProviderå†…éƒ¨ã®çŠ¶æ…‹
const [state, setState] = useState<PreviewLayoutState>({
  isPreviewMode: false,
  previewLayoutData: undefined,
  previewLayoutDetail: undefined,
  originalLayoutId: undefined,
  originalLayoutData: undefined,
});

// CurrentLayoutProviderã¨ã®é€£æº
const { actions: layoutActions, getCurrentLayoutState } = useCurrentLayoutActions();
```

---

## å®Ÿè£…è©³ç´°

### 1. PreviewLayoutContext & Provider

**ãƒ•ã‚¡ã‚¤ãƒ«:** `packages/suite-base/src/context/PreviewLayoutContext.tsx`

```typescript
// SPDX-FileCopyrightText: Copyright (C) 2023-2025 Bayerische Motoren Werke Aktiengesellschaft (BMW AG)<lichtblick@bmwgroup.com>
// SPDX-License-Identifier: MPL-2.0

import { createContext, useCallback, useState } from "react";
import _ from "lodash-es";
import { useSnackbar } from "notistack";

import { useGuaranteedContext } from "@lichtblick/hooks";
import { LayoutData, useCurrentLayoutActions, LayoutID } from "@lichtblick/suite-base/context/CurrentLayoutContext";
import { LayoutMarketplaceDetail } from "@lichtblick/suite-base/context/LayoutMarketplaceContext";
import { useLayoutCatalog } from "@lichtblick/suite-base/context/LayoutCatalogContext";

/**
 * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®çŠ¶æ…‹
 */
export interface PreviewLayoutState {
  /** ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ä¸­ã‹ã©ã†ã‹ */
  isPreviewMode: boolean;
  /** ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ */
  previewLayoutData: LayoutData | undefined;
  /** ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã®ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹è©³ç´°æƒ…å ± */
  previewLayoutDetail: LayoutMarketplaceDetail | undefined;
  /** å…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆID */
  originalLayoutId: LayoutID | undefined;
  /** å…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆå¾©å…ƒç”¨ï¼‰ */
  originalLayoutData: LayoutData | undefined;
}

/**
 * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
 */
export interface PreviewLayoutActions {
  /**
   * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‹å§‹
   * @param detail - ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã®è©³ç´°æƒ…å ±
   * @param data - ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿
   */
  startPreview: (detail: LayoutMarketplaceDetail, data: LayoutData) => Promise<void>;

  /**
   * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºå®šã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   */
  confirmPreview: () => Promise<void>;

  /**
   * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦å…ƒã«æˆ»ã™
   */
  cancelPreview: () => Promise<void>;
}

/**
 * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
 */
export interface PreviewLayoutContext {
  state: PreviewLayoutState;
  actions: PreviewLayoutActions;
}

const PreviewLayoutContextInternal = createContext<PreviewLayoutContext | undefined>(undefined);

/**
 * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½¿ç”¨ã™ã‚‹ãƒ•ãƒƒã‚¯
 */
export function usePreviewLayout(): PreviewLayoutContext {
  return useGuaranteedContext(PreviewLayoutContextInternal, "PreviewLayoutContext");
}

/**
 * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼
 */
export function PreviewLayoutProvider({
  children
}: React.PropsWithChildren): React.JSX.Element {
  const [state, setState] = useState<PreviewLayoutState>({
    isPreviewMode: false,
    previewLayoutData: undefined,
    previewLayoutDetail: undefined,
    originalLayoutId: undefined,
    originalLayoutData: undefined,
  });

  const { enqueueSnackbar } = useSnackbar();
  const catalog = useLayoutCatalog();
  const {
    actions: layoutActions,
    getCurrentLayoutState
  } = useCurrentLayoutActions();

  /**
   * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‹å§‹
   */
  const startPreview = useCallback(
    async (detail: LayoutMarketplaceDetail, data: LayoutData) => {
      try {
        // ç¾åœ¨ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã‚’ä¿å­˜
        const currentState = getCurrentLayoutState();
        const originalId = currentState.selectedLayout?.id;
        const originalData = currentState.selectedLayout?.data;

        if (!originalId || !originalData) {
          throw new Error("No layout is currently selected");
        }

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ…‹ã‚’è¨­å®š
        setState({
          isPreviewMode: true,
          previewLayoutData: data,
          previewLayoutDetail: detail,
          originalLayoutId: originalId,
          originalLayoutData: _.cloneDeep(originalData),
        });

        // ä¸€æ™‚çš„ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’é©ç”¨
        // Note: ã“ã‚Œã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã›ãšã«è¡¨ç¤ºã™ã‚‹ãŸã‚ã®ç‰¹åˆ¥ãªå‡¦ç†
        layoutActions.changePanelLayout({
          layout: data.layout,
          trimConfigById: false,
        });

        // ãƒ‘ãƒãƒ«è¨­å®šã‚’é©ç”¨
        layoutActions.savePanelConfigs({
          configs: Object.entries(data.configById).map(([id, config]) => ({
            id,
            config,
          })),
        });

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’é©ç”¨
        if (data.globalVariables) {
          layoutActions.setGlobalVariables(data.globalVariables);
        }

        // å†ç”Ÿè¨­å®šã‚’é©ç”¨
        if (data.playbackConfig) {
          layoutActions.setPlaybackConfig(data.playbackConfig);
        }

        enqueueSnackbar(`ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­: ${detail.name}`, { variant: "info" });
      } catch (error) {
        enqueueSnackbar(`Failed to start preview: ${error}`, { variant: "error" });
        throw error;
      }
    },
    [getCurrentLayoutState, layoutActions, enqueueSnackbar]
  );

  /**
   * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºå®šã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
   */
  const confirmPreview = useCallback(async () => {
    try {
      if (!state.isPreviewMode || !state.previewLayoutDetail) {
        throw new Error("Not in preview mode");
      }

      // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’æ­£å¼ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      const result = await catalog.installLayoutFromMarketplace(
        state.previewLayoutDetail,
        state.previewLayoutDetail.name
      );

      if (!result.success) {
        throw new Error(result.error?.toString() ?? "Installation failed");
      }

      // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«åˆ‡ã‚Šæ›¿ãˆ
      if (result.layout) {
        await layoutActions.setSelectedLayoutId(result.layout.id);
      }

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
      setState({
        isPreviewMode: false,
        previewLayoutData: undefined,
        previewLayoutDetail: undefined,
        originalLayoutId: undefined,
        originalLayoutData: undefined,
      });

      enqueueSnackbar(`${state.previewLayoutDetail.name} ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã—ãŸ`, {
        variant: "success",
      });
    } catch (error) {
      enqueueSnackbar(`Failed to confirm preview: ${error}`, { variant: "error" });
      throw error;
    }
  }, [state, catalog, layoutActions, enqueueSnackbar]);

  /**
   * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦å…ƒã«æˆ»ã™
   */
  const cancelPreview = useCallback(async () => {
    try {
      if (!state.isPreviewMode || !state.originalLayoutId || !state.originalLayoutData) {
        throw new Error("Cannot cancel: invalid preview state");
      }

      // å…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«æˆ»ã™
      await layoutActions.setSelectedLayoutId(state.originalLayoutId);

      // å¿µã®ãŸã‚å…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã‚‚å¾©å…ƒ
      layoutActions.changePanelLayout({
        layout: state.originalLayoutData.layout,
        trimConfigById: false,
      });

      layoutActions.savePanelConfigs({
        configs: Object.entries(state.originalLayoutData.configById).map(([id, config]) => ({
          id,
          config,
        })),
      });

      if (state.originalLayoutData.globalVariables) {
        layoutActions.setGlobalVariables(state.originalLayoutData.globalVariables);
      }

      if (state.originalLayoutData.playbackConfig) {
        layoutActions.setPlaybackConfig(state.originalLayoutData.playbackConfig);
      }

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ…‹ã‚’ã‚¯ãƒªã‚¢
      setState({
        isPreviewMode: false,
        previewLayoutData: undefined,
        previewLayoutDetail: undefined,
        originalLayoutId: undefined,
        originalLayoutData: undefined,
      });

      enqueueSnackbar("ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ", { variant: "info" });
    } catch (error) {
      enqueueSnackbar(`Failed to cancel preview: ${error}`, { variant: "error" });
      throw error;
    }
  }, [state, layoutActions, enqueueSnackbar]);

  const value: PreviewLayoutContext = {
    state,
    actions: {
      startPreview,
      confirmPreview,
      cancelPreview,
    },
  };

  return (
    <PreviewLayoutContextInternal.Provider value={value}>
      {children}
    </PreviewLayoutContextInternal.Provider>
  );
}
```

### 2. PreviewConfirmationBanner

**ãƒ•ã‚¡ã‚¤ãƒ«:** `packages/suite-base/src/components/PreviewConfirmationBanner.tsx`

```typescript
// SPDX-FileCopyrightText: Copyright (C) 2023-2025 Bayerische Motoren Werke Aktiengesellschaft (BMW AG)<lichtblick@bmwgroup.com>
// SPDX-License-Identifier: MPL-2.0

import { InfoOutlined as InfoIcon } from "@mui/icons-material";
import { Box, Button, Container, Portal, Stack, Typography } from "@mui/material";
import { useState } from "react";

export interface PreviewConfirmationBannerProps {
  /** ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå */
  layoutName: string;
  /** ç¢ºå®šãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ */
  onConfirm: () => void | Promise<void>;
  /** ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ */
  onCancel: () => void | Promise<void>;
  /** ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ */
  loading?: boolean;
}

/**
 * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºèªãƒãƒŠãƒ¼
 *
 * ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ä¸­ã«ç”»é¢ä¸Šéƒ¨ã«è¡¨ç¤ºã•ã‚Œã‚‹ç¢ºèªUI
 */
export function PreviewConfirmationBanner({
  layoutName,
  onConfirm,
  onCancel,
  loading = false,
}: PreviewConfirmationBannerProps): React.JSX.Element {
  const [isConfirming, setIsConfirming] = useState(false);
  const [isCanceling, setIsCanceling] = useState(false);

  const handleConfirm = async () => {
    setIsConfirming(true);
    try {
      await onConfirm();
    } finally {
      setIsConfirming(false);
    }
  };

  const handleCancel = async () => {
    setIsCanceling(true);
    try {
      await onCancel();
    } finally {
      setIsCanceling(false);
    }
  };

  return (
    <Portal>
      <Box
        sx={{
          position: "fixed",
          top: 0,
          left: 0,
          right: 0,
          zIndex: (theme) => theme.zIndex.snackbar,
          backgroundColor: "rgba(0, 0, 0, 0.90)",
          backdropFilter: "blur(10px)",
          borderBottom: "2px solid",
          borderColor: "primary.main",
          boxShadow: (theme) => theme.shadows[8],
        }}
      >
        <Container maxWidth="lg">
          <Stack
            direction="row"
            spacing={2}
            alignItems="center"
            py={2}
            sx={{ minHeight: "64px" }}
          >
            <InfoIcon
              color="primary"
              sx={{ fontSize: 28 }}
            />
            <Box sx={{ flex: 1 }}>
              <Typography variant="h6" component="div" gutterBottom>
                ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
              </Typography>
              <Typography variant="body2" color="text.secondary">
                ã“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ <strong>"{layoutName}"</strong> ã‚’ä½¿ç”¨ã—ã¾ã™ã‹ï¼Ÿ
              </Typography>
            </Box>
            <Button
              variant="contained"
              color="primary"
              onClick={handleConfirm}
              disabled={loading || isConfirming || isCanceling}
              sx={{ minWidth: 120 }}
            >
              {isConfirming ? "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..." : "ã™ãã«ä½¿ã†"}
            </Button>
            <Button
              variant="outlined"
              onClick={handleCancel}
              disabled={loading || isConfirming || isCanceling}
              sx={{ minWidth: 120 }}
            >
              {isCanceling ? "æˆ»ã—ã¦ã„ã¾ã™..." : "ã‚­ãƒ£ãƒ³ã‚»ãƒ«"}
            </Button>
          </Stack>
        </Container>
      </Box>
    </Portal>
  );
}
```

### 3. LayoutMarketplaceSettings ã®æ‹¡å¼µ

**ãƒ•ã‚¡ã‚¤ãƒ«:** `packages/suite-base/src/components/LayoutMarketplaceSettings.tsx`

```typescript
// æ—¢å­˜ã®importã«è¿½åŠ 
import { usePreviewLayout } from "@lichtblick/suite-base/context/PreviewLayoutContext";
import { useWorkspaceActions } from "@lichtblick/suite-base/context/Workspace/useWorkspaceActions";

export default function LayoutMarketplaceSettings({
  className,
}: LayoutMarketplaceSettingsProps): React.ReactElement {
  // æ—¢å­˜ã®hooksã«è¿½åŠ 
  const { actions: previewActions } = usePreviewLayout();
  const workspaceActions = useWorkspaceActions();

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’è¿½åŠ 
  const handlePreview = useCallback(
    async (layout: LayoutMarketplaceDetail) => {
      try {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¨­å®š
        setInstallingIds((prev) => new Set(prev).add(layout.id));

        // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const layoutData = await marketplace.downloadLayout(layout.layoutUrl);

        // ãƒ‡ãƒ¼ã‚¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        const isValid = await catalog.validateLayoutData?.(layoutData);
        if (isValid === false) {
          throw new Error("Invalid layout data");
        }

        // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
        workspaceActions.dialogPreferencesClose();

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹
        await previewActions.startPreview(layout, layoutData);
      } catch (error) {
        enqueueSnackbar(
          `Failed to preview layout: ${error instanceof Error ? error.message : String(error)}`,
          { variant: "error" }
        );
      } finally {
        setInstallingIds((prev) => {
          const next = new Set(prev);
          next.delete(layout.id);
          return next;
        });
      }
    },
    [marketplace, catalog, previewActions, workspaceActions, enqueueSnackbar]
  );

  return (
    <Stack gap={3} className={className}>
      {/* æ—¢å­˜ã®ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <MarketplaceHeader /* ... */ />

      <MarketplaceGrid>
        {filteredLayouts.map((layout, index) => {
          const testThumbnail =
            index % 3 === 0 ? `https://picsum.photos/120/120?random=${index}` : layout.thumbnail;

          return (
            <MarketplaceCard
              key={layout.id}
              name={layout.name}
              description={layout.description}
              author={layout.author}
              version={layout.updatedAt}
              tags={layout.tags}
              installed={false}
              loading={installingIds.has(layout.id)}
              onTagClick={handleTagClick}
              selectedTags={selectedTags}
              onInstall={async () => {
                await installLayout(layout);
              }}
              // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
              onViewDetails={async () => {
                await handlePreview(layout);
              }}
              thumbnail={testThumbnail}
              icon={<ViewQuiltIcon style={{ fontSize: "24px" }} />}
            />
          );
        })}
      </MarketplaceGrid>
    </Stack>
  );
}
```

### 4. Workspace ã¸ã®çµ±åˆ

**ãƒ•ã‚¡ã‚¤ãƒ«:** `packages/suite-base/src/Workspace.tsx`

```typescript
// Importã«è¿½åŠ 
import { PreviewConfirmationBanner } from "@lichtblick/suite-base/components/PreviewConfirmationBanner";
import { usePreviewLayout } from "@lichtblick/suite-base/context/PreviewLayoutContext";
import { useWorkspaceActions } from "@lichtblick/suite-base/context/Workspace/useWorkspaceActions";

function WorkspaceContent(props: WorkspaceProps): React.JSX.Element {
  // æ—¢å­˜ã®hooksã«è¿½åŠ 
  const { state: previewState, actions: previewActions } = usePreviewLayout();
  const workspaceActions = useWorkspaceActions();

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºå®šãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleConfirmPreview = useCallback(async () => {
    await previewActions.confirmPreview();
  }, [previewActions]);

  // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
  const handleCancelPreview = useCallback(async () => {
    await previewActions.cancelPreview();
    // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’å†åº¦é–‹ã
    workspaceActions.dialogPreferencesOpen("layouts");
  }, [previewActions, workspaceActions]);

  return (
    <>
      {/* ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç¢ºèªãƒãƒŠãƒ¼ */}
      {previewState.isPreviewMode && previewState.previewLayoutDetail && (
        <PreviewConfirmationBanner
          layoutName={previewState.previewLayoutDetail.name}
          onConfirm={handleConfirmPreview}
          onCancel={handleCancelPreview}
        />
      )}

      {/* æ—¢å­˜ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */}
      <Stack /* ... */>
        {/* ... */}
      </Stack>
    </>
  );
}
```

### 5. StudioApp ã¸ã® Provider è¿½åŠ 

**ãƒ•ã‚¡ã‚¤ãƒ«:** `packages/suite-base/src/StudioApp.tsx`

```typescript
// Importã«è¿½åŠ 
import { PreviewLayoutProvider } from "@lichtblick/suite-base/context/PreviewLayoutContext";

export default function StudioApp(props: StudioAppProps): JSX.Element {
  // providersã®è¨­å®šéƒ¨åˆ†ã§è¿½åŠ 
  const providers = [
    /* æ—¢å­˜ã®providers */
    <CurrentLayoutProvider />,
    <PreviewLayoutProvider />, // â† è¿½åŠ ï¼ˆCurrentLayoutProviderã®å¾Œï¼‰
    /* ä»–ã®providers */
  ];

  return (
    <MultiProvider providers={providers}>
      {/* ... */}
    </MultiProvider>
  );
}
```

### 6. LayoutMarketplaceSettings ã§ã®ãƒœã‚¿ãƒ³è¡¨ç¤º

**æ–¹é‡:**

- `LayoutMarketplaceSettings` ã§ã¯ `onViewDetails` ãƒ—ãƒ­ãƒƒãƒ—ã‚’ä½¿ç”¨
- `MarketplaceCard` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯æ—¢å­˜ã®ã¾ã¾ä½¿ç”¨ï¼ˆå¤‰æ›´ä¸è¦ï¼‰
- `ActionButtons` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚‚å¤‰æ›´ä¸è¦
- ãƒœã‚¿ãƒ³ãƒ©ãƒ™ãƒ«ã¯ `ActionButtons` å†…ã§è‡ªå‹•çš„ã«ã€Œè©³ç´°ã€ã¾ãŸã¯ã€Œãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹

**å®Ÿè£…:** `packages/suite-base/src/components/LayoutMarketplaceSettings.tsx`

```typescript
// LayoutMarketplaceSettings.tsx ã§ã®ä½¿ç”¨ä¾‹
return (
  <MarketplaceGrid>
    {filteredLayouts.map((layout) => (
      <MarketplaceCard
        key={layout.id}
        name={layout.name}
        description={layout.description}
        // ... ä»–ã®ãƒ—ãƒ­ãƒƒãƒ—
        onInstall={async () => {
          await installLayout(layout);
        }}
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã‚’ onViewDetails ã«æ¸¡ã™
        onViewDetails={async () => {
          await handlePreview(layout);
        }}
      />
    ))}
  </MarketplaceGrid>
);
```

**æ³¨æ„:**

- `ExtensionMarketplaceSettings` ã§ã¯å¼•ãç¶šã `onViewDetails` ã§è©³ç´°ç”»é¢ã‚’è¡¨ç¤º
- `ActionButtons` ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¯ä¸¡æ–¹ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã«å¯¾å¿œï¼ˆå¤‰æ›´ä¸è¦ï¼‰
- ãƒœã‚¿ãƒ³ãƒ©ãƒ™ãƒ«ã®è¡¨ç¤ºã¯å„ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹è¨­å®šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§åˆ¶å¾¡ã•ã‚Œã‚‹

````

---

## å®Ÿè£…æ‰‹é †

### ãƒ•ã‚§ãƒ¼ã‚º1: åŸºç›¤å®Ÿè£…ï¼ˆ2-3æ—¥ï¼‰

#### Day 1: PreviewLayoutContext & Provider

1. **ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ**

   - `packages/suite-base/src/context/PreviewLayoutContext.tsx`

2. **å®Ÿè£…å†…å®¹**

   - PreviewLayoutStateå‹å®šç¾©
   - PreviewLayoutActionså‹å®šç¾©
   - PreviewLayoutProviderå®Ÿè£…
   - usePreviewLayoutãƒ•ãƒƒã‚¯å®Ÿè£…

3. **ãƒ†ã‚¹ãƒˆ**
   - å˜ä½“ãƒ†ã‚¹ãƒˆä½œæˆ
   - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ…‹ã®ç®¡ç†ãƒ†ã‚¹ãƒˆ
   - çŠ¶æ…‹é·ç§»ã®ãƒ†ã‚¹ãƒˆ

#### Day 2: PreviewConfirmationBanner

1. **ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ**

   - `packages/suite-base/src/components/PreviewConfirmationBanner.tsx`
   - `packages/suite-base/src/components/PreviewConfirmationBanner.stories.tsx`

2. **å®Ÿè£…å†…å®¹**

   - ãƒãƒŠãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…
   - Portalã‚’ä½¿ç”¨ã—ãŸå›ºå®šé…ç½®
   - ãƒœã‚¿ãƒ³ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ç®¡ç†

3. **ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°**

   - åŠé€æ˜èƒŒæ™¯
   - ã¼ã‹ã—åŠ¹æœ
   - ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ

4. **ãƒ†ã‚¹ãƒˆ**
   - Storybookã§ã®ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ†ã‚¹ãƒˆ
   - ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ

#### Day 3: Workspaceçµ±åˆ

1. **Providerã®è¿½åŠ **

   - StudioApp.tsxã«PreviewLayoutProviderã‚’è¿½åŠ 
   - ä¾å­˜é–¢ä¿‚ã®ç¢ºèª

2. **Workspaceã¸ã®çµ„ã¿è¾¼ã¿**

   - PreviewConfirmationBannerã®é…ç½®
   - ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®æ¥ç¶š

3. **çµ±åˆãƒ†ã‚¹ãƒˆ**
   - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®å‹•ä½œç¢ºèª
   - ãƒãƒŠãƒ¼è¡¨ç¤º/éè¡¨ç¤ºã®ãƒ†ã‚¹ãƒˆ

### ãƒ•ã‚§ãƒ¼ã‚º2: ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹çµ±åˆï¼ˆ2-3æ—¥ï¼‰

#### Day 4: LayoutMarketplaceSettingsæ‹¡å¼µ

1. **å®Ÿè£…å†…å®¹**

   - handlePreviewãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¿½åŠ 
   - ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

2. **MarketplaceCardçµ±åˆ**

   - onViewDetailsãƒ—ãƒ­ãƒƒãƒ—ã®æ´»ç”¨
   - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã®è¡¨ç¤º

3. **ãƒ†ã‚¹ãƒˆ**
   - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
   - ãƒ€ã‚¤ã‚¢ãƒ­ã‚°é–‹é–‰ã®ãƒ†ã‚¹ãƒˆ

#### Day 5: ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼æ¥ç¶š

1. **å®Ÿè£…å†…å®¹**

   - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼é–‹å§‹æ™‚ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆé©ç”¨
   - å…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆçŠ¶æ…‹ã®ä¿å­˜
   - å¾©å…ƒå‡¦ç†ã®å®Ÿè£…

2. **ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®çµ±åˆ**

   - dialogPreferencesCloseã®å‘¼ã³å‡ºã—
   - dialogPreferencesOpenã®å‘¼ã³å‡ºã—

3. **ãƒ†ã‚¹ãƒˆ**
   - ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ
   - ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ãƒ†ã‚¹ãƒˆ

### ãƒ•ã‚§ãƒ¼ã‚º3: ä»•ä¸Šã’ã¨ãƒ†ã‚¹ãƒˆï¼ˆ2-3æ—¥ï¼‰

#### Day 6-7: ãƒã‚°ä¿®æ­£ã¨ãƒªãƒ•ã‚¡ã‚¤ãƒ³ãƒ¡ãƒ³ãƒˆ

1. **ãƒã‚°ä¿®æ­£**

   - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã®ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹å¯¾å¿œ
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„
   - UIã®å¾®èª¿æ•´

2. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**

   - ä¸è¦ãªå†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®å‰Šæ¸›
   - ãƒ¡ãƒ¢åŒ–ã®æœ€é©åŒ–

3. **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆ**
   - ã‚³ãƒ¼ãƒ‰ã‚³ãƒ¡ãƒ³ãƒˆã®è¿½åŠ 
   - ä½¿ç”¨æ–¹æ³•ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
   - ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰

#### Day 8: ç·åˆãƒ†ã‚¹ãƒˆ

1. **ãƒ†ã‚¹ãƒˆã‚·ãƒŠãƒªã‚ªå®Ÿè¡Œ**

   - æ­£å¸¸ç³»ãƒ•ãƒ­ãƒ¼
   - ç•°å¸¸ç³»ãƒ•ãƒ­ãƒ¼
   - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹

2. **ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ**

   - UIã®ä½¿ã„ã‚„ã™ã•ç¢ºèª
   - ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†

3. **ãƒªãƒªãƒ¼ã‚¹æº–å‚™**
   - ãƒãƒ¼ã‚¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ
   - ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯¾å¿œ

---

## ãƒ†ã‚¹ãƒˆè¨ˆç”»

### å˜ä½“ãƒ†ã‚¹ãƒˆ

#### PreviewLayoutProvider

```typescript
describe("PreviewLayoutProvider", () => {
  it("should start preview mode", async () => {
    // ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
  });

  it("should confirm preview and install layout", async () => {
    // ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
  });

  it("should cancel preview and restore original layout", async () => {
    // ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
  });

  it("should handle errors during preview", async () => {
    // ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
  });
});
````

#### PreviewConfirmationBanner

```typescript
describe("PreviewConfirmationBanner", () => {
  it("should render with layout name", () => {
    // ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
  });

  it("should call onConfirm when confirm button is clicked", () => {
    // ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
  });

  it("should call onCancel when cancel button is clicked", () => {
    // ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
  });

  it("should disable buttons when loading", () => {
    // ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰
  });
});
```

### çµ±åˆãƒ†ã‚¹ãƒˆ

```typescript
describe("Layout Preview Integration", () => {
  it("should preview layout from marketplace", async () => {
    // 1. ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ã‚’é–‹ã
    // 2. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’é¸æŠ
    // 3. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    // 4. ãƒãƒŠãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    // 5. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒé©ç”¨ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
  });

  it("should install layout after preview confirmation", async () => {
    // 1. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹
    // 2. ç¢ºå®šãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    // 3. ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
    // 4. ãƒãƒŠãƒ¼ãŒæ¶ˆãˆã‚‹ã“ã¨ã‚’ç¢ºèª
  });

  it("should restore original layout after preview cancellation", async () => {
    // 1. ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹
    // 2. ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    // 3. å…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«æˆ»ã‚‹ã“ã¨ã‚’ç¢ºèª
    // 4. ãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹ãŒå†åº¦é–‹ãã“ã¨ã‚’ç¢ºèª
  });
});
```

### E2Eãƒ†ã‚¹ãƒˆ

```typescript
describe("Layout Preview E2E", () => {
  it("complete preview workflow", async () => {
    // å®Œå…¨ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆ
  });

  it("handles network errors gracefully", async () => {
    // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã®æŒ™å‹•ãƒ†ã‚¹ãƒˆ
  });

  it("maintains data consistency", async () => {
    // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã®ãƒ†ã‚¹ãƒˆ
  });
});
```

---

## ãƒªã‚¹ã‚¯ã¨å¯¾å¿œç­–

### ãƒªã‚¹ã‚¯1: ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã®ä¸æ•´åˆ

**ãƒªã‚¹ã‚¯:**

- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã«ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ãŒç ´æã™ã‚‹
- å…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã«æˆ»ã›ãªããªã‚‹

**å¯¾å¿œç­–:**

- å…ƒã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¯ãƒ­ãƒ¼ãƒ³ã§ä¿å­˜
- try-catch-finallyã§ç¢ºå®Ÿãªå¾©å…ƒå‡¦ç†
- ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚’å®Ÿè£…

### ãƒªã‚¹ã‚¯2: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿

**ãƒªã‚¹ã‚¯:**

- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆãŒé…ã„
- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«æ™‚é–“ãŒã‹ã‹ã‚‹

**å¯¾å¿œç­–:**

- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã®æ˜ç¤º
- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- éåŒæœŸå‡¦ç†ã®æœ€é©åŒ–

### ãƒªã‚¹ã‚¯3: æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿

**ãƒªã‚¹ã‚¯:**

- CurrentLayoutProviderã®å‹•ä½œã«å½±éŸ¿
- ä»–ã®æ©Ÿèƒ½ã¨ã®ç«¶åˆ

**å¯¾å¿œç­–:**

- æ–°ã—ã„Contextã§ç‹¬ç«‹ç®¡ç†
- æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã¸ã®å½±éŸ¿ã‚’æœ€å°é™ã«
- ååˆ†ãªçµ±åˆãƒ†ã‚¹ãƒˆ

### ãƒªã‚¹ã‚¯4: UIã®è¤‡é›‘åŒ–

**ãƒªã‚¹ã‚¯:**

- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒãƒŠãƒ¼ãŒä»–ã®UIã¨å¹²æ¸‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ··ä¹±ã™ã‚‹

**å¯¾å¿œç­–:**

- z-indexã§ç¢ºå®Ÿã«æœ€å‰é¢è¡¨ç¤º
- æ˜ç¢ºãªãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³
- ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆã®å®Ÿæ–½

---

## è£œè¶³äº‹é …

### é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- [Layout API Impact Analysis](./layout-api-impact-analysis.md)
- [Layout Documentation](./guides/layout-documentation.md)
- [Extension Detail Implementation](../components/ExtensionsSettings/ExtensionDetail.tsx)

---

## ã¾ã¨ã‚

ã“ã®å®Ÿè£…è¨ˆç”»ã«ã‚ˆã‚Šã€ä»¥ä¸‹ãŒå®Ÿç¾ã•ã‚Œã¾ã™ï¼š

### å®Ÿç¾ã•ã‚Œã‚‹æ©Ÿèƒ½

âœ… **ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½**

- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å‰ã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã‚‹
- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¸­ã§ã‚ã‚‹ã“ã¨ãŒæ˜ç¢ºã«åˆ†ã‹ã‚‹UI
- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰ç›´æ¥ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€ã¾ãŸã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦å…ƒã«æˆ»ã›ã‚‹

âœ… **æŠ€è¡“çš„ãªå“è³ª**

- æ–°ã—ã„Context APIï¼ˆ`PreviewLayoutContext`ï¼‰ã«ã‚ˆã‚‹ç‹¬ç«‹ã—ãŸçŠ¶æ…‹ç®¡ç†
- æ—¢å­˜ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚·ã‚¹ãƒ†ãƒ ã¸ã®å½±éŸ¿ã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹
- æ‹¡å¼µæ€§ã®é«˜ã„ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- Extension ã¨ Layout ã§ç•°ãªã‚‹UIï¼ˆDetailãƒœã‚¿ãƒ³ã¨Previewãƒœã‚¿ãƒ³ï¼‰ã‚’é©åˆ‡ã«ä½¿ã„åˆ†ã‘

âœ… **ä¿å®ˆæ€§ã¨æ‹¡å¼µæ€§**

- æ˜ç¢ºãªè²¬å‹™åˆ†é›¢
- ãƒ†ã‚¹ãƒˆã—ã‚„ã™ã„è¨­è¨ˆ
- å°†æ¥çš„ãªæ©Ÿèƒ½æ‹¡å¼µãŒå®¹æ˜“

### å®Ÿè£…æ–¹é‡ã®ãƒã‚¤ãƒ³ãƒˆ

1. **Context API ã«ã‚ˆã‚‹ç‹¬ç«‹ç®¡ç†**: PreviewLayoutContext ã‚’æ–°è¦ä½œæˆã—ã€CurrentLayoutProvider ã¸ã®å½±éŸ¿ã‚’æœ€å°åŒ–
2. **æ—¢å­˜ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ´»ç”¨**: MarketplaceCard ã® `onViewDetails` ãƒ—ãƒ­ãƒƒãƒ—ã‚’ä½¿ç”¨
3. **æ®µéšçš„ãªå®Ÿè£…**: ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã«å®Ÿè£…ãƒ»ãƒ†ã‚¹ãƒˆã‚’è¡Œã„ã€ãƒªã‚¹ã‚¯ã‚’æœ€å°åŒ–

### æ¨å®šå·¥æ•°

- **å®Ÿè£…æœŸé–“**: 6-8æ—¥
- **å·¥æ•°**: 1äºº x 6-8æ—¥
- **å†…è¨³**:
  - ãƒ•ã‚§ãƒ¼ã‚º1ï¼ˆåŸºç›¤å®Ÿè£…ï¼‰: 2-3æ—¥
  - ãƒ•ã‚§ãƒ¼ã‚º2ï¼ˆãƒãƒ¼ã‚±ãƒƒãƒˆãƒ—ãƒ¬ã‚¤ã‚¹çµ±åˆï¼‰: 2-3æ—¥
  - ãƒ•ã‚§ãƒ¼ã‚º3ï¼ˆä»•ä¸Šã’ã¨ãƒ†ã‚¹ãƒˆï¼‰: 2-3æ—¥

---

**ä½œæˆæ—¥:** 2025-10-03
**æœ€çµ‚æ›´æ–°:** 2025-10-03
