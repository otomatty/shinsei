# 拡張機能ID自動変換仕様書

> **作成日**: 2025年9月30日
> **ステータス**: 🔴 Phase 3実装予定（Week 5-6）
> **優先度**: 高優先
> **関連**: [IMPLEMENTATION_ACTION_PLAN.md](../IMPLEMENTATION_ACTION_PLAN.md#phase-3-id変換機能week-5-6)

## 📖 概要

このドキュメントは、既存の拡張機能ID形式（`publisher.name`）から新しいバージョン付きID形式（`publisher.name@version`）への自動変換機能の仕様を定義します。

### 目的

1. **既存ユーザーへの影響最小化**: インストール済み拡張機能を自動的に新形式に変換
2. **データ整合性の保証**: 変換前後でデータの整合性を維持
3. **安全なマイグレーション**: ロールバック機能により、問題発生時に元の状態に戻せる
4. **透過的な移行**: ユーザーが意識せずに新形式に移行

### スコープ

- ID変換のトリガータイミング
- 変換対象データの特定
- 変換アルゴリズム
- ロールバック手順
- エラーハンドリング
- ユーザー通知（必要に応じて）

## 🎯 主要機能

### 1. 自動変換トリガー

**概要**:
拡張機能ID変換が実行されるタイミングを定義します。

**想定トリガーポイント**:

- アプリケーション起動時
- 拡張機能データ読み込み時
- 特定のバージョンアップデート時
- 手動トリガー（開発・デバッグ用）

**詳細**: 実装時に最適なタイミングを決定

### 2. 変換対象データの解析

**概要**:
どのデータを変換する必要があるかを特定します。

**解析対象**:

```typescript
// 概要のみ
interface MigrationTargets {
  installedExtensions: string[]; // インストール済み拡張機能リスト
  layoutConfigurations: Layout[]; // レイアウト設定内の拡張機能参照
  userPreferences: Settings[]; // ユーザー設定内の拡張機能参照
  // その他の参照箇所
}
```

**詳細**: 実装時に全データソースを洗い出し

### 3. 変換アルゴリズム

**概要**:
旧形式のIDを新形式に変換するロジックを定義します。

**基本変換ロジック**:

```
旧形式: "publisher.extension-name"
        ↓
新形式: "publisher.extension-name@1.0.0"
```

**考慮事項**:

- バージョン情報の取得方法（インストール済みメタデータから？）
- バージョン情報が不明な場合の処理
- 複数バージョンがインストールされている場合の処理

**詳細**: 実装時にエッジケースを含めて定義

### 4. データ保存とロールバック

**概要**:
変換前のデータをバックアップし、問題発生時に元に戻せる機能を提供します。

**バックアップ戦略**:

- 変換前のデータをローカルストレージに保存
- タイムスタンプ付きバックアップ
- 複数世代管理（オプション）

**ロールバック条件**:

- 変換エラー発生時
- データ検証失敗時
- ユーザーの手動リクエスト（開発・デバッグ用）

**詳細**: 実装時に具体的な保存形式とロールバック手順を定義

### 5. エラーハンドリング

**概要**:
変換中に発生する可能性のあるエラーの処理方法を定義します。

**想定エラーケース**:

- バージョン情報が見つからない
- データ形式が不正
- ストレージ書き込みエラー
- 変換済みデータと未変換データの混在

**エラー時の動作**:

- ロールバック実行
- エラーログ記録
- ユーザー通知（必要に応じて）

**詳細**: 実装時に全エラーケースをリストアップ

## 🔄 変換フロー（概要）

```
1. アプリ起動 / トリガー検出
   ↓
2. 変換必要性の判定
   ↓
3. 変換対象データの収集
   ↓
4. データのバックアップ
   ↓
5. ID変換実行
   ↓
6. データ検証
   ↓
7. 変換結果の保存
   ↓
8. 完了 or エラー時ロールバック
```

**詳細**: 実装時に各ステップの詳細処理を記載

## 📋 実装タスク（概要）

### Phase 3: Week 5-6

1. **変換ユーティリティ作成**: ID変換関数の実装
2. **バックアップ機能実装**: データ保存・復元機能
3. **自動マイグレーション実装**: トリガー検出と自動実行
4. **テスト**: 各種エッジケースのテスト
5. **ドキュメント更新**: 詳細仕様の追記

**詳細手順**: 実装時に追加

## 🧪 テストケース（概要）

実装時に以下のテストケースを詳細化:

- [ ] 正常系: 単一拡張機能の変換
- [ ] 正常系: 複数拡張機能の一括変換
- [ ] 異常系: バージョン情報なし
- [ ] 異常系: 不正なデータ形式
- [ ] 異常系: ストレージエラー
- [ ] ロールバック: 変換失敗時の復元
- [ ] 冪等性: 複数回実行時の動作

## 🔗 関連ドキュメント

- [IMPLEMENTATION_ACTION_PLAN.md](../IMPLEMENTATION_ACTION_PLAN.md) - 全体実装計画
- [versioned-extension-ids.md](./versioned-extension-ids.md) - バージョン付きID実装
- [extension-version-migration-implementation-plan.md](../planning/extension-version-migration-implementation-plan.md) - 移行計画（プランA）
- [MARKETPLACE_FEATURES.md](../MARKETPLACE_FEATURES.md) - 機能仕様

## 📝 実装時の追加項目

実装時に以下の項目を詳細化する予定:

- [ ] 詳細な変換アルゴリズム（全パターン網羅）
- [ ] データスキーマ定義（変換前後）
- [ ] バックアップデータ形式
- [ ] ロールバック手順の詳細
- [ ] ユーザー通知UI（必要な場合）
- [ ] パフォーマンス最適化
- [ ] セキュリティ考慮事項

## 💡 実装時の検討事項

- バージョン情報が不明な拡張機能のデフォルトバージョン（例: `1.0.0`）
- レイアウト設定内の拡張機能参照の変換方法
- 変換実行のタイミング（起動時 vs 初回アクセス時）
- ユーザーへの通知の必要性
- 段階的な移行 vs 一括移行

**詳細**: 実装開始時にチームで議論・決定

---

**Document Version**: 1.0.0 (概要版)
**Next Update**: Phase 3実装開始時
**Maintained by**: Lichtblick Development Team
