# マーケットプレイス機能 実装アクションプラン

> **作成日**: 2025年9月30日
> **ステータス**: 実装方針確定・タスク実行準備中
> **前提**: [不整合対応方針書](./INCONSISTENCIES_RESOLUTION.md)の検討結果を反映
> **目的**: 正式リリースに向けた具体的な実装計画とタスク順序の明確化

---

## 📋 目次

1. [概要](#概要)
2. [確定した実装方針](#確定した実装方針)
3. [必要な詳細ドキュメント一覧](#必要な詳細ドキュメント一覧)
4. [実装タスクの依存関係](#実装タスクの依存関係)
5. [推奨実装順序](#推奨実装順序)
6. [フェーズ別実装計画](#フェーズ別実装計画)
7. [リスク管理](#リスク管理)

---

## 概要

本ドキュメントは、マーケットプレイス機能の不整合解消および正式リリースに向けた実装計画をまとめたものです。各不整合について確定した方針に基づき、以下を明確化します:

- **実装方針の整理**: 7つの不整合に対する最終決定事項
- **詳細ドキュメント**: 各機能実装に必要な詳細仕様書の特定
- **タスク順序**: 依存関係を考慮した最適な実装順序
- **工数見積もり**: 各フェーズの作業量と期間

---

## 確定した実装方針

### 1️⃣ バージョン管理方式 - 段階的マルチバージョン完全移行

#### 📌 確定方針

**開発段階でマルチバージョンに完全移行し、正式リリース時には既にマルチバージョン対応完了状態にする**

#### 🎯 実装ステップ

1. **開発サーバー準備**

   - 既存の`extensions.json`を使用しない
   - マルチバージョン対応の新しい`extensions.json`を作成
   - 開発環境専用のマーケットプレイスサーバーを構築

2. **マルチバージョン対応実装**

   - HybridExtensionLoaderをマルチバージョン専用に最適化
   - レガシー形式のサポートコードを段階的に削除
   - バージョン選択UI実装

3. **正式リリース時の状態**
   - ✅ 完全なマルチバージョン対応
   - ✅ レガシー形式のサポート不要
   - ✅ シンプルで保守しやすいコード

#### 📝 必要な詳細ドキュメント

- **開発サーバー実装仕様書** (新規作成)
  - サーバー構成
  - ローカル開発環境セットアップ
  - マルチバージョン対応`extensions.json`の構造
  - テストデータ作成方法

#### ⚠️ 注意点

- 開発段階で既存の`extensions.json`との互換性は考慮しない
- 開発メンバー全員が新しい開発サーバーを使用する必要がある

---

### 2️⃣ 拡張機能ID形式 - バージョン付きIDへの移行と自動変換

#### 📌 確定方針

**正式リリース時にバージョン付きID形式に移行し、既存ユーザーの拡張機能を自動変換する**

#### 🎯 実装ステップ

1. **新ID形式の実装**

   - `publisher.name@version` 形式の生成・解析機能
   - ID変換ユーティリティの実装
   - ストレージキーの更新

2. **既存拡張機能の自動変換**

   - 既存のインストール済み拡張機能を検出
   - 従来形式ID → バージョン付きIDに自動変換
   - バージョン情報の推定・付与ロジック

3. **変換トリガーの実装**
   - アプリケーション起動時の自動マイグレーション
   - ユーザーデータの安全な更新
   - ロールバック機能

#### 📝 必要な詳細ドキュメント

- **拡張機能ID自動変換仕様書** (新規作成)
  - 変換トリガーのタイミング
  - 解析対象データ（ストレージ、設定ファイル等）
  - バージョン推定アルゴリズム
  - エラーハンドリング
  - ロールバック手順
  - テストシナリオ

#### ⚠️ 注意点

- 既存ユーザーのデータ破損を防ぐための十分なテストが必要
- 変換前のバックアップ機能を検討

---

### 3️⃣ マーケットプレイスAPI - 次々回リリースでの実装準備

#### 📌 確定方針

**次のリリースでは実装しないが、その次のリリースで実装するため仕様を具体化しておく**

#### 🎯 実装ステップ

1. **現リリースサイクル**

   - 仕様のドキュメント化のみ
   - 実装は行わない

2. **次回リリース**

   - 引き続き既存API使用
   - ドキュメントのレビューと改善

3. **次々回リリース**
   - 独立マーケットプレイスサーバー実装
   - インフラ構築
   - 本番デプロイ

#### 📝 必要な詳細ドキュメント

- **マーケットプレイスAPI仕様書** (新規作成)
  - API エンドポイント設計
  - リクエスト/レスポンス形式
  - 認証・認可方式
  - レート制限
  - エラーハンドリング
  - **検討事項セクション**:
    - インフラ構成の再検討（Go + S3 vs サーバーレス vs その他）
    - スケーラビリティ要件
    - コスト試算
    - 運用・監視方針
    - セキュリティ対策

#### ⚠️ 注意点

- 現時点では実装しないため、詳細ドキュメント作成が優先
- インフラ選定については複数の選択肢を検討

---

### 4️⃣ ExtensionSettings二重実装 - カスタム実装への統一

#### 📌 確定方針

**`ExtensionMarketplaceSettings`にコードを統合し、既存の`ExtensionSettings`の使用箇所を置き換える**

#### 🎯 実装ステップ

1. **コード統合**

   - `ExtensionMarketplaceSettings`を標準実装として確立
   - upstream互換コードを削除（`index.tsx`の条件分岐削除）

2. **使用箇所の置き換え**

   - `ExtensionSettings`をインポートしている全箇所を特定
   - `ExtensionMarketplaceSettings`に置き換え
   - 動作確認

3. **クリーンアップ**
   - 未使用コードの削除
   - テストケースの更新

#### 📝 必要な詳細ドキュメント

**なし** - 既存の実装ドキュメントで対応可能

#### ✅ 実装タスク

| タスク                                        | 工数  | 優先度 |
| --------------------------------------------- | ----- | ------ |
| `ExtensionSettings`使用箇所の特定（grep検索） | 0.5日 | 高     |
| `index.tsx`の条件分岐削除とコード統合         | 1日   | 高     |
| 各使用箇所の置き換え                          | 1-2日 | 高     |
| テストケース更新と動作確認                    | 1日   | 高     |
| 未使用コードの削除                            | 0.5日 | 中     |

**合計工数**: 4-5人日

#### ⚠️ 注意点

- upstreamとの互換性は放棄する（独自路線確定）
- 今後のupstreamマージは慎重に行う必要がある

---

### 5️⃣ VERSIONタブ機能 - 今後実装予定

#### 📌 確定方針

**VERSIONタブ機能を実装する**

#### 🎯 実装ステップ

1. **Phase 8計画書の確認**

   - `phase8-version-tab-implementation-plan.md`をベースに実装

2. **UI実装**

   - タブの追加
   - バージョン一覧表示
   - バージョン別アクション

3. **機能統合**
   - ExtensionDetailsへの統合
   - LayoutDetailsへの統合

#### 📝 必要な詳細ドキュメント

**既存ドキュメント活用** - `phase8-version-tab-implementation-plan.md`

#### ✅ 実装タスク

| タスク                                | 工数  | 優先度 |
| ------------------------------------- | ----- | ------ |
| Phase 8計画書のレビューと更新         | 0.5日 | 中     |
| VERSIONタブUI実装（ExtensionDetails） | 2日   | 中     |
| バージョン一覧ロジック実装            | 1日   | 中     |
| バージョン別インストール機能          | 1.5日 | 中     |
| LayoutDetailsへの適用                 | 1日   | 低     |
| テストケース作成                      | 1日   | 中     |

**合計工数**: 7人日

#### ⚠️ 注意点

- マルチバージョン対応完了後に実装すること
- ExtensionDetails実装が安定してから着手

---

### 6️⃣ LayoutDetails実装 - ExtensionDetails安定後に実装

#### 📌 確定方針

**ExtensionDetailsと同様の構造で実装する。ExtensionDetailsの実装が明確になってから着手**

#### 🎯 実装ステップ

1. **前提条件の確認**

   - ExtensionDetailsの実装が完成していること
   - 実装パターンが確立していること

2. **LayoutDetails実装**

   - ExtensionDetailsを参考に同様の構造で実装
   - レイアウト固有の機能追加

3. **統合とテスト**
   - LayoutMarketplaceSettingsへの統合
   - 動作確認

#### 📝 必要な詳細ドキュメント

**なし** - ExtensionDetailsの実装を参考にする

#### ✅ 実装タスク

| タスク                             | 工数 | 優先度 |
| ---------------------------------- | ---- | ------ |
| ExtensionDetails実装の確認と文書化 | 1日  | 高     |
| LayoutDetailsコンポーネント作成    | 2日  | 中     |
| レイアウト固有機能の実装           | 1日  | 中     |
| LayoutMarketplaceSettingsへの統合  | 1日  | 中     |
| テストケース作成                   | 1日  | 中     |

**合計工数**: 6人日

#### ⚠️ 注意点

- ExtensionDetailsの実装が安定するまで着手しない
- 実装時にExtensionDetailsとの共通化を検討

---

### 7️⃣ テスト用サムネイル画像 - 本番仕様実装とREADME解析

#### 📌 確定方針

**テストコードを削除し本番仕様に切り替え。README.mdから画像URLを自動抽出してサムネイルとして表示**

#### 🎯 実装ステップ

1. **テストコード削除**

   - `picsum.photos`の使用箇所を削除
   - 本番用のサムネイル取得ロジックに置き換え

2. **README解析機能実装**

   - README.mdをパース
   - 先頭の画像URL（`![...](url)` または `<img src="url">`）を抽出
   - サムネイルとして設定

3. **フォールバック処理**
   - 画像が見つからない場合のデフォルト画像
   - エラーハンドリング

#### 📝 必要な詳細ドキュメント

**なし** - 実装が直感的で文書化は最小限で可

#### ✅ 実装タスク

| タスク                            | 工数  | 優先度 |
| --------------------------------- | ----- | ------ |
| README.md解析ユーティリティ作成   | 1日   | 高     |
| 画像URL抽出ロジック実装           | 1日   | 高     |
| サムネイル設定ロジックの更新      | 0.5日 | 高     |
| テストコード（picsum.photos）削除 | 0.5日 | 高     |
| フォールバック画像の準備          | 0.5日 | 中     |
| エラーハンドリングとテスト        | 1日   | 高     |

**合計工数**: 4.5人日

#### ⚠️ 注意点

- 画像URLの検証（CORS、存在確認等）
- パフォーマンスへの影響を考慮（キャッシュ機構）

---

## 必要な詳細ドキュメント一覧

以下の3つの詳細ドキュメントを新規作成する必要があります:

### 📄 1. 開発サーバー実装仕様書

**ファイル名**: `development-server-specification.md`
**配置場所**: `/docs/marketplace/implementation/`
**作成優先度**: 🔴 最高（他の実装の前提条件）

**内容**:

- ローカル開発サーバーの構築手順
- マルチバージョン対応`extensions.json`の構造
  - データスキーマ
  - サンプルデータ
  - バージョン管理方法
- サーバー起動方法とポート設定
- 開発環境セットアップガイド
- トラブルシューティング

**想定工数**: 2-3日

---

### 📄 2. 拡張機能ID自動変換仕様書

**ファイル名**: `extension-id-auto-migration-specification.md`
**配置場所**: `/docs/marketplace/implementation/`
**作成優先度**: 🔴 高（正式リリース前に必須）

**内容**:

- 変換トリガーのタイミングと条件
- 解析対象データの特定
  - IndexedDB
  - LocalStorage
  - アプリケーション設定ファイル
- バージョン推定アルゴリズム
  - manifest.jsonからの取得
  - インストール履歴の参照
  - デフォルトバージョンの設定
- 変換フロー図
- エラーハンドリング戦略
- ロールバック手順
- ユーザー通知UI
- テストシナリオとテストケース

**想定工数**: 3-4日

---

### 📄 3. マーケットプレイスAPI仕様書

**ファイル名**: `marketplace-api-specification.md`
**配置場所**: `/docs/marketplace/planning/`
**作成優先度**: 🟡 中（次々回リリース用）

**内容**:

- API概要とアーキテクチャ
- エンドポイント一覧
  - `GET /extensions` - 拡張機能一覧取得
  - `GET /extensions/{id}` - 拡張機能詳細取得
  - `GET /extensions/{id}/versions` - バージョン一覧
  - `GET /layouts` - レイアウト一覧取得
  - `GET /layouts/{id}` - レイアウト詳細取得
  - `POST /extensions/{id}/download` - ダウンロード
- リクエスト/レスポンス形式（JSON スキーマ）
- 認証・認可方式
- レート制限とキャッシュ戦略
- エラーレスポンス形式
- **検討事項セクション**:
  - インフラ構成の比較検討
    - オプションA: Go + AWS S3 + EC2
    - オプションB: Node.js + Vercel/Netlify（サーバーレス）
    - オプションC: Rust + Cloudflare Workers
  - 各オプションのコスト試算
  - スケーラビリティ比較
  - 運用・監視の容易さ
  - 開発チームのスキルセットとの適合性

**想定工数**: 4-5日

---

## 実装タスクの依存関係

```
開発サーバー実装仕様書作成 (2-3日)
    ↓
    ├─→ 開発サーバー構築 (3-4日)
    │       ↓
    │   マルチバージョン対応実装 (5-7日)
    │       ↓
    │   VERSIONタブ実装 (7日)
    │
    └─→ 拡張機能ID自動変換仕様書作成 (3-4日)
            ↓
        ID変換機能実装 (4-5日)
            ↓
        自動マイグレーション実装 (3-4日)

ExtensionSettings統一 (4-5日)
    ↓
ExtensionDetails安定化 (2-3日)
    ↓
    ├─→ LayoutDetails実装 (6日)
    └─→ VERSIONタブ統合 (※上記と並行）

README解析サムネイル実装 (4.5日) - 独立タスク

マーケットプレイスAPI仕様書作成 (4-5日) - 独立タスク（低優先度）
```

---

## 推奨実装順序

### 🎯 Critical Path（クリティカルパス）

正式リリースに必須のタスクを優先順に並べた最短経路:

1. **開発サーバー実装仕様書作成** (2-3日) 🔴
2. **開発サーバー構築** (3-4日) 🔴
3. **マルチバージョン対応実装** (5-7日) 🔴
4. **拡張機能ID自動変換仕様書作成** (3-4日) 🔴
5. **ID変換機能実装** (4-5日) 🔴
6. **自動マイグレーション実装** (3-4日) 🔴

**Critical Path 合計**: 20-30日

### 📋 並行実施可能タスク

Critical Pathと並行して実施できるタスク:

- **ExtensionSettings統一** (4-5日) - 開発サーバー構築後に開始可能
- **README解析サムネイル実装** (4.5日) - いつでも開始可能
- **マーケットプレイスAPI仕様書作成** (4-5日) - いつでも開始可能

### 🔄 後続タスク

Critical Path完了後に着手するタスク:

- **VERSIONタブ実装** (7日)
- **ExtensionDetails安定化** (2-3日)
- **LayoutDetails実装** (6日)

---

## フェーズ別実装計画

### 📅 Phase 1: 基盤整備（Week 1-2）

**目標**: 開発環境とマルチバージョン対応の基盤を確立

| タスク                           | 担当 | 工数  | 週    |
| -------------------------------- | ---- | ----- | ----- |
| 開発サーバー実装仕様書作成       | -    | 2-3日 | W1    |
| 開発サーバー構築                 | -    | 3-4日 | W1-W2 |
| README解析サムネイル実装（並行） | -    | 4.5日 | W1-W2 |

**成果物**:

- ✅ 開発サーバー実装仕様書
- ✅ ローカル開発サーバー稼働
- ✅ マルチバージョン対応`extensions.json`
- ✅ README解析サムネイル機能

**Week 1-2 合計工数**: 9.5-11.5日

---

### 📅 Phase 2: マルチバージョン対応（Week 3-4）

**目標**: マルチバージョン機能の完全実装

| タスク                                  | 担当 | 工数  | 週    |
| --------------------------------------- | ---- | ----- | ----- |
| マルチバージョン対応実装                | -    | 5-7日 | W3-W4 |
| ExtensionSettings統一（並行）           | -    | 4-5日 | W3-W4 |
| マーケットプレイスAPI仕様書作成（並行） | -    | 4-5日 | W3-W4 |

**成果物**:

- ✅ マルチバージョン選択UI
- ✅ HybridExtensionLoaderの最適化
- ✅ ExtensionMarketplaceSettingsへの統一
- ✅ マーケットプレイスAPI仕様書

**Week 3-4 合計工数**: 13-17日（並行実施により短縮）

---

### 📅 Phase 3: ID変換機能（Week 5-6）

**目標**: バージョン付きIDへの移行機能実装

| タスク                       | 担当 | 工数  | 週    |
| ---------------------------- | ---- | ----- | ----- |
| 拡張機能ID自動変換仕様書作成 | -    | 3-4日 | W5    |
| ID変換機能実装               | -    | 4-5日 | W5-W6 |
| 自動マイグレーション実装     | -    | 3-4日 | W6    |

**成果物**:

- ✅ 拡張機能ID自動変換仕様書
- ✅ ID変換ユーティリティ
- ✅ 自動マイグレーション機能
- ✅ ロールバック機能

**Week 5-6 合計工数**: 10-13日

---

### 📅 Phase 4: 詳細機能実装（Week 7-9）

**目標**: VERSIONタブとLayoutDetails実装

| タスク                 | 担当 | 工数  | 週    |
| ---------------------- | ---- | ----- | ----- |
| ExtensionDetails安定化 | -    | 2-3日 | W7    |
| VERSIONタブ実装        | -    | 7日   | W7-W8 |
| LayoutDetails実装      | -    | 6日   | W8-W9 |

**成果物**:

- ✅ ExtensionDetails完成版
- ✅ VERSIONタブ機能
- ✅ LayoutDetails完成版

**Week 7-9 合計工数**: 15-16日

---

### 📅 Phase 5: 統合テストとリリース準備（Week 10）

**目標**: 全機能の統合テストと正式リリース準備

| タスク               | 担当 | 工数 | 週  |
| -------------------- | ---- | ---- | --- |
| 統合テスト           | -    | 3日  | W10 |
| パフォーマンステスト | -    | 1日  | W10 |
| ドキュメント最終更新 | -    | 1日  | W10 |
| リリースノート作成   | -    | 1日  | W10 |

**成果物**:

- ✅ 全機能統合テスト完了
- ✅ パフォーマンス最適化
- ✅ 最新ドキュメント
- ✅ リリースノート

**Week 10 合計工数**: 6日

---

## 総工数見積もりとスケジュール

### 📊 総工数

| フェーズ                      | 工数            | 期間       |
| ----------------------------- | --------------- | ---------- |
| Phase 1: 基盤整備             | 9.5-11.5日      | 2週間      |
| Phase 2: マルチバージョン対応 | 13-17日         | 2週間      |
| Phase 3: ID変換機能           | 10-13日         | 2週間      |
| Phase 4: 詳細機能実装         | 15-16日         | 3週間      |
| Phase 5: 統合テスト           | 6日             | 1週間      |
| **合計**                      | **53.5-63.5日** | **10週間** |

### 📅 スケジュール（1人フルタイム想定）

- **開始**: 2025年10月1日
- **Phase 1完了**: 2025年10月14日
- **Phase 2完了**: 2025年10月28日
- **Phase 3完了**: 2025年11月11日
- **Phase 4完了**: 2025年12月2日
- **Phase 5完了（正式リリース）**: 2025年12月9日

### ⚡ 複数人での並行開発

2人体制の場合: **約6-7週間で完了**
3人体制の場合: **約4-5週間で完了**

---

## リスク管理

### 🚨 高リスク項目

#### 1. ID自動変換機能のデータ破損リスク

**リスクレベル**: 🔴 高
**影響**: 既存ユーザーのデータ損失

**対策**:

- 変換前の自動バックアップ機能実装
- 段階的ロールアウト（ベータテスト期間設定）
- ロールバック機能の十分なテスト
- テストケースの網羅的作成

#### 2. マルチバージョン対応の複雑性

**リスクレベル**: 🟡 中
**影響**: 開発期間の延長、バグの増加

**対策**:

- 詳細な仕様書作成（開発サーバー実装仕様書）
- 段階的実装（まず基本機能、後で拡張）
- コードレビューの徹底
- 自動テストの充実

#### 3. ExtensionDetails実装の不安定性

**リスクレベル**: 🟡 中
**影響**: LayoutDetails実装の遅延

**対策**:

- ExtensionDetails安定化を最優先
- 共通コンポーネント化による再利用
- LayoutDetailsは後回しでも可（必須ではない）

---

### ✅ リスク軽減策

1. **段階的リリース**

   - ベータ版でのテストユーザー募集
   - フィードバック収集と改善

2. **十分なテスト**

   - ユニットテスト
   - 統合テスト
   - E2Eテスト
   - パフォーマンステスト

3. **ドキュメント整備**

   - 実装仕様書の詳細化
   - トラブルシューティングガイド
   - ユーザー向けマイグレーションガイド

4. **コミュニケーション**
   - 定期的な進捗報告
   - 問題の早期共有
   - チームレビュー

---

## 次のアクション

### 🎯 即座に着手すべきタスク

1. **開発サーバー実装仕様書作成** - Phase 1の起点
2. **README解析サムネイル実装** - 独立タスクで早期に完了可能
3. **ExtensionSettings統一の準備** - 使用箇所の特定

### 📋 作成すべき詳細ドキュメント（優先順）

1. 🔴 `development-server-specification.md` - 最優先
2. 🔴 `extension-id-auto-migration-specification.md` - 高優先
3. 🟡 `marketplace-api-specification.md` - 中優先（次々回リリース用）

### 🔄 定期レビューポイント

- **Week 2終了時**: Phase 1完了確認、Phase 2計画見直し
- **Week 4終了時**: Phase 2完了確認、Phase 3計画見直し
- **Week 6終了時**: Phase 3完了確認、Phase 4計画見直し
- **Week 9終了時**: Phase 4完了確認、Phase 5準備

---

## まとめ

### 📌 実装方針のポイント

1. **マルチバージョン**: 開発段階で完全移行、正式リリース時には完成状態
2. **拡張機能ID**: バージョン付きIDに移行、既存データは自動変換
3. **マーケットプレイスAPI**: 次々回リリース用に仕様を準備
4. **ExtensionSettings**: カスタム実装に統一、upstream互換性は放棄
5. **VERSIONタブ**: 実装する（Phase 4）
6. **LayoutDetails**: ExtensionDetails安定後に実装
7. **サムネイル**: README解析で自動取得、テストコード削除

### 🎯 成功の鍵

- **詳細仕様書の事前作成**: 実装前に仕様を明確化
- **段階的実装**: 一度に全てを作らず、フェーズ分割
- **十分なテスト**: 特にID変換機能のテストを重視
- **リスク管理**: 高リスク項目の早期対策

### 🚀 正式リリース時の理想状態

- ✅ 完全なマルチバージョン対応
- ✅ バージョン付きID形式
- ✅ 既存ユーザーデータの自動マイグレーション
- ✅ VERSIONタブ機能
- ✅ ExtensionDetails/LayoutDetails完成
- ✅ README解析サムネイル
- ✅ 次々回リリース用API仕様準備完了

**推定リリース日**: 2025年12月9日（10週間後）

---

**関連ドキュメント**:

- [マーケットプレイス機能仕様書](./MARKETPLACE_FEATURES.md)
- [不整合対応方針書](./INCONSISTENCIES_RESOLUTION.md)
- [マーケットプレイス目次](./INDEX.md)
